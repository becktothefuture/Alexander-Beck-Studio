<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebGL Renderer Test - Phase 2.1 Validation</title>
<style>
  html, body { 
    height: 100%; 
    margin: 0; 
    background: #0B1215;
    font-family: monospace;
    color: #fff;
  }
  #container {
    position: fixed;
    width: 100%;
    height: 100vh;
    background: #cecece;
  }
  #container canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
  #info {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0,0,0,0.8);
    padding: 20px;
    border-radius: 8px;
    z-index: 1000;
    backdrop-filter: blur(10px);
    max-width: 400px;
  }
  #info h2 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #4ECDC4;
  }
  #info .test-result {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
  }
  #info .pass { border-left: 3px solid #4CAF50; }
  #info .fail { border-left: 3px solid #F44336; }
  #info .stats {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 12px;
  }
  .toggle-btn {
    margin: 10px 0;
    padding: 10px 15px;
    background: #4ECDC4;
    color: #000;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  .toggle-btn:hover {
    background: #45B7D1;
  }
</style>
</head>
<body>

<div id="container"></div>

<div id="info">
  <h2>🚀 Phase 2.1: WebGL Renderer Test</h2>
  <div id="test-results"></div>
  <button class="toggle-btn" id="toggleRenderer">Switch to Canvas2D</button>
  <div class="stats" id="stats"></div>
</div>

<script type="importmap">
{
  "imports": {
    "pixi.js": "../node_modules/pixi.js/dist/pixi.mjs"
  }
}
</script>

<script type="module">
import * as PIXI from 'pixi.js';

// ═══════════════════════════════════════════════════════════════════════════
// PHASE 2.1: WebGL RENDERER VALIDATION TEST
// ═══════════════════════════════════════════════════════════════════════════

console.log('🎨 Starting WebGL Renderer Test...');
console.log('PixiJS Version:', PIXI.VERSION);

let currentRenderer = 'webgl';
let pixiApp = null;
let canvas2dCanvas = null;
let canvas2dCtx = null;

// Test balls data
const testBalls = [];
const ballColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DFE6E9', '#74B9FF', '#A29BFE'];

// ═══════════════════════════════════════════════════════════════════════════
// MOCK BALL CLASS (Simplified version for testing)
// ═══════════════════════════════════════════════════════════════════════════

class TestBall {
  constructor(x, y, r, color) {
    this.x = x;
    this.y = y;
    this.vx = (Math.random() * 2 - 1) * 300;
    this.vy = (Math.random() * 2 - 1) * 300;
    this.r = r;
    this.color = color;
    this.squashAmount = 0;
    this.squashNormalAngle = 0;
  }

  update(dt, width, height) {
    // Simple physics
    this.x += this.vx * dt;
    this.y += this.vy * dt;

    // Bounce off walls
    if (this.x - this.r < 0) {
      this.x = this.r;
      this.vx = -this.vx * 0.8;
    }
    if (this.x + this.r > width) {
      this.x = width - this.r;
      this.vx = -this.vx * 0.8;
    }
    if (this.y - this.r < 0) {
      this.y = this.r;
      this.vy = -this.vy * 0.8;
    }
    if (this.y + this.r > height) {
      this.y = height - this.r;
      this.vy = -this.vy * 0.8;
    }
  }

  drawCanvas2D(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.beginPath();
    ctx.arc(0, 0, this.r, 0, Math.PI * 2);
    ctx.fillStyle = this.color;
    ctx.fill();
    ctx.restore();
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// WEBGL RENDERER (PixiJS)
// ═══════════════════════════════════════════════════════════════════════════

async function initWebGL() {
  const container = document.getElementById('container');
  const rect = container.getBoundingClientRect();

  try {
    pixiApp = new PIXI.Application({
      width: rect.width,
      height: rect.height,
      resolution: window.devicePixelRatio || 1,
      autoDensity: true,
      backgroundColor: 0xCECECE,
      antialias: true,
      powerPreference: 'high-performance',
    });

    container.appendChild(pixiApp.view);

    // Create sprites for each ball
    testBalls.forEach(ball => {
      const sprite = new PIXI.Graphics();
      const colorNum = parseInt(ball.color.replace('#', ''), 16);
      sprite.beginFill(colorNum);
      sprite.drawCircle(0, 0, ball.r);
      sprite.endFill();
      sprite.x = ball.x;
      sprite.y = ball.y;
      ball.sprite = sprite;
      pixiApp.stage.addChild(sprite);
    });

    runValidationTests('webgl');
    return true;
  } catch (error) {
    console.error('❌ WebGL initialization failed:', error);
    return false;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// CANVAS 2D RENDERER
// ═══════════════════════════════════════════════════════════════════════════

function initCanvas2D() {
  const container = document.getElementById('container');
  const rect = container.getBoundingClientRect();

  canvas2dCanvas = document.createElement('canvas');
  canvas2dCanvas.width = rect.width * window.devicePixelRatio;
  canvas2dCanvas.height = rect.height * window.devicePixelRatio;
  canvas2dCanvas.style.width = rect.width + 'px';
  canvas2dCanvas.style.height = rect.height + 'px';
  
  canvas2dCtx = canvas2dCanvas.getContext('2d');
  canvas2dCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
  
  container.appendChild(canvas2dCanvas);

  runValidationTests('canvas2d');
  return true;
}

// ═══════════════════════════════════════════════════════════════════════════
// VALIDATION TESTS
// ═══════════════════════════════════════════════════════════════════════════

function runValidationTests(rendererType) {
  const results = [];

  // Test 1: Initialization
  if (rendererType === 'webgl') {
    results.push({
      name: 'WebGL Initialization',
      passed: pixiApp !== null,
      message: pixiApp ? `✅ PixiJS initialized (${pixiApp.renderer.type === PIXI.RENDERER_TYPE.WEBGL ? 'WebGL' : 'Canvas'})` : '❌ Failed to initialize'
    });

    results.push({
      name: 'WebGL Support',
      passed: pixiApp?.renderer.type === PIXI.RENDERER_TYPE.WEBGL,
      message: pixiApp?.renderer.type === PIXI.RENDERER_TYPE.WEBGL ? '✅ WebGL supported' : '⚠️  Fallback to Canvas'
    });
  } else {
    results.push({
      name: 'Canvas2D Initialization',
      passed: canvas2dCanvas !== null,
      message: canvas2dCanvas ? '✅ Canvas2D initialized' : '❌ Failed to initialize'
    });
  }

  // Test 2: Ball Count
  results.push({
    name: 'Ball Creation',
    passed: testBalls.length === 50,
    message: `✅ ${testBalls.length} balls created`
  });

  // Test 3: Rendering Test
  results.push({
    name: 'Render Test',
    passed: true,
    message: `✅ ${rendererType.toUpperCase()} rendering active`
  });

  // Display results
  displayTestResults(results);
}

function displayTestResults(results) {
  const container = document.getElementById('test-results');
  container.innerHTML = '';
  
  results.forEach(test => {
    const div = document.createElement('div');
    div.className = `test-result ${test.passed ? 'pass' : 'fail'}`;
    div.innerHTML = `<strong>${test.name}:</strong><br>${test.message}`;
    container.appendChild(div);
  });

  const passed = results.filter(r => r.passed).length;
  const total = results.length;
  console.log(`📊 Validation: ${passed}/${total} tests passed`);
}

// ═══════════════════════════════════════════════════════════════════════════
// RENDERER TOGGLE
// ═══════════════════════════════════════════════════════════════════════════

async function toggleRenderer() {
  if (currentRenderer === 'webgl' && pixiApp) {
    // Switch to Canvas2D
    pixiApp.destroy(true);
    pixiApp = null;
    currentRenderer = 'canvas2d';
    initCanvas2D();
    document.getElementById('toggleRenderer').textContent = 'Switch to WebGL';
  } else if (currentRenderer === 'canvas2d' && canvas2dCanvas) {
    // Switch to WebGL
    canvas2dCanvas.remove();
    canvas2dCanvas = null;
    canvas2dCtx = null;
    currentRenderer = 'webgl';
    await initWebGL();
    document.getElementById('toggleRenderer').textContent = 'Switch to Canvas2D';
  }
}

document.getElementById('toggleRenderer').addEventListener('click', toggleRenderer);

// ═══════════════════════════════════════════════════════════════════════════
// ANIMATION LOOP
// ═══════════════════════════════════════════════════════════════════════════

let lastTime = performance.now();
let frameCount = 0;
let fpsStartTime = performance.now();
let currentFPS = 0;

function animate() {
  const now = performance.now();
  const dt = Math.min((now - lastTime) / 1000, 0.016); // Cap at ~60fps
  lastTime = now;

  const container = document.getElementById('container');
  const rect = container.getBoundingClientRect();

  // Update balls
  testBalls.forEach(ball => ball.update(dt, rect.width, rect.height));

  // Render based on current renderer
  if (currentRenderer === 'webgl' && pixiApp) {
    // Update WebGL sprites
    testBalls.forEach(ball => {
      if (ball.sprite) {
        ball.sprite.x = ball.x;
        ball.sprite.y = ball.y;
      }
    });
  } else if (currentRenderer === 'canvas2d' && canvas2dCtx) {
    // Clear and draw Canvas2D
    canvas2dCtx.clearRect(0, 0, rect.width, rect.height);
    testBalls.forEach(ball => ball.drawCanvas2D(canvas2dCtx));
  }

  // FPS Counter
  frameCount++;
  if (now - fpsStartTime >= 1000) {
    currentFPS = frameCount;
    frameCount = 0;
    fpsStartTime = now;
    
    // Update stats
    updateStats();
  }

  requestAnimationFrame(animate);
}

function updateStats() {
  const stats = document.getElementById('stats');
  stats.innerHTML = `
    <strong>Performance Stats:</strong><br>
    FPS: ${currentFPS}<br>
    Renderer: ${currentRenderer.toUpperCase()}<br>
    Balls: ${testBalls.length}<br>
    ${pixiApp ? `Sprites: ${pixiApp.stage.children.length}<br>` : ''}
    ${pixiApp ? `Draw Calls: ~${testBalls.length}<br>` : ''}
  `;
}

// ═══════════════════════════════════════════════════════════════════════════
// INITIALIZATION
// ═══════════════════════════════════════════════════════════════════════════

async function init() {
  const container = document.getElementById('container');
  const rect = container.getBoundingClientRect();

  // Create test balls
  for (let i = 0; i < 50; i++) {
    const ball = new TestBall(
      Math.random() * rect.width,
      Math.random() * rect.height,
      15 + Math.random() * 15,
      ballColors[Math.floor(Math.random() * ballColors.length)]
    );
    testBalls.push(ball);
  }

  console.log(`✅ Created ${testBalls.length} test balls`);

  // Initialize WebGL renderer
  const success = await initWebGL();
  
  if (!success) {
    console.warn('⚠️  Falling back to Canvas2D');
    initCanvas2D();
    currentRenderer = 'canvas2d';
  }

  // Start animation loop
  animate();
  
  console.log('✅ Animation loop started');
}

// Start the test
init();

</script>

</body>
</html>

