var e=function(e){"use strict";const t={PIT:"pit",FLIES:"flies",WEIGHTLESS:"weightless",WATER:"water",VORTEX:"vortex",PING_PONG:"ping-pong",MAGNETIC:"magnetic",BUBBLES:"bubbles"},n={DPR:Math.max(1,Math.min(2,window.devicePixelRatio||1)),CANVAS_HEIGHT_VH_PIT:1.5,CANVAS_HEIGHT_VH_DEFAULT:1,OFFSCREEN_MOUSE:-1e9,MIN_DISTANCE_EPSILON:1e-6,ACCUMULATOR_RESET_THRESHOLD:3,MAX_PHYSICS_STEPS:2,SPIN_DAMP_PER_S:2,SPIN_GAIN:.25,SPIN_GAIN_TANGENT:.18,ROLL_FRICTION_PER_S:1.5,SQUASH_MAX_BASE:.2,SQUASH_DECAY_PER_S:18,WALL_REST_VEL_THRESHOLD:70,GROUND_COUPLING_PER_S:8,SLEEP_VELOCITY_THRESHOLD:5,SLEEP_ANGULAR_THRESHOLD:.05,TIME_TO_SLEEP:.5,PHYSICS_DT:1/120},a={config:{},currentMode:t.FLIES,balls:[],canvas:null,ctx:null,container:null,mouseX:n.OFFSCREEN_MOUSE,mouseY:n.OFFSCREEN_MOUSE,mouseInCanvas:!1,GE:1960,G:0,gravityScale:1,gravityMultiplier:0,gravityMultiplierPit:1.1,REST:.69,FRICTION:.006,ballMassKg:129,MASS_BASELINE_KG:129,MASS_REST_EXP:.15,MASS_GRAVITY_EXP:.35,DPR:Math.max(1,Math.min(2,window.devicePixelRatio||1)),sizeScale:1.2,sizeVariation:0,responsiveScale:1,R_MIN_BASE:6,R_MAX_BASE:24,R_MIN:6*1.2*.75,R_MAX:36,ballSoftness:20,cornerRadius:42,vortexSwirlStrength:420,vortexRadialPull:180,vortexBallCount:180,magneticBallCount:180,magneticStrength:65e3,magneticMaxVelocity:2800,magneticExplosionInterval:5,bubblesSpawnRate:8,bubblesRiseSpeed:150,bubblesWobble:40,bubblesMaxCount:150,bubblesDeflectRadius:80,pingPongBallCount:35,pingPongSpeed:800,pingPongCursorRadius:50,currentColors:["#b7bcb7","#e4e9e4","#ffffff","#00695c","#000000","#ff4013","#0d5cb6","#ffa000"],currentTemplate:"industrialTeal",fliesBallCount:60,attractionPower:5e3,orbitRadius:180,swarmSpeed:.4,fliesSeparation:15e3,weightlessCount:80,weightlessInitialSpeed:250,weightlessBounce:.97,gridColumns:40,gridBallCount:120,pulseInterval:.8,waterBallCount:300,waterDrag:.015,waterRippleSpeed:300,waterRippleStrength:18e3,waterDriftStrength:40,waterInitialVelocity:200,repelRadius:120,repelPower:274e3,repelSoft:3.4,repellerEnabled:!1,emitterTimer:0,autoDarkModeEnabled:!0,isDarkMode:!1,containerBorder:0,simulationPadding:0,getSquashMax(){return 0===this.ballSoftness?0:n.SQUASH_MAX_BASE*(this.ballSoftness/40)},getCanvasCornerRadius(){return Math.max(0,this.cornerRadius-this.simulationPadding)}};function i(){return a}function o(){a.balls.length=0}const l={industrialTeal:{label:"Industrial Teal",light:["#b7bcb7","#e4e9e4","#ffffff","#00695c","#000000","#ff4013","#0d5cb6","#ffa000"],dark:["#6b726b","#3d453d","#8a928a","#00e6c3","#d5d5d5","#ff6b47","#5b9aff","#ffb84d"]},sunsetCoral:{label:"Sunset Coral",light:["#bdbbb8","#e8e6e3","#ffffff","#ff3b3b","#000000","#00f5d4","#1e40af","#fb923c"],dark:["#716f6b","#3f3d3a","#8e8c88","#ff6b6b","#d8d8d8","#00ffe7","#6ba3ff","#ffb570"]},violetPunch:{label:"Violet Punch",light:["#b8b7c2","#e6e5ed","#ffffff","#9333ea","#000000","#dc2626","#0ea5e9","#facc15"],dark:["#6d6c7a","#3a3845","#8b8a98","#c266ff","#dad6e8","#ff5c5c","#42d4ff","#fff066"]},citrusBlast:{label:"Citrus Blast",light:["#bfbdb5","#eae8df","#ffffff","#ea580c","#000000","#e11d48","#2563eb","#059669"],dark:["#74726a","#403e38","#918f87","#ff8c4d","#dbd9d1","#ff5c7a","#6ba3ff","#00d699"]},cobaltSpark:{label:"Cobalt Spark",light:["#b5b8be","#e3e6eb","#ffffff","#1d4ed8","#000000","#ea580c","#db2777","#d97706"],dark:["#696d75","#3a3e45","#878b93","#6b9dff","#d6dae2","#ff8c5c","#ff66b3","#ffc266"]}},s=[.5,.25,.12,.06,.03,.02,.01,.01];function r(){const e=i().currentColors;if(!e||0===e.length)return console.warn("No colors available, using fallback"),"#ffffff";const t=Math.random();let n=0;for(let a=0;a<Math.min(e.length,s.length);a++)if(n+=s[a],t<=n)return e[a];return e[Math.min(e.length-1,7)]}function d(e){const t=i().currentColors;return t&&0!==t.length?t[Math.max(0,Math.min(7,Math.floor(e)))]||"#ffffff":(console.warn("No colors available, using fallback"),"#ffffff")}function c(e){const t=i();t.currentTemplate=e,t.currentColors=function(e){const t=i(),n=l[e];return n?t.isDarkMode?n.dark:n.light:l.industrialTeal.light}(e),t.cursorBallColor=t.currentColors[t.cursorBallIndex||4],function(){const e=i().balls;for(let t=0;t<e.length;t++)e[t].color=r()}(),function(e){try{const t=document.documentElement,n=(e&&e.length?e:[]).slice(0,8);for(let e=0;e<8;e++){const a=n[e]||"#ffffff";t.style.setProperty(`--ball-${e+1}`,a)}}catch(e){}}(t.currentColors),function(){const e=i().currentColors;for(let t=1;t<=8;t++){const n=document.getElementById(`color${t}`),a=document.getElementById(`color${t}Val`);n&&e[t-1]&&(n.value=e[t-1],a&&(a.textContent=e[t-1].toUpperCase()))}}()}function u(){const e=document.getElementById("colorSelect");if(!e)return;e.innerHTML="";for(const[t,n]of Object.entries(l)){const a=document.createElement("option");a.value=t,a.textContent=n.label,e.appendChild(a)}const t=i();e.value=t.currentTemplate}let m,p,h="light",g="light";function v(e,t){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t}function f(e){h=e;let t=!1;t="auto"===e?"dark"===g:"dark"===e,function(e){const t=i();t.isDarkMode=e,document.documentElement.style.colorScheme=e?"dark":"light",e?(t.container?.classList.add("dark-mode"),document.body.classList.add("dark-mode"),document.documentElement.classList.add("dark-mode")):(t.container?.classList.remove("dark-mode"),document.body.classList.remove("dark-mode"),document.documentElement.classList.remove("dark-mode")),function(e){const t=v("--chrome-bg-light","#cecece"),n=v("--chrome-bg-dark","#0a0a0a"),a=e?n:t;let i=document.querySelector('meta[name="theme-color"]');i||(i=document.createElement("meta"),i.name="theme-color",document.head.appendChild(i)),i.content=a;let o=document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]');o||(o=document.createElement("meta"),o.name="theme-color",o.media="(prefers-color-scheme: light)",document.head.appendChild(o)),o.content=t;let l=document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: dark)"]');l||(l=document.createElement("meta"),l.name="theme-color",l.media="(prefers-color-scheme: dark)",document.head.appendChild(l)),l.content=n}(e),c(t.currentTemplate),function(){const e=document.getElementById("themeAuto"),t=document.getElementById("themeLight"),n=document.getElementById("themeDark");if(!e||!t||!n)return;[e,t,n].forEach(e=>e.classList.remove("active")),"auto"===h?e.classList.add("active"):"light"===h?t.classList.add("active"):n.classList.add("active");const a=document.getElementById("themeStatus");if(a){const e=i();a.textContent="auto"===h?e.isDarkMode?"üåô Auto (Dark)":"‚òÄÔ∏è Auto (Light)":"light"===h?"‚òÄÔ∏è Light Mode":"üåô Dark Mode"}}()}(t);try{localStorage.setItem("theme-preference",e)}catch(e){}console.log(`üé® Theme set to: ${e} (rendering: ${t?"dark":"light"})`)}function b(){g=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",console.log(`üñ•Ô∏è System prefers: ${g}`);let e="light";try{e=localStorage.getItem("theme-preference")||"light"}catch(e){}f(e);const t=document.getElementById("themeAuto"),n=document.getElementById("themeLight"),a=document.getElementById("themeDark");t&&t.addEventListener("click",()=>f("auto")),n&&n.addEventListener("click",()=>f("light")),a&&a.addEventListener("click",()=>f("dark")),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{g=e.matches?"dark":"light",console.log(`üñ•Ô∏è System preference changed to: ${g}`),"auto"===h&&f("auto")}),console.log("‚úì Modern dark mode initialized")}function y(){m=document.getElementById("c"),p=m?m.getContext("2d"):null,m&&p?window.addEventListener("resize",M):console.error("Canvas not found")}function M(){if(!m)return;const e=i(),a=e.container||document.getElementById("bravia-balls"),o=a?a.clientWidth:window.innerWidth,l=a?a.clientHeight:window.innerHeight,s=e.simulationPadding||0,r=o-2*s,d=(l-2*s)*(e.currentMode===t.PIT?n.CANVAS_HEIGHT_VH_PIT:n.CANVAS_HEIGHT_VH_DEFAULT),c=n.DPR;m.width=Math.floor(r*c),m.height=Math.floor(d*c),m.style.width=r+"px",m.style.height=d+"px",function(e){const t=i();if(!t.canvasShadowEnabled)return void(e.style.filter="");const n=t.shadowOffsetX||1,a=t.shadowOffsetY||1,o=t.shadowBlur||0,l=t.shadowColor||"#000000",s=t.shadowOpacity||.29,r=t.shadow2Enabled?` drop-shadow(0 0 ${t.shadow2Blur||4}px rgba(0,0,0,${t.shadow2Opacity||.1}))`:"";e.style.filter=`drop-shadow(${n}px ${a}px ${o}px ${function(e,t){const n=e.replace("#",""),a=parseInt(n,16);return`rgba(${a>>16&255}, ${a>>8&255}, ${255&a}, ${t})`}(l,s)})${r}`}(m)}function x(){return m}function S(){return p}function w(){console.log("‚ö†Ô∏è localStorage is disabled")}function E(){clearTimeout(window.settingsSaveTimeout),window.settingsSaveTimeout=setTimeout(w,500)}const P=[131,147,165,196,220,262,294,330,392,440,523];let C={attackTime:.008,decayTime:.08,harmonicGain:.15,filterBaseFreq:2200,filterVelocityRange:800,filterQ:.7,reverbDecay:.35,reverbWetMix:.35,reverbHighDamp:.6,minGain:.12,maxGain:.45,masterGain:.7,maxConcurrentSounds:14,minTimeBetweenSounds:.015,maxPan:.3};const I={underwaterPebbles:{label:"Underwater Pebbles",description:"Dreamy, muffled, reverberant",attackTime:.008,decayTime:.08,harmonicGain:.15,filterBaseFreq:2200,filterVelocityRange:800,filterQ:.7,reverbDecay:.35,reverbWetMix:.35,masterGain:.7},glassMarbles:{label:"Glass Marbles",description:"Bright, crystalline clicks",attackTime:.003,decayTime:.05,harmonicGain:.25,filterBaseFreq:4500,filterVelocityRange:1200,filterQ:1.2,reverbDecay:.25,reverbWetMix:.2,masterGain:.6},woodenBeads:{label:"Wooden Beads",description:"Warm, organic tones",attackTime:.005,decayTime:.12,harmonicGain:.3,filterBaseFreq:1800,filterVelocityRange:600,filterQ:.5,reverbDecay:.2,reverbWetMix:.15,masterGain:.65},metalChimes:{label:"Metal Chimes",description:"Shimmering, bell-like",attackTime:.002,decayTime:.2,harmonicGain:.4,filterBaseFreq:5e3,filterVelocityRange:1500,filterQ:2,reverbDecay:.5,reverbWetMix:.45,masterGain:.5},softClouds:{label:"Soft Clouds",description:"Pillowy, ambient wash",attackTime:.02,decayTime:.15,harmonicGain:.08,filterBaseFreq:1200,filterVelocityRange:400,filterQ:.3,reverbDecay:.6,reverbWetMix:.55,masterGain:.55},crystalCave:{label:"Crystal Cave",description:"Ethereal, spacious echoes",attackTime:.004,decayTime:.1,harmonicGain:.2,filterBaseFreq:3500,filterVelocityRange:1e3,filterQ:1.5,reverbDecay:.7,reverbWetMix:.5,masterGain:.55},deepOcean:{label:"Deep Ocean",description:"Sub-bass, distant rumbles",attackTime:.015,decayTime:.18,harmonicGain:.1,filterBaseFreq:800,filterVelocityRange:300,filterQ:.4,reverbDecay:.55,reverbWetMix:.4,masterGain:.7},brightClicks:{label:"Bright Clicks",description:"Snappy, percussive hits",attackTime:.001,decayTime:.03,harmonicGain:.35,filterBaseFreq:6e3,filterVelocityRange:2e3,filterQ:.8,reverbDecay:.15,reverbWetMix:.1,masterGain:.5},muffledThuds:{label:"Muffled Thuds",description:"Heavy, dampened impacts",attackTime:.01,decayTime:.1,harmonicGain:.05,filterBaseFreq:600,filterVelocityRange:200,filterQ:.3,reverbDecay:.3,reverbWetMix:.25,masterGain:.75},digitalBlips:{label:"Digital Blips",description:"Retro, 8-bit inspired",attackTime:.001,decayTime:.04,harmonicGain:.5,filterBaseFreq:8e3,filterVelocityRange:0,filterQ:.1,reverbDecay:.1,reverbWetMix:.05,masterGain:.45}};let R="underwaterPebbles",B=null,T=null,_=null,A=null,V=null,L=null,G=!1,k=!1,F=0,N=new Map,D=!1;function q(e,t,n=.5,a=null){if(G&&k&&B&&!(D||F>=C.maxConcurrentSounds)){if(null!==a){const e=B.currentTime;if(e-(N.get(a)||0)<C.minTimeBetweenSounds)return;N.set(a,e)}if(N.size>500){const e=B.currentTime-1;for(const[t,n]of N)n<e&&N.delete(t)}!function(e,t,n){const a=B.currentTime;F++;const i=C.minGain+(C.maxGain-C.minGain)*t,o=C.filterBaseFreq+C.filterVelocityRange*t,l=B.createOscillator();l.type="sine",l.frequency.value=e;const s=B.createOscillator();s.type="sine",s.frequency.value=2*e;const r=B.createGain();r.gain.value=C.harmonicGain;const d=B.createGain(),c=B.createBiquadFilter();c.type="lowpass",c.frequency.value=o,c.Q.value=C.filterQ;const u=B.createGain();u.gain.setValueAtTime(0,a),u.gain.linearRampToValueAtTime(i,a+C.attackTime),u.gain.exponentialRampToValueAtTime(.001,a+C.attackTime+C.decayTime);const m=B.createStereoPanner();m.pan.value=2*(n-.5)*C.maxPan,l.connect(d),s.connect(r),r.connect(d),d.connect(c),c.connect(u),u.connect(m),m.connect(A);const p=1-.5*t,h=B.createGain();h.gain.value=p,m.connect(h),h.connect(V);const g=C.attackTime+C.decayTime+.05;l.start(a),s.start(a),l.stop(a+g),s.stop(a+g),l.onended=()=>{F=Math.max(0,F-1);try{l.disconnect(),s.disconnect(),r.disconnect(),d.disconnect(),c.disconnect(),u.disconnect(),m.disconnect(),h.disconnect()}catch(e){}}}(function(e){const t=(1-Math.max(0,Math.min(1,(e-8)/47)))*(P.length-1),n=1.5*(Math.random()-.5),a=Math.max(0,Math.min(P.length-1,Math.round(t+n))),i=1+.06*(Math.random()-.5);return P[a]*i}(e),Math.max(0,Math.min(1,t)),n)}}function z(){return{isUnlocked:k,isEnabled:G,activeSounds:F}}function O(e){for(const[t,n]of Object.entries(e))t in C&&(C[t]=n);V&&A&&"reverbWetMix"in e&&(V.gain.value=C.reverbWetMix,A.gain.value=1-C.reverbWetMix),T&&"masterGain"in e&&(T.gain.value=C.masterGain)}function W(){return R}let H=0;class X{constructor(e,t,n,a){const o=i();this.x=e,this.y=t,this.vx=200*(2*Math.random()-1),this.vy=200*-Math.random(),this.r=n,this.rBase=n,this.m=o.ballMassKg,this.color=a,this.t=0,this.age=0,this.driftAx=0,this.driftTime=0,this.omega=0,this.squash=1,this.squashDirX=1,this.squashDirY=0,this.theta=0,this.squashAmount=0,this.squashNormalAngle=0,this.alpha=1,this.isSleeping=!1,this.sleepTimer=0,this._soundId="ball-"+H++}step(e,a){const o=i(),{currentMode:l,G:s,gravityScale:r,FRICTION:d,MASS_BASELINE_KG:c}=o;if(this.t+=e,this.age+=e,this.isSleeping&&l===t.PIT){const e=o.mouseX,t=o.mouseY,n=(o.repelRadius||710)*o.DPR*1.2,a=this.x-e,i=this.y-t;a*a+i*i<n*n&&this.wake()}if(this.isSleeping)return;l!==t.WEIGHTLESS&&(this.vy+=s*r*e);const u=Math.max(.25,this.m/c),m=l===t.WEIGHTLESS?1e-4:d,p=Math.max(0,1-m/u);this.vx*=p,this.vy*=p,0!==this.driftAx&&this.age<this.driftTime?this.vx+=this.driftAx*e/u:0!==this.driftAx&&(this.driftAx=0),a&&a(this,e),this.x+=this.vx*e,this.y+=this.vy*e;const h=Math.max(0,1-n.SPIN_DAMP_PER_S*e);this.omega*=h,this.theta+=this.omega*e;const g=Math.min(1,n.SQUASH_DECAY_PER_S*e);this.squashAmount+=(0-this.squashAmount)*g,this.squash=1-this.squashAmount,l===t.PIT&&this.updateSleepState(e,o)}updateSleepState(e,t){const a=Math.sqrt(this.vx*this.vx+this.vy*this.vy),i=Math.abs(this.omega),o=t.canvas;o&&this.y+this.r>=o.height-1&&a<n.SLEEP_VELOCITY_THRESHOLD&&i<n.SLEEP_ANGULAR_THRESHOLD?(this.sleepTimer+=e,this.sleepTimer>=n.TIME_TO_SLEEP&&(this.vx=0,this.vy=0,this.omega=0,this.isSleeping=!0)):this.sleepTimer=0}wake(){this.isSleeping=!1,this.sleepTimer=0}walls(e,a,o,l){const s=i(),{REST:r,MASS_BASELINE_KG:d,MASS_REST_EXP:c,currentMode:u,DPR:m}=s,p=void 0!==l?l:r,h=u===t.PIT?a/3:0,g=(s.getCanvasCornerRadius()||100)*(m||1);let v=!1;const f=[{cx:g,cy:h+g},{cx:e-g,cy:h+g},{cx:g,cy:a-g},{cx:e-g,cy:a-g}];for(let t=0;t<f.length;t++){const n=f[t],i=t%2==0?this.x<g:this.x>e-g,o=t<2?this.y<h+g:this.y>a-g;if(i&&o){const e=this.x-n.cx,t=this.y-n.cy,a=Math.sqrt(e*e+t*t),i=g-this.r;if(a>i&&i>0){v=!0;const n=a-i,o=e/a,l=t/a;this.x-=o*n,this.y-=l*n;const s=this.vx*o+this.vy*l;s>0&&(this.vx-=(1+p)*s*o,this.vy-=(1+p)*s*l)}}}const b=e-0,y=h+0,M=a-0;if(this.y+this.r>M){v=!0,this.y=M-this.r;const t=this.vy,a=this.vx-this.omega*this.r,i=Math.max(.25,this.m/d);this.omega+=a/this.r*n.SPIN_GAIN/i;const l=Math.max(0,1-n.ROLL_FRICTION_PER_S*o/i);this.vx*=l;const r=Math.abs(t)<n.WALL_REST_VEL_THRESHOLD?0:p;this.vy=-this.vy*(r*Math.pow(d/this.m,c));const u=Math.min(1,Math.abs(t)/(90*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*u),this.squashNormalAngle=-Math.PI/2;const m=this.vx/this.r;this.omega+=(m-this.omega)*Math.min(1,n.GROUND_COUPLING_PER_S*o),u>.08&&q(this.r,.7*u,this.x/e,this._soundId)}if(this.y-this.r<y){v=!0,this.y=y+this.r,this.vy=-this.vy*p;const e=Math.min(1,Math.abs(this.vy)/(90*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*e),this.squashNormalAngle=Math.PI/2}if(this.x+this.r>b){v=!0,this.x=b-this.r;const e=this.vx,t=this.vy-this.omega*this.r,a=Math.max(.25,this.m/d);this.omega+=t/this.r*(.5*n.SPIN_GAIN)/a,this.vx=-this.vx*(r*Math.pow(d/this.m,c));const i=Math.min(1,Math.abs(e)/(70*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*i),this.squashNormalAngle=Math.PI,i>.08&&q(this.r,.6*i,1,this._soundId)}if(this.x-this.r<0){v=!0,this.x=0+this.r;const e=this.vx,t=this.vy-this.omega*this.r,a=Math.max(.25,this.m/d);this.omega+=t/this.r*(.5*n.SPIN_GAIN)/a,this.vx=-this.vx*(r*Math.pow(d/this.m,c));const i=Math.min(1,Math.abs(e)/(70*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*i),this.squashNormalAngle=0,i>.08&&q(this.r,.6*i,0,this._soundId)}v&&this.isSleeping&&this.wake()}draw(e){if(e.save(),e.translate(this.x,this.y),e.rotate(this.theta),this.squashAmount>.001){const t=1-.3*this.squashAmount,n=1+.3*this.squashAmount;e.rotate(this.squashNormalAngle),e.scale(t,n),e.rotate(-this.squashNormalAngle)}e.beginPath(),e.arc(0,0,this.r,0,2*Math.PI),e.fillStyle=this.color,e.globalAlpha=this.alpha,e.fill(),e.globalAlpha=1,e.restore()}}function $(e,t,n){n||(n=r());const a=i(),o=(a.R_MIN+a.R_MAX)/2;let l;if(0===a.sizeVariation)l=o;else{const e=.1*o;d=o+e,l=(s=Math.max(1,o-e))+Math.random()*(d-s)}var s,d;const c=new X(e,t,l,n),u=e<.5*a.canvas.width?1:-1,m=(g=l/(.5*(a.R_MIN+a.R_MAX)),Math.max(.6,Math.min(1.4,g))),p=140*m,h=180*m;var g;return c.vx=u*(p+Math.random()*h),c.vy=120*-Math.random(),c.driftAx=u*(360+420*Math.random())*m,c.driftTime=.22+.28*Math.random(),a.balls.push(c),c}function U(){const e=i();o();const t=.5*e.canvas.width,n=.5*e.canvas.height,a=150*e.DPR;for(let e=0;e<8;e++){const i=Math.random()*Math.PI*2,o=Math.random()*a,l=$(t+Math.cos(i)*o,n+Math.sin(i)*o,d(e)),s=.5+.5*Math.random(),r=Math.random()*Math.PI*2,c=300*s;l.vx=Math.cos(r)*c,l.vy=Math.sin(r)*c,l.driftAx=0,l.driftTime=0}for(let e=8;e<60;e++){const e=Math.random()*Math.PI*2,i=Math.random()*a,o=$(t+Math.cos(e)*i,n+Math.sin(e)*i),l=.5+.5*Math.random(),s=Math.random()*Math.PI*2,r=300*l;o.vx=Math.cos(s)*r,o.vy=Math.sin(s)*r,o.driftAx=0,o.driftTime=0}}function Y(e,t){const n=i(),a=-1e9===n.mouseX?.5*n.canvas.width:n.mouseX,o=-1e9===n.mouseY?.5*n.canvas.height:n.mouseY,l=a-e.x,s=o-e.y,r=Math.sqrt(l*l+s*s+1),d=l/r,c=s/r;e.vx+=4e3*d*t,e.vy+=4e3*c*t;const u=120*n.DPR;let m=0,p=0,h=0;for(let t=0;t<n.balls.length;t++){const a=n.balls[t];if(a===e)continue;const i=e.x-a.x,o=e.y-a.y,l=i*i+o*o;if(l<u*u&&l>0){const e=Math.sqrt(l),t=1-e/u;m+=i/e*t,p+=o/e*t,h++}}if(h>0){const n=15e3;e.vx+=m/h*n*t,e.vy+=p/h*n*t}e.vx+=1e3*(Math.random()-.5)*t,e.vy+=1e3*(Math.random()-.5)*t}var Q=Object.freeze({__proto__:null,applyFliesForces:Y,initializeFlies:U});function j(e,t){const n=i(),a=n.repelPower,o=n.repelRadius,l=n.mouseX,s=n.mouseY;if(!n.repellerEnabled||a<=0||o<=0)return;const r=o*n.DPR,d=e.x-l,c=e.y-s,u=d*d+c*c;if(u>r*r)return;const m=Math.max(Math.sqrt(u),1e-4),p=d/m,h=c/m,g=Math.max(0,1-m/r),v=20*a*Math.pow(g,n.repelSoft||3.4),f=Math.max(.25,e.m/n.MASS_BASELINE_KG);e.vx+=p*v*t/f,e.vy+=h*v*t/f}function K(){const e=i();o();const t=e.weightlessCount,n=e.canvas.width,a=e.canvas.height,l=40*e.DPR;for(let i=0;i<8&&i<t;i++){const t=$(l+Math.random()*(n-2*l),l+Math.random()*(a-2*l),d(i)),o=Math.random()*Math.PI*2,s=e.weightlessInitialSpeed*(.7+.3*Math.random());t.vx=Math.cos(o)*s,t.vy=Math.sin(o)*s,t.driftAx=0,t.driftTime=0}for(let i=8;i<t;i++){const t=$(l+Math.random()*(n-2*l),l+Math.random()*(a-2*l)),i=Math.random()*Math.PI*2,o=e.weightlessInitialSpeed*(.7+.3*Math.random());t.vx=Math.cos(i)*o,t.vy=Math.sin(i)*o,t.driftAx=0,t.driftTime=0}}var Z=Object.freeze({__proto__:null,initializeWeightless:K});const J=[];function ee(){const e=i();o(),J.length=0;const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=e.waterBallCount||100;for(let t=0;t<8&&t<l;t++){const i=Math.random()*n,o=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=d(t),r=new X(i,o,l,s),c=e.waterInitialVelocity||120;r.vx=(Math.random()-.5)*c,r.vy=(Math.random()-.5)*c,e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,i=Math.random()*a,o=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new X(t,i,o,l),d=e.waterInitialVelocity||120;s.vx=(Math.random()-.5)*d,s.vy=(Math.random()-.5)*d,e.balls.push(s)}}function te(e,t){const n=i(),a=n.waterDrag||.015;e.vx*=1-a,e.vy*=1-a,e.omega*=1-.5*a;for(let n=0;n<J.length;n++){const a=J[n],i=e.x-a.x,o=e.y-a.y,l=Math.sqrt(i*i+o*o),s=40,r=a.radius-s,d=a.radius+s;if(l>r&&l<d){const n=Math.abs(l-a.radius),r=a.strength*(1-n/s);if(l>.1){const n=i/l,a=o/l;e.vx+=n*r*t,e.vy+=a*r*t}}}const o=n.waterDriftStrength||25;e.vx+=Math.sin(.5*e.t+.01*e.x)*o*t,e.vy+=Math.cos(.7*e.t+.01*e.y)*o*t}function ne(e){const t=i().waterRippleSpeed||300;for(let n=J.length-1;n>=0;n--){const a=J[n];a.radius+=t*e,a.age+=e,a.strength*=.96,(a.age>3||a.strength<10)&&J.splice(n,1)}}function ae(e,t,n=1){const a=(i().waterRippleStrength||15e3)*Math.min(n,5);J.push({x:e,y:t,radius:0,strength:a,age:0})}var ie=Object.freeze({__proto__:null,applyWaterForces:te,createWaterRipple:ae,initializeWater:ee,updateWaterRipples:ne});function oe(){const e=i();o();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.vortexBallCount||180,e.maxBalls||300);for(let t=0;t<8&&t<l;t++){const i=Math.random()*n,o=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=d(t),r=new X(i,o,l,s);r.vx=80*(Math.random()-.5),r.vy=80*(Math.random()-.5),e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,i=Math.random()*a,o=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new X(t,i,o,l);s.vx=80*(Math.random()-.5),s.vy=80*(Math.random()-.5),e.balls.push(s)}}function le(e,n){const a=i();if(a.currentMode!==t.VORTEX)return;const o=a.mouseX,l=a.mouseY;if(!a.mouseInCanvas)return;const s=a.vortexSwirlStrength||420,r=a.vortexRadialPull||180,d=e.x-o,c=e.y-l,u=d*d+c*c,m=Math.max(8,Math.sqrt(u)),p=1/(1+.0015*m),h=d/m,g=c/m,v=-g,f=h,b=s*p;e.vx+=v*b*n,e.vy+=f*b*n;const y=r*p;e.vx-=h*y*n,e.vy-=g*y*n,e.vx*=.995,e.vy*=.995}var se=Object.freeze({__proto__:null,applyVortexForces:le,initializeVortex:oe});function re(){const e=i();o();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.pingPongBallCount||80,e.maxBalls||300),s=e.pingPongSpeed||400;for(let t=0;t<8&&t<l;t++){const i=Math.random()*n,o=.15*a+Math.random()*a*.7,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),r=d(t),c=new X(i,o,l,r),u=Math.random()>.5?1:-1;c.vx=u*(.8*s+Math.random()*s*.4),c.vy=0,c.isPingPong=!0,e.balls.push(c)}for(let t=8;t<l;t++){const t=Math.random()*n,i=.15*a+Math.random()*a*.7,o=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),d=new X(t,i,o,l),c=Math.random()>.5?1:-1;d.vx=c*(.8*s+Math.random()*s*.4),d.vy=0,d.isPingPong=!0,e.balls.push(d)}}function de(e,n){const a=i();if(a.currentMode!==t.PING_PONG)return;if(!e.isPingPong)return;if(a.mouseInCanvas){const t=(a.pingPongCursorRadius||100)*a.DPR,n=a.mouseX,i=a.mouseY,o=e.x-n,l=e.y-i,s=Math.sqrt(o*o+l*l),r=t+e.r;if(s<r&&s>.1){const t=r-s,n=o/s,a=l/s;e.x+=n*t*1.1,e.y+=a*t*1.1;const i=e.vx*n+e.vy*a;i<0&&(e.vx-=2*i*n,e.vy-=2*i*a,e.omega+=.02*i)}}const o=a.pingPongSpeed||400;if(Math.abs(e.vx)<.9*o){const t=e.vx>=0?1:-1;e.vx=t*o}e.vy*=.995}var ce=Object.freeze({__proto__:null,applyPingPongForces:de,initializePingPong:re});function ue(){const e=i();o();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.magneticBallCount||180,e.maxBalls||300);for(let t=0;t<8&&t<l;t++){const i=Math.random()*n,o=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=d(t),r=new X(i,o,l,s);r.vx=100*(Math.random()-.5),r.vy=100*(Math.random()-.5),r.charge=Math.random()>.5?1:-1,r.baseAlpha=1,e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,i=Math.random()*a,o=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new X(t,i,o,l);s.vx=100*(Math.random()-.5),s.vy=100*(Math.random()-.5),s.charge=Math.random()>.5?1:-1,s.baseAlpha=1,e.balls.push(s)}}function me(e,n){const a=i();if(a.currentMode!==t.MAGNETIC)return;if(!a.mouseInCanvas)return;const o=a.mouseX,l=a.mouseY,s=o-e.x,r=l-e.y,d=Math.max(30,Math.sqrt(s*s+r*r)),c=(a.magneticStrength||65e3)/(d*d)*1e3,u=s/d,m=r/d,p=e.charge||1;e.vx+=u*c*p*n,e.vy+=m*c*p*n;const h=a.magneticMaxVelocity||2800,g=Math.sqrt(e.vx*e.vx+e.vy*e.vy);g>h&&(e.vx=e.vx/g*h,e.vy=e.vy/g*h),e.vx*=.998,e.vy*=.998}var pe=Object.freeze({__proto__:null,applyMagneticForces:me,initializeMagnetic:ue});function he(e,t,n,a=!1){const o=i(),l=.5*o.R_MIN,s=.8*o.R_MAX,r=l+Math.random()*(s-l),d=new X(e,t,a?r:.1,n);return d.isBubble=!0,d.baseRadius=r,d.targetRadius=r,d.wobblePhase=Math.random()*Math.PI*2,d.wobbleFreq=2+3*Math.random(),d.vx=20*(Math.random()-.5),d.vy=-50-50*Math.random(),d.spawning=!a,d.spawnProgress=a?1:0,d.dissipating=!1,d.dissipateProgress=0,d.alpha=1,o.balls.push(d),d}function ge(e){const t=i(),n=t.canvas;if(!n)return;const a=n.width,o=n.height;e.x=Math.random()*a,e.y=o+20+30*Math.random(),e.vx=20*(Math.random()-.5),e.vy=-50-50*Math.random(),e.wobblePhase=Math.random()*Math.PI*2,e.wobbleFreq=2+3*Math.random(),e.c=r();const l=.5*t.R_MIN,s=.8*t.R_MAX;e.targetRadius=l+Math.random()*(s-l),e.baseRadius=e.targetRadius,e.r=.1,e.spawning=!0,e.spawnProgress=0,e.dissipating=!1,e.dissipateProgress=0,e.alpha=1}function ve(e,n){const a=i();if(a.currentMode!==t.BUBBLES)return;if(!e.isBubble)return;const o=a.canvas;if(!o)return;if(e.spawning){e.spawnProgress+=3*n;const t=1-Math.pow(1-Math.min(1,e.spawnProgress),3);e.r=e.targetRadius*t,e.rBase=e.r,e.spawnProgress>=1&&(e.spawning=!1,e.r=e.targetRadius,e.rBase=e.targetRadius)}if(e.dissipating){e.dissipateProgress+=3*n;const t=Math.pow(e.dissipateProgress,2);return e.r=e.targetRadius*Math.max(0,1-t),e.rBase=e.r,e.alpha=Math.max(0,1-.5*t),e.vy*=.92,e.vx*=.92,void(e.dissipateProgress>=1&&ge(e))}const l=a.bubblesRiseSpeed||150,s=.01*(a.bubblesWobble||40),r=l*a.DPR;e.vy-=r*n,e.wobblePhase+=e.wobbleFreq*n;const d=Math.sin(e.wobblePhase)*s*100;if(e.vx+=d*n,e.vx*=.92,e.vy*=.96,a.mouseInCanvas){const t=e.x-a.mouseX,i=e.y-a.mouseY,o=Math.sqrt(t*t+i*i),l=(a.bubblesDeflectRadius||80)*a.DPR;if(o<l&&o>1){const a=300*(1-o/l),s=t/o,r=i/o;e.vx+=s*a*n,e.vy+=r*a*n}}const c=2*e.targetRadius;e.y<c&&!e.dissipating&&!e.spawning&&(e.dissipating=!0,e.dissipateProgress=0),(e.x<4*-e.r||e.x>o.width+4*e.r)&&ge(e)}function fe(e){const n=i();if(function(e){a.currentMode=e}(e),console.log(`Switching to mode: ${e}`),function(e){const t=document.getElementById("announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},10))}(`Switched to ${{pit:"Ball Pit",flies:"Flies to Light",weightless:"Zero Gravity",water:"Water Swimming",vortex:"Vortex Sheets","ping-pong":"Ping Pong",magnetic:"Magnetic",bubbles:"Carbonated Bubbles"}[e]||e} mode`),n.container){const a=n.container.classList.contains("dark-mode");n.container.className="",e===t.PIT&&n.container.classList.add("mode-pit"),(a||n.isDarkMode)&&n.container.classList.add("dark-mode")}M(),e===t.PIT?(n.gravityMultiplier=n.gravityMultiplierPit,n.G=n.GE*n.gravityMultiplier,n.repellerEnabled=!0,function(){const e=i();o(),e.canvas.width;const t=e.DPR,n=e.container||document.getElementById("bravia-balls"),a=(n?n.clientHeight:e.canvas.clientHeight/1.5)-2*(e.simulationPadding||0),l=-.5*a*t,s=l+.5*a*t,r=1*e.canvas.clientWidth,c=.5*e.canvas.clientWidth-r/2;for(let e=0;e<8;e++){const n=$((c+Math.random()*r)*t,l+Math.random()*(s-l),d(e));n.vx=100*(Math.random()-.5),n.vy=50*Math.random(),n.driftAx=0,n.driftTime=0}for(let e=8;e<300;e++){const e=$((c+Math.random()*r)*t,l+Math.random()*(s-l));e.vx=100*(Math.random()-.5),e.vy=50*Math.random(),e.driftAx=0,e.driftTime=0}}()):e===t.FLIES?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,U()):e===t.WEIGHTLESS?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,K()):e===t.WATER?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,ee()):e===t.VORTEX?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,oe()):e===t.PING_PONG?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,re()):e===t.MAGNETIC?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,ue()):e===t.BUBBLES&&(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=i();e.balls.length=0;const t=e.canvas;if(!t)return;const n=t.width,a=t.height,o=e.bubblesMaxCount||150;for(let e=0;e<8&&e<o;e++)he(Math.random()*n,.3*a+Math.random()*a*.6,d(e),!0);for(let e=8;e<o;e++)he(Math.random()*n,.3*a+Math.random()*a*.6,r(),!0)}()),console.log(`Mode ${e} initialized with ${n.balls.length} balls`)}function be(){const e=i();return e.currentMode===t.FLIES?Y:e.currentMode===t.PIT?j:e.currentMode===t.WATER?te:e.currentMode===t.VORTEX?le:e.currentMode===t.PING_PONG?de:e.currentMode===t.MAGNETIC?me:e.currentMode===t.BUBBLES?ve:null}var ye=Object.freeze({__proto__:null,MODES:t,getForceApplicator:be,setMode:fe});function Me(e,t){const n=document.getElementById(e);n&&n.addEventListener("input",()=>t(n))}function xe(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}function Se(){const e=i();document.querySelectorAll(".mode-button").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.getAttribute("data-mode");console.log("Mode button clicked:",n),fe(n),we(n)})}),Me("sizeSliderGlobal",t=>{e.sizeScale=parseFloat(t.value),xe("sizeValGlobal",e.sizeScale.toFixed(2));const n=(e.R_MIN_BASE+e.R_MAX_BASE)/2;e.R_MIN=n*e.sizeScale*.75,e.R_MAX=n*e.sizeScale*1.25;const a=(e.R_MIN+e.R_MAX)/2;for(let t=0;t<e.balls.length;t++)e.balls[t].r=a,e.balls[t].rBase=a;E()}),Me("ballSoftnessSliderGlobal",t=>{e.ballSoftness=parseInt(t.value,10),xe("ballSoftnessValGlobal",String(e.ballSoftness)),E()}),Me("containerBorderSlider",t=>{e.containerBorder=parseInt(t.value,10),xe("containerBorderVal",String(e.containerBorder)),Je(),M(),E()}),Me("simulationPaddingSlider",t=>{e.simulationPadding=parseInt(t.value,10),xe("simulationPaddingVal",String(e.simulationPadding)),Je(),M(),E()}),Me("gravityPitSlider",t=>{e.gravityMultiplierPit=parseFloat(t.value),xe("gravityPitVal",e.gravityMultiplierPit.toFixed(2)),"pit"===e.currentMode&&(e.G=e.GE*e.gravityMultiplierPit),E()}),Me("weightPitSlider",t=>{e.ballMassKg=parseFloat(t.value),xe("weightPitVal",e.ballMassKg.toFixed(0));for(let t=0;t<e.balls.length;t++)e.balls[t].m=e.ballMassKg;E()}),Me("restitutionSlider",t=>{e.REST=parseFloat(t.value),xe("restitutionVal",e.REST.toFixed(2)),E()}),Me("frictionSlider",t=>{e.FRICTION=parseFloat(t.value),xe("frictionVal",e.FRICTION.toFixed(4)),E()});const t=document.getElementById("repellerEnabledPit");t&&t.addEventListener("change",()=>{e.repellerEnabled=!!t.checked,E()}),Me("repelSizeSlider",t=>{e.repelRadius=parseFloat(t.value),xe("repelSizeVal",e.repelRadius.toFixed(0)),E()}),Me("repelPowerSlider",t=>{const n=parseFloat(t.value),a=Math.max(0,Math.min(1e4,n))/1e4,i=12e3*Math.pow(2,12*(a-.5))*2;e.repelPower=i,xe("repelPowerVal",Math.round(e.repelPower).toString()),E()}),Me("repelSoftSlider",t=>{e.repelSoft=parseFloat(t.value),xe("repelSoftVal",e.repelSoft.toFixed(1)),E()}),Me("fliesBallCountSlider",t=>{e.fliesBallCount=parseInt(t.value,10),xe("fliesBallCountVal",String(e.fliesBallCount)),"flies"===e.currentMode&&Promise.resolve().then(function(){return Q}).then(({initializeFlies:e})=>{e()})}),Me("attractPowerSlider",t=>{e.attractionPower=parseFloat(t.value),xe("attractPowerVal",Math.round(e.attractionPower).toString())}),Me("swarmSpeedSlider",t=>{e.swarmSpeed=parseFloat(t.value),xe("swarmSpeedVal",e.swarmSpeed.toFixed(1))}),Me("fliesSeparationSlider",t=>{e.fliesSeparation=parseFloat(t.value),xe("fliesSeparationVal",Math.round(e.fliesSeparation).toString())}),Me("weightlessCountSlider",t=>{e.weightlessBallCount=parseInt(t.value,10),xe("weightlessCountVal",String(e.weightlessBallCount)),"weightless"===e.currentMode&&Promise.resolve().then(function(){return Z}).then(({initializeWeightless:e})=>{e()})}),Me("weightlessSpeedSlider",t=>{e.weightlessInitialSpeed=parseFloat(t.value),xe("weightlessSpeedVal",e.weightlessInitialSpeed.toFixed(0)),"weightless"===e.currentMode&&Promise.resolve().then(function(){return Z}).then(({initializeWeightless:e})=>{e()})}),Me("weightlessBounceSlider",t=>{e.weightlessBounce=parseFloat(t.value),xe("weightlessBounceVal",e.weightlessBounce.toFixed(2))}),Me("waterBallCountSlider",t=>{e.waterBallCount=parseInt(t.value,10),xe("waterBallCountVal",String(e.waterBallCount)),"water"===e.currentMode&&Promise.resolve().then(function(){return ie}).then(({initializeWater:e})=>{e()}),E()}),Me("waterRippleStrengthSlider",t=>{e.waterRippleStrength=parseFloat(t.value),xe("waterRippleStrengthVal",e.waterRippleStrength.toFixed(0)),E()}),Me("waterMotionSlider",t=>{const n=parseFloat(t.value);e.waterDriftStrength=n,e.waterInitialVelocity=5*n,xe("waterMotionVal",n.toFixed(0)),"water"===e.currentMode&&Promise.resolve().then(function(){return ie}).then(({initializeWater:e})=>{e()}),E()}),Me("vortexBallCountSlider",t=>{e.vortexBallCount=parseInt(t.value,10),xe("vortexBallCountVal",String(e.vortexBallCount)),"vortex"===e.currentMode&&Promise.resolve().then(function(){return se}).then(({initializeVortex:e})=>{e()})}),Me("vortexSwirlSlider",t=>{e.vortexSwirlStrength=parseFloat(t.value),xe("vortexSwirlVal",e.vortexSwirlStrength.toFixed(0))}),Me("vortexPullSlider",t=>{e.vortexRadialPull=parseFloat(t.value),xe("vortexPullVal",e.vortexRadialPull.toFixed(0))}),Me("pingPongBallCountSlider",t=>{e.pingPongBallCount=parseInt(t.value,10),xe("pingPongBallCountVal",String(e.pingPongBallCount)),"ping-pong"===e.currentMode&&Promise.resolve().then(function(){return ce}).then(({initializePingPong:e})=>{e()})}),Me("pingPongSpeedSlider",t=>{e.pingPongSpeed=parseFloat(t.value),xe("pingPongSpeedVal",e.pingPongSpeed.toFixed(0)),"ping-pong"===e.currentMode&&Promise.resolve().then(function(){return ce}).then(({initializePingPong:e})=>{e()})}),Me("pingPongCursorSlider",t=>{e.pingPongCursorRadius=parseFloat(t.value),xe("pingPongCursorVal",e.pingPongCursorRadius.toFixed(0))}),Me("magneticBallCountSlider",t=>{e.magneticBallCount=parseInt(t.value,10),xe("magneticBallCountVal",String(e.magneticBallCount)),"magnetic"===e.currentMode&&Promise.resolve().then(function(){return pe}).then(({initializeMagnetic:e})=>{e()})}),Me("magneticStrengthSlider",t=>{e.magneticStrength=parseFloat(t.value),xe("magneticStrengthVal",e.magneticStrength.toFixed(0))}),Me("magneticVelocitySlider",t=>{e.magneticMaxVelocity=parseFloat(t.value),xe("magneticVelocityVal",e.magneticMaxVelocity.toFixed(0))}),Me("magneticIntervalSlider",t=>{e.magneticExplosionInterval=parseInt(t.value,10),xe("magneticIntervalVal",String(e.magneticExplosionInterval))}),Me("bubblesRateSlider",t=>{e.bubblesSpawnRate=parseInt(t.value,10),xe("bubblesRateVal",String(e.bubblesSpawnRate))}),Me("bubblesSpeedSlider",t=>{e.bubblesRiseSpeed=parseFloat(t.value),xe("bubblesSpeedVal",e.bubblesRiseSpeed.toFixed(0))}),Me("bubblesWobbleSlider",t=>{e.bubblesWobble=parseFloat(t.value),xe("bubblesWobbleVal",e.bubblesWobble.toFixed(0))}),Me("bubblesMaxSlider",t=>{e.bubblesMaxCount=parseInt(t.value,10),xe("bubblesMaxVal",String(e.bubblesMaxCount))}),Me("bubblesDeflectSlider",t=>{e.bubblesDeflectRadius=parseFloat(t.value),xe("bubblesDeflectVal",e.bubblesDeflectRadius.toFixed(0))}),u();const n=document.getElementById("colorSelect");n&&n.addEventListener("change",()=>{c(n.value),E()})}function we(e){document.querySelectorAll(".mode-button").forEach(t=>{const n=t.getAttribute("data-mode")===e;t.classList.toggle("active",n)}),document.querySelectorAll(".mode-controls").forEach(e=>e.classList.remove("active"));const t=e+"Controls",n=document.getElementById(t);n&&n.classList.add("active");const a=document.getElementById("announcer");if(a){const t={pit:"Ball Pit",flies:"Flies to Light",weightless:"Zero-G",water:"Water Swimming",vortex:"Vortex Sheets","ping-pong":"Ping Pong",magnetic:"Magnetic",bubbles:"Carbonated Bubbles"};a.textContent=`Switched to ${t[e]||e} mode`}}var Ee=Object.freeze({__proto__:null,setupControls:Se,updateModeButtonsUI:we});let Pe=0,Ce=0,Ie=0,Re=0,Be=0;const Te=[t.PIT,t.FLIES,t.WEIGHTLESS,t.WATER,t.VORTEX,t.PING_PONG,t.MAGNETIC,t.BUBBLES];function _e(){const e=i().currentMode,t=Te.indexOf(e),n=Te[(t+1)%Te.length]||Te[0];Promise.resolve().then(function(){return ye}).then(({setMode:e})=>{e(n)}),Promise.resolve().then(function(){return Ee}).then(({updateModeButtonsUI:e})=>{e(n)})}let Ae=0;const Ve=new Map;function Le(e=10){const t=i(),a=t.balls,o=function(){const e=i(),t=e.balls,a=e.canvas,o=e.R_MAX,l=t.length;if(l<2)return[];const s=Math.max(1,2*o),r=Math.ceil(a.width/s)+1;Ve.clear();for(let e=0;e<l;e++){const n=t[e],a=n.x/s|0,i=(n.y/s|0)*r+a;let o=Ve.get(i);o||(o=[],Ve.set(i,o)),o.push(e)}const d=[];for(const[e,a]of Ve){const i=e/r|0,o=e%r;for(let e=-1;e<=1;e++)for(let l=-1;l<=1;l++){const s=(i+e)*r+(o+l),c=Ve.get(s);if(c)for(let e=0;e<a.length;e++){const i=a[e];for(let e=0;e<c.length;e++){const a=c[e];if(a<=i)continue;const o=t[i],l=t[a],s=l.x-o.x,r=l.y-o.y,u=o.r+l.r,m=s*s+r*r;if(m<u*u){const e=u-Math.sqrt(Math.max(m,n.MIN_DISTANCE_EPSILON));d.push({i:i,j:a,overlap:e})}}}}}return d.sort((e,t)=>t.overlap-e.overlap),d}(),l=t.REST,s=.5*t.DPR;for(let i=0;i<e;i++)for(let e=0;e<o.length;e++){const{i:r,j:d}=o[e],c=a[r],u=a[d];if(c.isSleeping&&u.isSleeping)continue;c.isSleeping&&c.wake(),u.isSleeping&&u.wake();const m=u.x-c.x,p=u.y-c.y,h=c.r+u.r,g=m*m+p*p;if(0===g||g>h*h)continue;const v=Math.sqrt(g),f=m/v,b=p/v,y=h-v,M=1/Math.max(c.m,.001),x=1/Math.max(u.m,.001),S=.8*Math.max(y-s,0)/(M+x),w=S*f,E=S*b;c.x-=w*M,c.y-=E*M,u.x+=w*x,u.y+=E*x;const P=u.vx-c.vx,C=u.vy-c.vy,I=P*f+C*b;if(I<0){const e=-(1+(Math.abs(I)<30?0:l))*I/(M+x),a=e*f,o=e*b;c.vx-=a*M,c.vy-=o*M,u.vx+=a*x,u.vy+=o*x;const s=P-I*f,d=C-I*b,m=Math.hypot(s,d);if(m>.001){const e=s*-b+d*f>=0?1:-1,t=n.SPIN_GAIN_TANGENT;c.omega-=e*t*m/Math.max(c.r,1),u.omega+=e*t*m/Math.max(u.r,1)}const p=Math.min(1,Math.abs(I)/(50*(c.r+u.r))),h=Math.min(t.getSquashMax(),.8*p);c.squashAmount=Math.max(c.squashAmount,.8*h),c.squashNormalAngle=Math.atan2(-b,-f),u.squashAmount=Math.max(u.squashAmount,.8*h),u.squashNormalAngle=Math.atan2(b,f),0===i&&p>.05&&q((c.r+u.r)/2,p,(c.x+u.x)/2/(t.canvas?.width||1),`${r}-${e}`)}}}const Ge=n.PHYSICS_DT;let ke=0;const Fe=42;function Ne(e,t){const n=[{x:Fe,y:Fe},{x:t.width-Fe,y:Fe},{x:Fe,y:t.height-Fe},{x:t.width-Fe,y:t.height-Fe}];for(let t=0;t<n.length;t++){const a=n[t].x,i=n[t].y,o=e.x-a,l=e.y-i,s=Math.max(1,Math.hypot(o,l));if(s<Fe+e.r){const t=(Fe+e.r-s)/(Fe+e.r)*1800,n=o/s,a=l/s;e.vx+=n*t*Ge,e.vy+=a*t*Ge}}}let De=0,qe=0,ze=0,Oe=performance.now()/1e3;let We=null;function He(){document.body.classList.add("sound-hover")}function Xe(){document.body.classList.remove("sound-hover")}async function $e(){z().isUnlocked?Ue(!!k&&(G=!G,G)):await async function(){if(k)return!0;try{const e=window.AudioContext||window.webkitAudioContext;return e?(B=new e,"suspended"===B.state&&await B.resume(),T=B.createGain(),T.gain.value=C.masterGain,L=B.createDynamicsCompressor(),L.threshold.value=-3,L.knee.value=6,L.ratio.value=12,L.attack.value=.001,L.release.value=.1,A=B.createGain(),A.gain.value=1-C.reverbWetMix,V=B.createGain(),V.gain.value=C.reverbWetMix,_=function(){const e=B.createGain(),t=B.createGain(),n=[.029,.037,.053,.067].map(e=>{const t=B.createDelay(.1);return t.delayTime.value=e*C.reverbDecay,t}),a=n.map(()=>{const e=B.createGain();return e.gain.value=.4,e}),i=B.createBiquadFilter();return i.type="lowpass",i.frequency.value=2e3*(1-C.reverbHighDamp),i.Q.value=.5,n.forEach((t,o)=>{e.connect(t),t.connect(a[o]),a[o].connect(i),a[o].connect(n[(o+1)%n.length])}),i.connect(t),e.connect(t),e._output=t,e}(),A.connect(L),V.connect(_),_.connect(L),L.connect(T),T.connect(B.destination),k=!0,G=!0,console.log("‚úì Audio unlocked and enabled"),!0):(console.warn("Web Audio API not supported"),!1)}catch(e){return console.error("Failed to unlock audio:",e),!1}}()?Ue(!0):(We.textContent="Audio unavailable",setTimeout(()=>{We.textContent="Sound off"},2e3))}function Ue(e){We&&(We.setAttribute("data-enabled",e?"true":"false"),We.setAttribute("aria-pressed",e?"true":"false"),We.setAttribute("aria-label","Toggle collision sounds"),We.textContent=e?"Sound on":"Sound off")}let Ye=null,Qe=!1;function je(e){const t=Ye.querySelector("#presetDescription"),n=I[e];t&&n&&(t.textContent=n.description)}function Ke(){const e={...C},t=[{id:"attackTime",valId:"attackVal",fromConfig:e=>1e3*e,format:e=>`${Math.round(e)}ms`},{id:"decayTime",valId:"decayVal",fromConfig:e=>1e3*e,format:e=>`${Math.round(e)}ms`},{id:"harmonicGain",valId:"harmonicVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`},{id:"filterBaseFreq",valId:"filterVal",fromConfig:e=>e,format:e=>`${Math.round(e)}Hz`},{id:"filterQ",valId:"filterQVal",fromConfig:e=>e,format:e=>e.toFixed(1)},{id:"filterVelocityRange",valId:"filterVelVal",fromConfig:e=>e,format:e=>`${Math.round(e)}Hz`},{id:"reverbDecay",valId:"reverbDecayVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`},{id:"reverbWetMix",valId:"reverbWetVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`},{id:"masterGain",valId:"masterVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`},{id:"minGain",valId:"minGainVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`},{id:"maxGain",valId:"maxGainVal",fromConfig:e=>100*e,format:e=>`${Math.round(e)}%`}];for(const n of t){const t=Ye.querySelector(`#${n.id}`),a=Ye.querySelector(`#${n.valId}`);if(t&&void 0!==e[n.id]){const i=n.fromConfig(e[n.id]);t.value=i,a&&(a.textContent=n.format(i))}}}function Ze(){Ye&&(Qe=!Qe,Ye.style.display=Qe?"":"none",Qe&&Ke())}function Je(){const e=i(),t=document.documentElement;t.style.setProperty("--container-border",`${e.containerBorder||0}px`),t.style.setProperty("--simulation-padding",`${e.simulationPadding||0}px`)}return async function(){try{console.log("üöÄ Initializing modular bouncy balls..."),function(e){a.config={...e},e.ballMass&&(a.ballMassKg=e.ballMass),e.gravityMultiplier&&(a.gravityMultiplier=e.gravityMultiplier),e.restitution&&(a.REST=e.restitution),e.friction&&(a.FRICTION=e.friction),e.ballScale&&(a.sizeScale=e.ballScale),void 0!==e.containerBorder&&(a.containerBorder=e.containerBorder),void 0!==e.simulationPadding&&(a.simulationPadding=e.simulationPadding);const t=(a.R_MIN_BASE+a.R_MAX_BASE)/2;a.R_MIN=t*a.sizeScale*.75,a.R_MAX=t*a.sizeScale*1.25}(await async function(){try{const e=["config/default-config.json","js/config.json","../public/js/config.json"];for(const t of e)try{const e=await fetch(t,{cache:"no-cache"});if(e.ok)return await e.json()}catch(e){}throw new Error("No config found")}catch(e){return console.warn("Config load failed, using defaults"),{gravityMultiplier:1.05,ballMass:91,maxBalls:300}}}()),console.log("‚úì Config loaded"),Je(),console.log("‚úì Frame padding applied"),function(){if(document.querySelector(".noise-2"))return;const e=document.querySelector(".noise");if(!e)return;const t=document.createElement("div");t.className="noise-2";const n=getComputedStyle(e);n.backgroundImage&&"none"!==n.backgroundImage&&(t.style.backgroundImage=n.backgroundImage),t.style.position="fixed",t.style.inset="0",t.style.pointerEvents="none",t.style.backgroundRepeat="repeat",t.style.backgroundPosition="50%",t.style.backgroundAttachment="fixed",t.style.opacity="0.03",t.style.mixBlendMode="luminosity",e.insertAdjacentElement("afterend",t),console.log("‚úì Created .noise-2 element")}(),y();const o=x(),l=S(),s=document.getElementById("bravia-balls");if(!o||!l||!s)throw new Error("Missing DOM elements");!function(e,t,n){a.canvas=e,a.ctx=t,a.container=n}(o,l,s),M(),console.log("‚úì Canvas initialized (container-relative sizing)"),i().mouseInCanvas=!1,"undefined"!=typeof window&&(window.mouseInCanvas=!1),function(){const e=i(),a=e.canvas;if(!a)return void console.error("Canvas not available for pointer setup");const o=e.DPR;function l(e,t){const n=a.getBoundingClientRect();return{x:(e-n.left)*o,y:(t-n.top)*o,inBounds:e>=n.left&&e<=n.right&&t>=n.top&&t<=n.bottom}}document.addEventListener("mousemove",n=>{if(n.target.closest("#controlPanel"))return;const a=l(n.clientX,n.clientY),i=performance.now(),o=i-Ie;if(o>0&&Ie>0){const e=a.x-Pe,t=a.y-Ce;Re=Math.sqrt(e*e+t*t)/o}if(e.mouseX=a.x,e.mouseY=a.y,e.mouseInCanvas=a.inBounds,"undefined"!=typeof window&&(window.mouseInCanvas=a.inBounds),e.currentMode===t.WATER&&a.inBounds&&Re>.3&&i-Ae>80){const e=Math.min(2*Re,3);ae(a.x,a.y,e),Ae=i}Pe=a.x,Ce=a.y,Ie=i},{passive:!0}),document.addEventListener("click",e=>{e.target.closest("#controlPanel")||e.target.closest("a")||e.target.closest("button")||l(e.clientX,e.clientY).inBounds&&_e()}),document.addEventListener("touchmove",n=>{if(n.touches&&n.touches[0]){const a=l(n.touches[0].clientX,n.touches[0].clientY);e.mouseX=a.x,e.mouseY=a.y,e.mouseInCanvas=a.inBounds;const i=performance.now();e.currentMode===t.WATER&&a.inBounds&&i-Ae>80&&(ae(a.x,a.y,2),Ae=i)}},{passive:!0}),document.addEventListener("touchstart",e=>{if(!e.target.closest("#controlPanel")&&!e.target.closest("a")&&!e.target.closest("button")&&e.touches&&e.touches[0]){if(!l(e.touches[0].clientX,e.touches[0].clientY).inBounds)return;const t=performance.now();t-Be<300&&_e(),Be=t}},{passive:!0}),document.addEventListener("mouseleave",()=>{e.mouseX=n.OFFSCREEN_MOUSE,e.mouseY=n.OFFSCREEN_MOUSE,e.mouseInCanvas=!1,Re=0,"undefined"!=typeof window&&(window.mouseInCanvas=!1)}),document.addEventListener("touchend",()=>{e.mouseX=n.OFFSCREEN_MOUSE,e.mouseY=n.OFFSCREEN_MOUSE,e.mouseInCanvas=!1},{passive:!0}),console.log("‚úì Unified pointer system configured (document-level)")}(),console.log("‚úì Pointer tracking configured"),console.log("‚ö†Ô∏è localStorage is disabled - using defaults"),b(),console.log("‚úì Dark mode initialized"),c(i().currentTemplate),console.log("‚úì Color system initialized"),function(){let e=document.getElementById("controlPanel");e?e.parentElement!==document.body&&(e.parentElement.removeChild(e),document.body.appendChild(e)):(e=document.createElement("div"),e.id="controlPanel",e.className="panel",document.body.appendChild(e)),e.innerHTML='\n  \x3c!-- Draggable header --\x3e\n  <div class="panel-header" id="panelHeader" role="banner">\n    <span><span class="drag-handle" aria-hidden="true">‚ãÆ‚ãÆ</span>Controls</span>\n    <button style="cursor: pointer; opacity: 0.7; background: none; border: none; color: inherit; font-size: 16px; padding: 0;" id="minimizePanel" title="Toggle panel" aria-label="Toggle control panel" aria-expanded="true">‚àí</button>\n  </div>\n  \n  \x3c!-- Screen reader announcements --\x3e\n  <div role="status" aria-live="polite" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;" id="announcer"></div>\n  \n  <div class="panel-content">\n  \n  \x3c!-- Theme Segment Control --\x3e\n  <div style="margin-bottom: 12px; padding: 8px; background: rgba(100,100,255,0.15); border-radius: 4px; border: 1px solid rgba(100,100,255,0.3);">\n    <div style="font-weight: 600; font-size: 11px; margin-bottom: 8px;">üé® Theme</div>\n    <div class="theme-segment-control" role="group" aria-label="Theme selector">\n      <button id="themeAuto" class="theme-segment-btn" aria-label="Auto theme">Auto</button>\n      <button id="themeLight" class="theme-segment-btn active" aria-label="Light theme">Light</button>\n      <button id="themeDark" class="theme-segment-btn" aria-label="Dark theme">Dark</button>\n    </div>\n    <div id="themeStatus" style="font-size: 9px; margin-top: 8px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 3px; font-family: monospace; text-align: center;">\n      ‚òÄÔ∏è Light Mode\n    </div>\n  </div>\n  \n  \x3c!-- GLOBAL SETTINGS --\x3e\n  <details open>\n    <summary>üåê Global Ball Properties</summary>\n    <div class="group">\n        <label title="Global ball size scale (0.1-6.0)">Size: <span class="val" id="sizeValGlobal">1.2</span><input type="range" id="sizeSliderGlobal" min="0.1" max="6.0" step="0.05" value="1.2"></label>\n        <label title="Ball deformation (0-100)">Softness: <span class="val" id="ballSoftnessValGlobal">20</span><input type="range" id="ballSoftnessSliderGlobal" min="0" max="100" step="1" value="20"></label>\n    </div>\n  </details>\n  \n  \x3c!-- Frame/Border Settings (Two-Level Padding System) --\x3e\n  <details>\n    <summary>üñºÔ∏è Frame & Padding</summary>\n    <div class="group">\n        <label><span>Container border (px)</span><input type="range" id="containerBorderSlider" min="0" max="60" step="1" value="0"><span class="val" id="containerBorderVal">0</span></label>\n        <div style="font-size: 9px; opacity: 0.6; margin: 4px 0 10px;">Outer frame ‚Äî reveals body background</div>\n        <label><span>Simulation padding (px)</span><input type="range" id="simulationPaddingSlider" min="0" max="60" step="1" value="0"><span class="val" id="simulationPaddingVal">0</span></label>\n        <div style="font-size: 9px; opacity: 0.6; margin-top: 4px;">Inner padding ‚Äî shrinks ball play area</div>\n    </div>\n  </details>\n  \n  \x3c!-- Build Controls --\x3e\n  <div style="margin-bottom: 12px; padding: 8px; background: rgba(0,255,0,0.1); border-radius: 4px; text-align: center;">\n    <button id="saveConfigBtn" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">üíæ Save Config</button>\n    <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Save downloads current-config.json</div>\n  </div>\n  \n  <details open>\n    <summary>üé® Colors</summary>\n    <div class="group">\n        <label>Color template: <select id="colorSelect"></select></label>\n    </div>\n  </details>\n  \n  <div style="margin: 20px 0; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.15);">\n    <div style="text-align: center; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 12px;">\n      Mode Settings\n    </div>\n    \n    \x3c!-- Mode Switcher --\x3e\n    <div class="mode-switcher" role="group" aria-label="Simulation mode selector">\n      <button class="mode-button" data-mode="pit" aria-label="Ball Pit mode">üéØ Pit</button>\n      <button class="mode-button active" data-mode="flies" aria-label="Flies mode">üïäÔ∏è Flies</button>\n      <button class="mode-button" data-mode="weightless" aria-label="Zero-G mode">üåå Zero-G</button>\n      <button class="mode-button" data-mode="water" aria-label="Water mode">üåä Water</button>\n      <button class="mode-button" data-mode="vortex" aria-label="Vortex mode">üåÄ Vortex</button>\n      <button class="mode-button" data-mode="ping-pong" aria-label="Ping Pong mode">üèì Pong</button>\n      <button class="mode-button" data-mode="magnetic" aria-label="Magnetic mode">üß≤ Magnet</button>\n      <button class="mode-button" data-mode="bubbles" aria-label="Bubbles mode">ü´ß Bubbles</button>\n    </div>\n  </div>\n  \n  <div id="pitControls" class="mode-controls">\n    <details open>\n      <summary>üéØ Ball Pit Mode</summary>\n      <div class="group">\n        <label><span>Gravity (√óEarth)</span><input type="range" id="gravityPitSlider" min="0.0" max="2.0" step="0.05" value="1.10"><span class="val" id="gravityPitVal">1.10</span></label>\n        <label><span>Weight (grams)</span><input type="range" id="weightPitSlider" min="10.0" max="200.0" step="1.0" value="129"><span class="val" id="weightPitVal">129</span></label>\n        <label><span>Bounciness</span><input type="range" id="restitutionSlider" min="0.00" max="1.00" step="0.01" value="0.69"><span class="val" id="restitutionVal">0.69</span></label>\n        <label><span>Air friction</span><input type="range" id="frictionSlider" min="0.000" max="0.010" step="0.0005" value="0.0060"><span class="val" id="frictionVal">0.0060</span></label>\n      </div>\n    </details>\n    <details open>\n      <summary>üß≤ Mouse Repeller</summary>\n      <div class="group">\n        <label><span>Repel size (px)</span><input type="range" id="repelSizeSlider" min="50" max="1000" step="5" value="120"><span class="val" id="repelSizeVal">120</span></label>\n        <label><span>Repel power</span><input type="range" id="repelPowerSlider" min="0" max="10000" step="100" value="8500"><span class="val" id="repelPowerVal">274000</span></label>\n      </div>\n    </details>\n  </div>\n  \n  <div id="fliesControls" class="mode-controls active">\n    <details open>\n      <summary>üïäÔ∏è Flies to Light Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="fliesBallCountSlider" min="20" max="150" step="5" value="60"><span class="val" id="fliesBallCountVal">60</span></label>\n        <label><span>Attraction power</span><input type="range" id="attractPowerSlider" min="100" max="8000" step="50" value="5000"><span class="val" id="attractPowerVal">5000</span></label>\n        <label><span>Swarm speed (√ó)</span><input type="range" id="swarmSpeedSlider" min="0.2" max="5.0" step="0.1" value="0.4"><span class="val" id="swarmSpeedVal">0.4</span></label>\n        <label><span>Separation force</span><input type="range" id="fliesSeparationSlider" min="5000" max="30000" step="1000" value="15000"><span class="val" id="fliesSeparationVal">15000</span></label>\n      </div>\n    </details>\n  </div>\n  \n  <div id="weightlessControls" class="mode-controls">\n    <details open>\n      <summary>üåå Zero-G Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="weightlessCountSlider" min="20" max="200" step="10" value="80"><span class="val" id="weightlessCountVal">80</span></label>\n        <label><span>Initial speed</span><input type="range" id="weightlessSpeedSlider" min="100" max="600" step="25" value="250"><span class="val" id="weightlessSpeedVal">250</span></label>\n        <label><span>Bounce</span><input type="range" id="weightlessBounceSlider" min="0.5" max="1.0" step="0.05" value="0.95"><span class="val" id="weightlessBounceVal">0.95</span></label>\n      </div>\n    </details>\n  </div>\n  \n  <div id="waterControls" class="mode-controls">\n    <details open>\n      <summary>üåä Water Swimming Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="waterBallCountSlider" min="50" max="400" step="10" value="300"><span class="val" id="waterBallCountVal">300</span></label>\n        <label><span>Ripple strength</span><input type="range" id="waterRippleStrengthSlider" min="5000" max="30000" step="1000" value="18000"><span class="val" id="waterRippleStrengthVal">18000</span></label>\n        <label><span>Motion intensity</span><input type="range" id="waterMotionSlider" min="0" max="80" step="1" value="40"><span class="val" id="waterMotionVal">40</span></label>\n        <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Move your cursor to create ripples</div>\n      </div>\n    </details>\n  </div>\n  \n  <div id="vortexControls" class="mode-controls">\n    <details open>\n      <summary>üåÄ Vortex Sheets Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="vortexBallCountSlider" min="50" max="300" step="10" value="180"><span class="val" id="vortexBallCountVal">180</span></label>\n        <label><span>Swirl strength</span><input type="range" id="vortexSwirlSlider" min="100" max="800" step="20" value="420"><span class="val" id="vortexSwirlVal">420</span></label>\n        <label><span>Radial pull</span><input type="range" id="vortexPullSlider" min="0" max="400" step="10" value="180"><span class="val" id="vortexPullVal">180</span></label>\n        <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Move cursor to create vortex</div>\n      </div>\n    </details>\n  </div>\n  \n  <div id="ping-pongControls" class="mode-controls">\n    <details open>\n      <summary>üèì Ping Pong Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="pingPongBallCountSlider" min="10" max="100" step="5" value="35"><span class="val" id="pingPongBallCountVal">35</span></label>\n        <label><span>Ball speed</span><input type="range" id="pingPongSpeedSlider" min="200" max="1200" step="50" value="800"><span class="val" id="pingPongSpeedVal">800</span></label>\n        <label><span>Cursor obstacle size</span><input type="range" id="pingPongCursorSlider" min="20" max="200" step="10" value="50"><span class="val" id="pingPongCursorVal">50</span></label>\n        <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Continuous motion ‚Ä¢ Cursor deflects balls</div>\n      </div>\n    </details>\n  </div>\n  \n  <div id="magneticControls" class="mode-controls">\n    <details open>\n      <summary>üß≤ Magnetic Mode</summary>\n      <div class="group">\n        <label><span>Ball count</span><input type="range" id="magneticBallCountSlider" min="50" max="300" step="10" value="180"><span class="val" id="magneticBallCountVal">180</span></label>\n        <label><span>Magnetic strength</span><input type="range" id="magneticStrengthSlider" min="10000" max="100000" step="5000" value="65000"><span class="val" id="magneticStrengthVal">65000</span></label>\n        <label><span>Max velocity</span><input type="range" id="magneticVelocitySlider" min="500" max="4000" step="100" value="2800"><span class="val" id="magneticVelocityVal">2800</span></label>\n        <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Cursor drives magnetic swirls (no explosions)</div>\n      </div>\n    </details>\n  </div>\n  \n  <div id="bubblesControls" class="mode-controls">\n    <details open>\n      <summary>ü´ß Carbonated Bubbles Mode</summary>\n      <div class="group">\n        <label><span>Bubble rate</span><input type="range" id="bubblesRateSlider" min="1" max="20" step="1" value="8"><span class="val" id="bubblesRateVal">8</span></label>\n        <label><span>Rise speed</span><input type="range" id="bubblesSpeedSlider" min="50" max="400" step="25" value="150"><span class="val" id="bubblesSpeedVal">150</span></label>\n        <label><span>Wobble</span><input type="range" id="bubblesWobbleSlider" min="0" max="100" step="5" value="40"><span class="val" id="bubblesWobbleVal">40</span></label>\n        <label><span>Max bubbles</span><input type="range" id="bubblesMaxSlider" min="50" max="300" step="10" value="150"><span class="val" id="bubblesMaxVal">150</span></label>\n        <label><span>Cursor deflection</span><input type="range" id="bubblesDeflectSlider" min="20" max="150" step="10" value="80"><span class="val" id="bubblesDeflectVal">80</span></label>\n        <div style="font-size: 9px; opacity: 0.7; margin-top: 6px;">Bubbles rise from bottom ‚Ä¢ Pop at top ‚Ä¢ Cursor deflects</div>\n      </div>\n    </details>\n  </div>\n  \n  <div style="font-size:10px; opacity:0.5; text-align:center; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">\n    <code>R</code> reset ‚Ä¢ <code>/</code> panel ‚Ä¢ click/tap cycles modes\n  </div>\n  \n  </div>\n',b();const t=e.querySelector("#minimizePanel");t&&t.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("hidden"),e.style.display=e.classList.contains("hidden")?"none":""}),function(e){const t=e.querySelector(".panel-header");if(!t)return;let n=!1,a=0,i=0;t.addEventListener("mousedown",o=>{n=!0;const l=e.getBoundingClientRect();a=o.clientX-l.left,i=o.clientY-l.top,t.style.cursor="grabbing"}),document.addEventListener("mousemove",t=>{if(!n)return;const o=t.clientX-a,l=t.clientY-i,s=window.innerWidth-e.offsetWidth-20,r=window.innerHeight-e.offsetHeight-20;e.style.left=Math.max(20,Math.min(o,s))+"px",e.style.top=Math.max(20,Math.min(l,r))+"px",e.style.right="auto"}),document.addEventListener("mouseup",()=>{n=!1,t.style.cursor="move"})}(e),Se(),function(){const e=document.getElementById("saveConfigBtn");e&&e.addEventListener("click",()=>{const e=i(),t={gravityMultiplier:e.gravityMultiplierPit,ballMass:e.ballMassKg,sizeScale:e.sizeScale,sizeVariation:e.sizeVariation,restitution:e.REST,friction:e.FRICTION,repelRadius:e.repelRadius,repelPower:e.repelPower,repelSoftness:e.repelSoft,cursorColorIndex:5,enableLOD:!1},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download="current-config.json",document.body.appendChild(a),a.click(),document.body.removeChild(a)})}(),e.classList.add("hidden"),console.log("‚úì Panel created")}(),u(),console.log("‚úì Panel created"),function(){const e=document.getElementById("controlPanel");window.addEventListener("keydown",n=>{const a=n.key.toLowerCase();if(("/"===a||"Slash"===n.code)&&e)return n.preventDefault(),e.classList.toggle("hidden"),void(e.style.display=e.classList.contains("hidden")?"none":"");"1"===a?(n.preventDefault(),fe(t.PIT),we("pit")):"2"===a?(n.preventDefault(),fe(t.FLIES),we("flies")):"3"===a?(n.preventDefault(),fe(t.WEIGHTLESS),we("weightless")):"4"===a?(n.preventDefault(),fe(t.WATER),we("water")):"5"===a?(n.preventDefault(),fe(t.VORTEX),we("vortex")):"6"===a?(n.preventDefault(),fe(t.PING_PONG),we("ping-pong")):"7"===a?(n.preventDefault(),fe(t.MAGNETIC),we("magnetic")):"8"===a&&(n.preventDefault(),fe(t.BUBBLES),we("bubbles"))}),console.log("‚úì Keyboard shortcuts registered")}(),console.log("‚úì Keyboard shortcuts registered"),function(){const e=document.getElementById("cv-gate-trigger"),t=document.getElementById("brand-logo"),n=document.getElementById("cv-gate"),a=Array.from(document.querySelectorAll(".cv-digit")),i=document.body;if(!e||!t||!n||0===a.length)return void console.warn("CV Gate: Missing required elements");let o=!1;const l=()=>{o=!1,a.forEach(e=>e.value=""),n.classList.remove("active"),t.classList.remove("fade-out-up"),setTimeout(()=>{o||n.classList.add("hidden")},400)},s=()=>{const e=a.map(e=>e.value).join("");4===e.length&&("1111"===e?(i.classList.add("flash-green"),setTimeout(()=>{window.location.href="cv-test.html"},400)):(i.classList.add("flash-red"),setTimeout(()=>{i.classList.remove("flash-red"),a.forEach(e=>e.value=""),a[0].focus()},400)))};e.addEventListener("click",e=>{e.preventDefault(),o=!0,t.classList.add("fade-out-up"),n.classList.remove("hidden"),n.offsetWidth,n.classList.add("active"),a[0].focus()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&o&&l()}),a.forEach((e,t)=>{e.addEventListener("keydown",n=>{"Backspace"===n.key&&""===e.value&&(t>0?a[t-1].focus():l())}),e.addEventListener("input",e=>{const n=e.target.value;if(/^\d*$/.test(n)){if(1===n.length)t<a.length-1?a[t+1].focus():s();else if(n.length>1){const i=n.split("");e.target.value=i[0];let o=t+1;for(let e=1;e<i.length&&o<a.length;e++)a[o].value=i[e],o++;o<a.length?a[o].focus():s()}}else e.target.value=n.replace(/\D/g,"")}),e.addEventListener("focus",()=>{e.select()})})}(),console.log("‚úì Password gate initialized"),function(){if(function(){if("undefined"!=typeof window&&window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");D=e.matches,e.addEventListener("change",e=>{D=e.matches})}console.log("‚úì Sound engine initialized (awaiting user unlock)")}(),"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return console.log("‚è∏ Sound toggle hidden (prefers-reduced-motion)"),null;We=document.createElement("button"),We.className="sound-toggle",We.id="sound-toggle",We.type="button",We.setAttribute("aria-label","Toggle collision sounds"),We.setAttribute("aria-pressed","false"),We.setAttribute("data-enabled","false"),We.textContent="Sound off",We.addEventListener("click",$e),We.addEventListener("mouseenter",He),We.addEventListener("mouseleave",Xe);const e=document.querySelector("aside.viewport--corners");e?e.appendChild(We):document.body.appendChild(We),console.log("‚úì Sound toggle created")}(),console.log("‚úì Sound toggle created"),Ye=document.createElement("div"),Ye.id="soundPanel",Ye.className="panel sound-panel",Ye.setAttribute("role","dialog"),Ye.setAttribute("aria-label","Sound configuration"),Ye.innerHTML='\n<div class="panel-header">\n  <span><span class="drag-handle">‚ãÆ‚ãÆ</span> Sound Designer</span>\n  <button id="minimizeSoundPanel" type="button" aria-label="Minimize panel">‚àí</button>\n</div>\n<div class="panel-content">\n  \x3c!-- Presets --\x3e\n  <div class="group">\n    <label>\n      <div><span>Preset</span></div>\n      <select id="soundPresetSelect"></select>\n    </label>\n    <div id="presetDescription" class="preset-description"></div>\n  </div>\n  \n  \x3c!-- Envelope --\x3e\n  <details open>\n    <summary>Envelope</summary>\n    <div class="group">\n      <label>\n        <div><span>Attack</span><span class="val" id="attackVal">8ms</span></div>\n        <input type="range" id="attackTime" min="1" max="50" step="1" value="8">\n      </label>\n      <label>\n        <div><span>Decay</span><span class="val" id="decayVal">80ms</span></div>\n        <input type="range" id="decayTime" min="20" max="300" step="5" value="80">\n      </label>\n    </div>\n  </details>\n  \n  \x3c!-- Tone --\x3e\n  <details>\n    <summary>Tone</summary>\n    <div class="group">\n      <label>\n        <div><span>Harmonic</span><span class="val" id="harmonicVal">15%</span></div>\n        <input type="range" id="harmonicGain" min="0" max="60" step="1" value="15">\n      </label>\n      <label>\n        <div><span>Filter Cutoff</span><span class="val" id="filterVal">2200Hz</span></div>\n        <input type="range" id="filterBaseFreq" min="200" max="8000" step="100" value="2200">\n      </label>\n      <label>\n        <div><span>Filter Resonance</span><span class="val" id="filterQVal">0.7</span></div>\n        <input type="range" id="filterQ" min="0.1" max="4" step="0.1" value="0.7">\n      </label>\n      <label>\n        <div><span>Velocity ‚Üí Brightness</span><span class="val" id="filterVelVal">800Hz</span></div>\n        <input type="range" id="filterVelocityRange" min="0" max="3000" step="50" value="800">\n      </label>\n    </div>\n  </details>\n  \n  \x3c!-- Reverb --\x3e\n  <details>\n    <summary>Reverb</summary>\n    <div class="group">\n      <label>\n        <div><span>Decay Time</span><span class="val" id="reverbDecayVal">35%</span></div>\n        <input type="range" id="reverbDecay" min="5" max="90" step="5" value="35">\n      </label>\n      <label>\n        <div><span>Wet Mix</span><span class="val" id="reverbWetVal">35%</span></div>\n        <input type="range" id="reverbWetMix" min="0" max="80" step="5" value="35">\n      </label>\n    </div>\n  </details>\n  \n  \x3c!-- Volume --\x3e\n  <details>\n    <summary>Volume</summary>\n    <div class="group">\n      <label>\n        <div><span>Master Volume</span><span class="val" id="masterVal">70%</span></div>\n        <input type="range" id="masterGain" min="10" max="100" step="5" value="70">\n      </label>\n      <label>\n        <div><span>Min Collision Vol</span><span class="val" id="minGainVal">12%</span></div>\n        <input type="range" id="minGain" min="1" max="40" step="1" value="12">\n      </label>\n      <label>\n        <div><span>Max Collision Vol</span><span class="val" id="maxGainVal">45%</span></div>\n        <input type="range" id="maxGain" min="20" max="80" step="1" value="45">\n      </label>\n    </div>\n  </details>\n</div>\n',Ye.style.display="none",Qe=!1,document.body.appendChild(Ye),function(){const e=Ye.querySelector("#soundPresetSelect");if(Ye.querySelector("#presetDescription"),e){for(const[t,n]of Object.entries(I)){const a=document.createElement("option");a.value=t,a.textContent=n.label,e.appendChild(a)}e.value=W(),je(W()),e.addEventListener("change",()=>{!function(e){const t=I[e];t?(R=e,O({attackTime:t.attackTime,decayTime:t.decayTime,harmonicGain:t.harmonicGain,filterBaseFreq:t.filterBaseFreq,filterVelocityRange:t.filterVelocityRange,filterQ:t.filterQ,reverbDecay:t.reverbDecay,reverbWetMix:t.reverbWetMix,masterGain:t.masterGain}),console.log(`üéµ Applied sound preset: ${t.label}`)):console.warn(`Unknown sound preset: ${e}`)}(e.value),je(e.value),Ke()})}}(),function(){const e=[{id:"attackTime",valId:"attackVal",format:e=>`${e}ms`,toConfig:e=>e/1e3},{id:"decayTime",valId:"decayVal",format:e=>`${e}ms`,toConfig:e=>e/1e3},{id:"harmonicGain",valId:"harmonicVal",format:e=>`${e}%`,toConfig:e=>e/100},{id:"filterBaseFreq",valId:"filterVal",format:e=>`${e}Hz`,toConfig:e=>e},{id:"filterQ",valId:"filterQVal",format:e=>e.toFixed(1),toConfig:e=>e},{id:"filterVelocityRange",valId:"filterVelVal",format:e=>`${e}Hz`,toConfig:e=>e},{id:"reverbDecay",valId:"reverbDecayVal",format:e=>`${e}%`,toConfig:e=>e/100},{id:"reverbWetMix",valId:"reverbWetVal",format:e=>`${e}%`,toConfig:e=>e/100},{id:"masterGain",valId:"masterVal",format:e=>`${e}%`,toConfig:e=>e/100},{id:"minGain",valId:"minGainVal",format:e=>`${e}%`,toConfig:e=>e/100},{id:"maxGain",valId:"maxGainVal",format:e=>`${e}%`,toConfig:e=>e/100}];for(const t of e){const e=Ye.querySelector(`#${t.id}`),n=Ye.querySelector(`#${t.valId}`);e&&e.addEventListener("input",()=>{const a=parseFloat(e.value),i=t.toConfig(a);n&&(n.textContent=t.format(a)),O({[t.id]:i})})}Ke()}(),function(){const e=Ye.querySelector("#minimizeSoundPanel");e&&e.addEventListener("click",e=>{e.stopPropagation(),Ze()})}(),function(){const e=Ye.querySelector(".panel-header");if(!e)return;let t=!1,n=0,a=0;e.addEventListener("mousedown",i=>{if("BUTTON"===i.target.tagName)return;t=!0;const o=Ye.getBoundingClientRect();n=i.clientX-o.left,a=i.clientY-o.top,e.style.cursor="grabbing"}),document.addEventListener("mousemove",e=>{if(!t)return;const i=e.clientX-n,o=e.clientY-a,l=window.innerWidth-Ye.offsetWidth-20,s=window.innerHeight-Ye.offsetHeight-20;Ye.style.left=Math.max(20,Math.min(i,l))+"px",Ye.style.top=Math.max(20,Math.min(o,s))+"px",Ye.style.right="auto"}),document.addEventListener("mouseup",()=>{t=!1,e&&(e.style.cursor="move")})}(),document.addEventListener("keydown",e=>{"INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||"SELECT"===e.target.tagName||"s"!==e.key&&"S"!==e.key||z().isUnlocked&&Ze()}),console.log("‚úì Sound panel created (press S to toggle)"),console.log("‚úì Sound panel created"),fe(t.FLIES),console.log("‚úì Mode initialized");const r=()=>be();e=(e,t)=>{const n=r();n&&n(e,t)},requestAnimationFrame(function a(o){const l=o/1e3;let s=Math.min(.033,l-Oe);Oe=l,async function(e,a){const o=i(),l=o.balls,s=o.canvas;if(!s||0===l.length)return;ke+=e;let r=0;for(;ke>=Ge&&r<n.MAX_PHYSICS_STEPS;){const e=l.length;for(let t=0;t<e;t++)l[t].step(Ge,a);o.currentMode!==t.FLIES&&Le(10);const n=o.currentMode===t.WEIGHTLESS?o.weightlessBounce:o.REST,i=l.length;for(let e=0;e<i;e++)Ne(l[e],s),l[e].walls(s.width,s.height,Ge,n);ke-=Ge,r++}o.currentMode===t.WATER&&ne(e),ke>Ge*n.ACCUMULATOR_RESET_THRESHOLD&&(ke=0)}(s,e),function(){const e=i(),t=e.ctx,n=e.balls,a=e.canvas;if(t&&a){t.clearRect(0,0,a.width,a.height),e.currentMode;for(let e=0;e<n.length;e++)n[e].draw(t);!function(e){const t=i();if(!t.mouseInCanvas)return;if(!0===t.isTouchDevice)return;if(!1===t.cursorBallVisible)return;const n=Math.max(6*t.DPR,.12*(t.R_MIN+t.R_MAX));e.save(),e.beginPath(),e.arc(t.mouseX,t.mouseY,n,0,2*Math.PI),e.fillStyle=t.currentColors&&t.currentColors[4]||"#000000",e.globalAlpha=.9,e.fill(),e.globalAlpha=1,e.restore()}(t)}}(),function(e){if(qe++,e-De>1e3){ze=qe,qe=0,De=e;const t=document.getElementById("render-fps");t&&(t.textContent=String(ze))}}(performance.now()),requestAnimationFrame(a)}),console.log("‚úÖ Bouncy Balls running (modular)")}catch(e){console.error("‚ùå Initialization failed:",e),document.body.innerHTML=`<div style="padding: 20px; color: red; background: white;">\n      <h2>Initialization Error</h2>\n      <pre>${e.message}\n${e.stack}</pre>\n    </div>`}var e}(),e.applyFramePaddingCSSVars=Je,e}({});
