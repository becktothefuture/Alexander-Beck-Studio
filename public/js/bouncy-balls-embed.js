var e=function(e){"use strict";const t={PIT:"pit",FLIES:"flies",WEIGHTLESS:"weightless",WATER:"water",VORTEX:"vortex",PING_PONG:"ping-pong",MAGNETIC:"magnetic",BUBBLES:"bubbles"},n={DPR:Math.max(1,Math.min(2,window.devicePixelRatio||1)),OFFSCREEN_MOUSE:-1e9,MIN_DISTANCE_EPSILON:1e-6,ACCUMULATOR_RESET_THRESHOLD:3,MAX_PHYSICS_STEPS:2,SPIN_DAMP_PER_S:2,SPIN_GAIN:.25,SPIN_GAIN_TANGENT:.18,ROLL_FRICTION_PER_S:1.5,SQUASH_MAX_BASE:.2,SQUASH_DECAY_PER_S:18,WALL_REST_VEL_THRESHOLD:70,GROUND_COUPLING_PER_S:8,SLEEP_VELOCITY_THRESHOLD:5,SLEEP_ANGULAR_THRESHOLD:.05,TIME_TO_SLEEP:.5,PHYSICS_DT:1/120},a={config:{},currentMode:t.FLIES,balls:[],canvas:null,ctx:null,container:null,mouseX:n.OFFSCREEN_MOUSE,mouseY:n.OFFSCREEN_MOUSE,mouseInCanvas:!1,GE:1960,G:0,gravityScale:1,gravityMultiplier:0,gravityMultiplierPit:1.1,REST:.69,FRICTION:.006,ballMassKg:129,MASS_BASELINE_KG:129,MASS_REST_EXP:.15,MASS_GRAVITY_EXP:.35,DPR:Math.max(1,Math.min(2,window.devicePixelRatio||1)),sizeScale:1.2,sizeVariation:0,responsiveScale:1,R_MIN_BASE:6,R_MAX_BASE:24,R_MIN:6*1.2*.75,R_MAX:36,ballSoftness:20,cornerRadius:42,vignetteX:0,vignetteY:0,vignetteBlurOuter:180,vignetteBlurMid:100,vignetteBlurInner:40,vignetteSpread:0,vignetteLightIntensity:.08,vignetteDarkIntensity:.05,vignetteTransition:800,vortexSwirlStrength:420,vortexRadialPull:180,vortexBallCount:180,magneticBallCount:180,magneticStrength:65e3,magneticMaxVelocity:2800,magneticExplosionInterval:5,bubblesSpawnRate:8,bubblesRiseSpeed:150,bubblesWobble:40,bubblesMaxCount:150,bubblesDeflectRadius:80,pingPongBallCount:35,pingPongSpeed:800,pingPongCursorRadius:50,currentColors:["#b7bcb7","#e4e9e4","#ffffff","#00695c","#000000","#ff4013","#0d5cb6","#ffa000"],currentTemplate:"industrialTeal",fliesBallCount:60,attractionPower:5e3,orbitRadius:180,swarmSpeed:.4,fliesSeparation:15e3,weightlessCount:80,weightlessInitialSpeed:250,weightlessBounce:.97,gridColumns:40,gridBallCount:120,pulseInterval:.8,waterBallCount:300,waterDrag:.015,waterRippleSpeed:300,waterRippleStrength:18e3,waterDriftStrength:40,waterInitialVelocity:200,repelRadius:120,repelPower:274e3,repelSoft:3.4,repellerEnabled:!1,emitterTimer:0,autoDarkModeEnabled:!0,isDarkMode:!1,containerBorder:0,simulationPadding:0,frameColor:"#0a0a0a",wallThickness:20,wallSoftness:20,wallRadius:42,wallBounceIntensity:0,wallBounceHighlightMax:.3,wallWobbleMaxDeform:30,wallWobbleStiffness:400,wallWobbleDamping:18,wallWobbleSigma:2,wallWobbleImpactThreshold:.05,wallWobbleCornerClamp:.1,wallBounceHighlightDecay:5,getSquashMax(){return 0===this.ballSoftness?0:n.SQUASH_MAX_BASE*(this.ballSoftness/40)},getCanvasCornerRadius(){return Math.max(0,this.cornerRadius-this.simulationPadding)}};function o(){return a}function i(){a.balls.length=0}const l={industrialTeal:{label:"Industrial Teal",light:["#b7bcb7","#e4e9e4","#ffffff","#00695c","#000000","#ff4013","#0d5cb6","#ffa000"],dark:["#6b726b","#3d453d","#8a928a","#00e6c3","#d5d5d5","#ff6b47","#5b9aff","#ffb84d"]},sunsetCoral:{label:"Sunset Coral",light:["#bdbbb8","#e8e6e3","#ffffff","#ff3b3b","#000000","#00f5d4","#1e40af","#fb923c"],dark:["#716f6b","#3f3d3a","#8e8c88","#ff6b6b","#d8d8d8","#00ffe7","#6ba3ff","#ffb570"]},violetPunch:{label:"Violet Punch",light:["#b8b7c2","#e6e5ed","#ffffff","#9333ea","#000000","#dc2626","#0ea5e9","#facc15"],dark:["#6d6c7a","#3a3845","#8b8a98","#c266ff","#dad6e8","#ff5c5c","#42d4ff","#fff066"]},citrusBlast:{label:"Citrus Blast",light:["#bfbdb5","#eae8df","#ffffff","#ea580c","#000000","#e11d48","#2563eb","#059669"],dark:["#74726a","#403e38","#918f87","#ff8c4d","#dbd9d1","#ff5c7a","#6ba3ff","#00d699"]},cobaltSpark:{label:"Cobalt Spark",light:["#b5b8be","#e3e6eb","#ffffff","#1d4ed8","#000000","#ea580c","#db2777","#d97706"],dark:["#696d75","#3a3e45","#878b93","#6b9dff","#d6dae2","#ff8c5c","#ff66b3","#ffc266"]}},s=[.5,.25,.12,.06,.03,.02,.01,.01];function r(){const e=o().currentColors;if(!e||0===e.length)return console.warn("No colors available, using fallback"),"#ffffff";const t=Math.random();let n=0;for(let a=0;a<Math.min(e.length,s.length);a++)if(n+=s[a],t<=n)return e[a];return e[Math.min(e.length-1,7)]}function c(e){const t=o().currentColors;return t&&0!==t.length?t[Math.max(0,Math.min(7,Math.floor(e)))]||"#ffffff":(console.warn("No colors available, using fallback"),"#ffffff")}function d(e){const t=o();t.currentTemplate=e,t.currentColors=function(e){const t=o(),n=l[e];return n?t.isDarkMode?n.dark:n.light:l.industrialTeal.light}(e),t.cursorBallColor=t.currentColors[t.cursorBallIndex||4],function(){const e=o().balls;for(let t=0;t<e.length;t++)e[t].color=r()}(),function(e){try{const t=document.documentElement,n=(e&&e.length?e:[]).slice(0,8);for(let e=0;e<8;e++){const a=n[e]||"#ffffff";t.style.setProperty(`--ball-${e+1}`,a)}}catch(e){}}(t.currentColors),function(){const e=o().currentColors;for(let t=1;t<=8;t++){const n=document.getElementById(`color${t}`),a=document.getElementById(`color${t}Val`);n&&e[t-1]&&(n.value=e[t-1],a&&(a.textContent=e[t-1].toUpperCase()))}}()}function u(){const e=document.getElementById("colorSelect");if(!e)return;e.innerHTML="";for(const[t,n]of Object.entries(l)){const a=document.createElement("option");a.value=t,a.textContent=n.label,e.appendChild(a)}const t=o();e.value=t.currentTemplate}const m=[131,147,165,196,220,262,294,330,392,440,523];let h={attackTime:0,decayTime:.045,harmonicGain:.12,filterBaseFreq:2100,filterVelocityRange:320,filterQ:.45,reverbDecay:.18,reverbWetMix:.12,reverbHighDamp:.65,minGain:.03,maxGain:.18,masterGain:.42,minTimeBetweenSounds:.008,maxPan:.22,toneSafetyMinHz:120,toneSafetyMaxHz:600,toneSafetyExponent:2.2,toneSafetyHighGainAtten:.22,toneSafetyLowGainAtten:.1,toneSafetyHighBrightAtten:.3,filterMinHz:450,filterMaxHz:5200,voiceGainMax:.25,collisionMinImpact:.12,rollingEnabled:!0,rollingMaxVelocity:80,rollingMinVelocity:15,rollingGain:.02,rollingFreq:130,whooshEnabled:!1,whooshMinVelocity:500,whooshGain:0,whooshFreq:800};const g={materialWood:{label:"Material ‚Äî Wood",description:"Warm clacks ¬∑ dry room ¬∑ subtle surface friction",attackTime:0,decayTime:.045,harmonicGain:.12,filterBaseFreq:2100,filterVelocityRange:320,filterQ:.45,reverbDecay:.18,reverbWetMix:.12,masterGain:.42,minGain:.03,maxGain:.18,collisionMinImpact:.12,rollingEnabled:!0,rollingGain:.02,rollingFreq:130,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},materialStone:{label:"Material ‚Äî Stone",description:"Crisper taps ¬∑ slightly brighter ¬∑ more ‚Äútick‚Äù",attackTime:0,decayTime:.04,harmonicGain:.08,filterBaseFreq:2850,filterVelocityRange:520,filterQ:.55,reverbDecay:.18,reverbWetMix:.12,masterGain:.4,minGain:.03,maxGain:.2,collisionMinImpact:.14,rollingEnabled:!0,rollingGain:.012,rollingFreq:110,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},materialPlastic:{label:"Material ‚Äî Plastic",description:"Softer ‚Äútok‚Äù ¬∑ less bright ¬∑ slightly longer decay",attackTime:0,decayTime:.06,harmonicGain:.16,filterBaseFreq:1650,filterVelocityRange:260,filterQ:.35,reverbDecay:.18,reverbWetMix:.12,masterGain:.44,minGain:.03,maxGain:.19,collisionMinImpact:.1,rollingEnabled:!0,rollingGain:.024,rollingFreq:155,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},woodenDiscs:{label:"Wooden Discs",description:"Warm woody clacks ¬∑ subtle table friction ¬∑ no air whoosh",attackTime:0,decayTime:.045,harmonicGain:.12,filterBaseFreq:2100,filterVelocityRange:320,filterQ:.45,reverbDecay:.18,reverbWetMix:.12,masterGain:.42,minGain:.03,maxGain:.18,collisionMinImpact:.12,rollingEnabled:!0,rollingGain:.02,rollingFreq:130,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},softClick:{label:"Soft Click",description:"Instant, clicky, gently fading",attackTime:0,decayTime:.055,harmonicGain:.09,filterBaseFreq:2400,filterVelocityRange:380,filterQ:.4,reverbDecay:.28,reverbWetMix:.22,masterGain:.52,minGain:.05,maxGain:.28,collisionMinImpact:.13,rollingEnabled:!0,rollingGain:.018,rollingFreq:120,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},riverStones:{label:"River Stones",description:"Crisp, tactile taps",attackTime:0,decayTime:.05,harmonicGain:.18,filterBaseFreq:2800,filterVelocityRange:600,filterQ:.55,reverbDecay:.2,reverbWetMix:.15,masterGain:.48,minGain:.04,maxGain:.22,collisionMinImpact:.14,rollingEnabled:!0,rollingGain:.016,rollingFreq:110,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},rainDrops:{label:"Rain Drops",description:"Light, delicate plinks",attackTime:0,decayTime:.042,harmonicGain:.11,filterBaseFreq:3200,filterVelocityRange:450,filterQ:.45,reverbDecay:.35,reverbWetMix:.3,masterGain:.4,minGain:.03,maxGain:.18,collisionMinImpact:.12,rollingEnabled:!0,rollingGain:.014,rollingFreq:135,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},silkTouch:{label:"Silk Touch",description:"Ultra-smooth, barely there",attackTime:0,decayTime:.065,harmonicGain:.04,filterBaseFreq:1800,filterVelocityRange:250,filterQ:.3,reverbDecay:.4,reverbWetMix:.35,masterGain:.32,minGain:.02,maxGain:.14,collisionMinImpact:.16,rollingEnabled:!0,rollingGain:.012,rollingFreq:115,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},morningDew:{label:"Morning Dew",description:"Fresh, hopeful sparkle",attackTime:0,decayTime:.048,harmonicGain:.14,filterBaseFreq:3600,filterVelocityRange:550,filterQ:.5,reverbDecay:.32,reverbWetMix:.28,masterGain:.38,minGain:.03,maxGain:.19,collisionMinImpact:.12,rollingEnabled:!0,rollingGain:.014,rollingFreq:140,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},bamboo:{label:"Bamboo",description:"Hollow, zen garden taps",attackTime:0,decayTime:.08,harmonicGain:.2,filterBaseFreq:2200,filterVelocityRange:400,filterQ:.65,reverbDecay:.25,reverbWetMix:.2,masterGain:.45,minGain:.04,maxGain:.22,collisionMinImpact:.13,rollingEnabled:!0,rollingGain:.018,rollingFreq:105,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},whisper:{label:"Whisper",description:"Almost silent, intimate",attackTime:0,decayTime:.07,harmonicGain:.03,filterBaseFreq:1400,filterVelocityRange:180,filterQ:.25,reverbDecay:.5,reverbWetMix:.45,masterGain:.22,minGain:.015,maxGain:.11,collisionMinImpact:.17,rollingEnabled:!0,rollingGain:.01,rollingFreq:110,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},glitch:{label:"Glitch",description:"Digital artifacts, unstable",attackTime:0,decayTime:.025,harmonicGain:.55,filterBaseFreq:5500,filterVelocityRange:2500,filterQ:2.5,reverbDecay:.08,reverbWetMix:.05,masterGain:.35,minGain:.03,maxGain:.2,collisionMinImpact:.08,rollingEnabled:!0,rollingGain:.02,rollingFreq:160,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},theVoid:{label:"The Void",description:"Dark, hollow, unsettling",attackTime:.005,decayTime:.25,harmonicGain:.02,filterBaseFreq:350,filterVelocityRange:100,filterQ:.8,reverbDecay:.85,reverbWetMix:.7,masterGain:.55,minGain:.06,maxGain:.32,collisionMinImpact:.11,rollingEnabled:!0,rollingGain:.012,rollingFreq:80,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1},midnight:{label:"Midnight",description:"Subtle, mysterious, elegant",attackTime:0,decayTime:.09,harmonicGain:.07,filterBaseFreq:1900,filterVelocityRange:280,filterQ:.35,reverbDecay:.55,reverbWetMix:.4,masterGain:.36,minGain:.03,maxGain:.18,collisionMinImpact:.15,rollingEnabled:!0,rollingGain:.012,rollingFreq:120,rollingMinVelocity:14,rollingMaxVelocity:85,whooshEnabled:!1}};let p="woodenDiscs",f=null,b=null,y=null,v=null,M=null,x=null,S=null,w=!1,E=!1,I=[],C=0,T=new Map,P=!1,B=null,R=null,k=null,_=null,A=null,L=null,G=0;function D(){if("undefined"!=typeof window&&window.matchMedia){const e=window.matchMedia("(prefers-reduced-motion: reduce)");P=e.matches,e.addEventListener("change",e=>{P=e.matches})}console.log("‚úì Sound engine initialized (awaiting user unlock)")}async function F(){if(E)return!0;try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API not supported"),!1;f=new e({latencyHint:"interactive",sampleRate:44100}),"suspended"===f.state&&await f.resume(),function(){b=f.createGain(),b.gain.value=h.masterGain,x=f.createDynamicsCompressor(),x.threshold.value=-3,x.knee.value=6,x.ratio.value=12,x.attack.value=.001,x.release.value=.1,S=f.createWaveShaper(),S.curve=function(e=.8){const t=1024,n=new Float32Array(t),a=1+8*e;for(let e=0;e<t;e++){const o=2*e/(t-1)-1;n[e]=Math.tanh(a*o)/Math.tanh(a)}return n}(.85),S.oversample="2x",v=f.createGain(),v.gain.value=1-h.reverbWetMix,M=f.createGain(),M.gain.value=h.reverbWetMix,y=function(){const e=f.createGain(),t=f.createGain(),n=[.029,.037,.053,.067].map(e=>{const t=f.createDelay(.1);return t.delayTime.value=e*h.reverbDecay,t}),a=n.map(()=>{const e=f.createGain();return e.gain.value=.4,e}),o=f.createBiquadFilter();return o.type="lowpass",o.frequency.value=2e3*(1-h.reverbHighDamp),o.Q.value=.5,n.forEach((t,i)=>{e.connect(t),t.connect(a[i]),a[i].connect(o),a[i].connect(n[(i+1)%n.length])}),o.connect(t),e.connect(t),e._output=t,e}();const e=y?._output||y;v.connect(S),M.connect(y),e.connect(S),S.connect(x),x.connect(b),b.connect(f.destination),function(){I=[];for(let e=0;e<8;e++){const t={id:e,inUse:!1,startTime:0,filter:f.createBiquadFilter(),envelope:f.createGain(),panner:f.createStereoPanner(),reverbSend:f.createGain(),osc:null,osc2:null,harmGain:null};t.filter.type="lowpass",t.filter.connect(t.envelope),t.envelope.connect(t.panner),t.panner.connect(v),t.panner.connect(t.reverbSend),t.reverbSend.connect(M),I.push(t)}}(),function(){if(h.rollingEnabled){B=f.createOscillator(),B.type="triangle",B.frequency.value=h.rollingFreq;const e=f.createGain();e.gain.value=.3;const t=q(),n=f.createGain();n.gain.value=.7,k=f.createBiquadFilter(),k.type="bandpass",k.frequency.value=350,k.Q.value=.8,R=f.createGain(),R.gain.value=0,B.connect(e),e.connect(k),t.connect(n),n.connect(k),k.connect(R),R.connect(v),B.start()}h.whooshEnabled&&(_=q(),L=f.createBiquadFilter(),L.type="bandpass",L.frequency.value=h.whooshFreq,L.Q.value=.8,A=f.createGain(),A.gain.value=0,_.connect(L),L.connect(A),A.connect(v))}()}(),E=!0,w=!0;const t=1e3*(f.baseLatency||0);return console.log(`‚úì Audio unlocked (${t.toFixed(1)}ms base latency)`),!0}catch(e){return console.error("Failed to unlock audio:",e),!1}}function q(){const e=2*f.sampleRate,t=f.createBuffer(1,e,f.sampleRate),n=t.getChannelData(0);for(let t=0;t<e;t++)n[t]=2*Math.random()-1;const a=f.createBufferSource();return a.buffer=t,a.loop=!0,a.start(),a}function N(e,t,n=.5,a=null){if(!w||!E||!f)return;if(P)return;if(t<h.collisionMinImpact)return;const o=f.currentTime;if(o-C<.005)return;if(null!==a){if(o-(T.get(a)||0)<h.minTimeBetweenSounds)return;T.set(a,o)}if(C=o,T.size>200){const e=o-.5;for(const[t,n]of T)n<e&&T.delete(t)}const i=function(){for(const e of I)if(!e.inUse)return e;let e=I[0];for(const t of I)t.startTime<e.startTime&&(e=t);return O(e),e}();i&&function(e,t,n,a,o){e.inUse=!0,e.startTime=o;let i=h.minGain+(h.maxGain-h.minGain)*n,l=h.filterBaseFreq+h.filterVelocityRange*n;const s=h.decayTime+.015,r=1-.5*n,c=2*(a-.5)*h.maxPan;({gain:i,filterFreq:l}=function(e,t,n){const a=W((e-h.toneSafetyMinHz)/(h.toneSafetyMaxHz-h.toneSafetyMinHz),0,1),o=h.toneSafetyExponent,i=Math.pow(a,o),l=Math.pow(1-a,o);let s=t*W(1-h.toneSafetyHighGainAtten*i-h.toneSafetyLowGainAtten*l,.6,1),r=n*W(1-h.toneSafetyHighBrightAtten*i,.55,1);return r=W(r,h.filterMinHz,h.filterMaxHz),s=Math.min(s,h.voiceGainMax),{gain:s,filterFreq:r}}(t,i,l)),e.filter.frequency.value=l,e.filter.Q.value=h.filterQ,e.panner.pan.value=c,e.reverbSend.gain.value=r,e.envelope.gain.cancelScheduledValues(o),e.envelope.gain.setValueAtTime(i,o),e.envelope.gain.exponentialRampToValueAtTime(.001,o+h.decayTime);const d=f.createOscillator();d.type="sine",d.frequency.value=t;const u=f.createOscillator();u.type="sine",u.frequency.value=2*t;const m=f.createGain();m.gain.value=h.harmonicGain,e.osc=d,e.osc2=u,e.harmGain=m,d.connect(e.filter),u.connect(m),m.connect(e.filter),d.start(o),u.start(o),d.stop(o+s),u.stop(o+s),d.onended=()=>O(e)}(i,function(e){const t=(1-Math.max(0,Math.min(1,(e-8)/47)))*(m.length-1),n=1.5*(Math.random()-.5),a=Math.max(0,Math.min(m.length-1,Math.round(t+n))),o=1+.06*(Math.random()-.5);return m[a]*o}(e),Math.max(0,Math.min(1,t)),n,o)}function O(e){if(e.osc){try{e.osc.stop(),e.osc.disconnect()}catch(e){}e.osc=null}if(e.osc2){try{e.osc2.stop(),e.osc2.disconnect()}catch(e){}e.osc2=null}if(e.harmGain){try{e.harmGain.disconnect()}catch(e){}e.harmGain=null}e.inUse=!1}function W(e,t,n){return Math.max(t,Math.min(n,e))}function V(){return!!E&&(w=!w,w)}function $(){return{isUnlocked:E,isEnabled:w,activeSounds:I.filter(e=>e.inUse).length,poolSize:8,rollingEnergy:G,whooshEnergy:0}}function H(){return{...h}}function K(e){for(const[t,n]of Object.entries(e))t in h&&(h[t]=n);M&&v&&"reverbWetMix"in e&&(M.gain.value=h.reverbWetMix,v.gain.value=1-h.reverbWetMix),b&&"masterGain"in e&&(b.gain.value=h.masterGain)}function z(){return p}const X=new Map;function U(e=10){const t=o(),a=t.balls,i=function(){const e=o(),t=e.balls,a=e.canvas,i=e.R_MAX,l=t.length;if(l<2)return[];const s=Math.max(1,2*i),r=Math.ceil(a.width/s)+1;X.clear();for(let e=0;e<l;e++){const n=t[e],a=n.x/s|0,o=(n.y/s|0)*r+a;let i=X.get(o);i||(i=[],X.set(o,i)),i.push(e)}const c=[];for(const[e,a]of X){const o=e/r|0,i=e%r;for(let e=-1;e<=1;e++)for(let l=-1;l<=1;l++){const s=(o+e)*r+(i+l),d=X.get(s);if(d)for(let e=0;e<a.length;e++){const o=a[e];for(let e=0;e<d.length;e++){const a=d[e];if(a<=o)continue;const i=t[o],l=t[a],s=l.x-i.x,r=l.y-i.y,u=i.r+l.r,m=s*s+r*r;if(m<u*u){const e=u-Math.sqrt(Math.max(m,n.MIN_DISTANCE_EPSILON));c.push({i:o,j:a,overlap:e})}}}}}return c.sort((e,t)=>t.overlap-e.overlap),c}(),l=t.REST,s=.5*t.DPR;for(let o=0;o<e;o++)for(let e=0;e<i.length;e++){const{i:r,j:c}=i[e],d=a[r],u=a[c];if(d.isSleeping&&u.isSleeping)continue;d.isSleeping&&d.wake(),u.isSleeping&&u.wake();const m=u.x-d.x,h=u.y-d.y,g=d.r+u.r,p=m*m+h*h;if(0===p||p>g*g)continue;const f=Math.sqrt(p),b=m/f,y=h/f,v=g-f,M=1/Math.max(d.m,.001),x=1/Math.max(u.m,.001),S=.8*Math.max(v-s,0)/(M+x),w=S*b,E=S*y;d.x-=w*M,d.y-=E*M,u.x+=w*x,u.y+=E*x;const I=u.vx-d.vx,C=u.vy-d.vy,T=I*b+C*y;if(T<0){const e=-(1+(Math.abs(T)<30?0:l))*T/(M+x),a=e*b,i=e*y;d.vx-=a*M,d.vy-=i*M,u.vx+=a*x,u.vy+=i*x;const s=I-T*b,c=C-T*y,m=Math.hypot(s,c);if(m>.001){const e=s*-y+c*b>=0?1:-1,t=n.SPIN_GAIN_TANGENT;d.omega-=e*t*m/Math.max(d.r,1),u.omega+=e*t*m/Math.max(u.r,1)}const h=Math.min(1,Math.abs(T)/(50*(d.r+u.r))),g=Math.min(t.getSquashMax(),.8*h);d.squashAmount=Math.max(d.squashAmount,.8*g),d.squashNormalAngle=Math.atan2(-y,-b),u.squashAmount=Math.max(u.squashAmount,.8*g),u.squashNormalAngle=Math.atan2(y,b),0===o&&N((d.r+u.r)/2,h,(d.x+u.x)/2/(t.canvas?.width||1),`${r}-${e}`)}}}const Y=12;let j=0;class Q{constructor(){this.deformations=new Float32Array(Y),this.velocities=new Float32Array(Y)}impact(e,t){const n=o(),a=Math.max(0,Math.min(.45,n.wallWobbleCornerClamp??.1)),i=11*Math.max(a,Math.min(1-a,e)),l=(n.wallWobbleMaxDeform??30)*t,s=Math.max(.25,n.wallWobbleSigma??2);for(let e=1;e<11;e++){const t=Math.abs(e-i),n=Math.exp(-t*t/(2*s*s)),a=Math.min(e,11-e),o=Math.min(1,a/2);this.velocities[e]+=l*n*o}}step(e){const t=o(),n=Math.max(1,t.wallWobbleStiffness??400),a=Math.max(0,t.wallWobbleDamping??18),i=Math.max(0,t.wallWobbleMaxDeform??30);this.deformations[0]=0,this.deformations[11]=0,this.velocities[0]=0,this.velocities[11]=0;for(let t=1;t<11;t++){const o=-n*this.deformations[t]-a*this.velocities[t];this.velocities[t]+=o*e,this.deformations[t]+=this.velocities[t]*e,this.deformations[t]=Math.max(0,Math.min(i,this.deformations[t])),Math.abs(this.deformations[t])<.05&&Math.abs(this.velocities[t])<.1&&(this.deformations[t]=0,this.velocities[t]=0)}}getDeformAt(e){const t=11*Math.max(0,Math.min(1,e)),n=Math.floor(t),a=Math.min(n+1,11),o=t-n,i=o*o*(3-2*o);return this.deformations[n]*(1-i)+this.deformations[a]*i}getMaxDeformation(){let e=0;for(let t=0;t<Y;t++)this.deformations[t]>e&&(e=this.deformations[t]);return e}hasDeformation(){return this.getMaxDeformation()>.1}reset(){this.deformations.fill(0),this.velocities.fill(0)}}const J={top:new Q,bottom:new Q,left:new Q,right:new Q,step(e){this.top.step(e),this.bottom.step(e),this.left.step(e),this.right.step(e);const t=o(),n=Math.max(0,t.wallBounceHighlightDecay??5);j=Math.max(0,j-n*e),ee()},reset(){this.top.reset(),this.bottom.reset(),this.left.reset(),this.right.reset(),j=0,ee()},hasAnyDeformation(){return this.top.hasDeformation()||this.bottom.hasDeformation()||this.left.hasDeformation()||this.right.hasDeformation()}};function Z(e,t,n){if(e.startsWith("corner"))return;const a=o();if(n<Math.max(0,Math.min(1,a.wallWobbleImpactThreshold??.05)))return;const i=a.wallBounceHighlightMax||.3;j=Math.min(i,j+.5*n),"top"===e?J.top.impact(t,n):"bottom"===e?J.bottom.impact(t,n):"left"===e?J.left.impact(t,n):"right"===e&&J.right.impact(t,n)}function ee(){const e=document.documentElement;e&&e.style.setProperty("--wall-bounce-intensity",String(j))}let te=0;class ne{constructor(e,t,n,a){const i=o();this.x=e,this.y=t,this.vx=200*(2*Math.random()-1),this.vy=200*-Math.random(),this.r=n,this.rBase=n,this.m=i.ballMassKg,this.color=a,this.t=0,this.age=0,this.driftAx=0,this.driftTime=0,this.omega=0,this.squash=1,this.squashDirX=1,this.squashDirY=0,this.theta=0,this.squashAmount=0,this.squashNormalAngle=0,this.alpha=1,this.isSleeping=!1,this.sleepTimer=0,this._soundId="ball-"+te++}step(e,a){const i=o(),{currentMode:l,G:s,gravityScale:r,FRICTION:c,MASS_BASELINE_KG:d}=i;if(this.t+=e,this.age+=e,this.isSleeping&&l===t.PIT){const e=i.mouseX,t=i.mouseY,n=(i.repelRadius||710)*i.DPR*1.2,a=this.x-e,o=this.y-t;a*a+o*o<n*n&&this.wake()}if(this.isSleeping)return;l!==t.WEIGHTLESS&&(this.vy+=s*r*e);const u=Math.max(.25,this.m/d),m=l===t.WEIGHTLESS?1e-4:c,h=Math.max(0,1-m/u);this.vx*=h,this.vy*=h,0!==this.driftAx&&this.age<this.driftTime?this.vx+=this.driftAx*e/u:0!==this.driftAx&&(this.driftAx=0),a&&a(this,e),this.x+=this.vx*e,this.y+=this.vy*e;const g=Math.max(0,1-n.SPIN_DAMP_PER_S*e);this.omega*=g,this.theta+=this.omega*e;const p=Math.min(1,n.SQUASH_DECAY_PER_S*e);this.squashAmount+=(0-this.squashAmount)*p,this.squash=1-this.squashAmount,l===t.PIT&&this.updateSleepState(e,i)}updateSleepState(e,t){const a=Math.sqrt(this.vx*this.vx+this.vy*this.vy),o=Math.abs(this.omega),i=t.canvas;i&&this.y+this.r>=i.height-1&&a<n.SLEEP_VELOCITY_THRESHOLD&&o<n.SLEEP_ANGULAR_THRESHOLD?(this.sleepTimer+=e,this.sleepTimer>=n.TIME_TO_SLEEP&&(this.vx=0,this.vy=0,this.omega=0,this.isSleeping=!0)):this.sleepTimer=0}wake(){this.isSleeping=!1,this.sleepTimer=0}walls(e,a,i,l){const s=o(),{REST:r,MASS_BASELINE_KG:c,MASS_REST_EXP:d,currentMode:u,DPR:m}=s,h=void 0!==l?l:r,g=u===t.PIT?a/3:0,p=(s.getCanvasCornerRadius()||100)*(m||1);let f=!1;const b=[{cx:p,cy:g+p},{cx:e-p,cy:g+p},{cx:p,cy:a-p},{cx:e-p,cy:a-p}];for(let t=0;t<b.length;t++){const n=b[t],o=t%2==0?this.x<p:this.x>e-p,i=t<2?this.y<g+p:this.y>a-p;if(o&&i){const e=this.x-n.cx,t=this.y-n.cy,a=Math.sqrt(e*e+t*t),o=p-this.r;if(a>o&&o>0){f=!0;const n=a-o,i=e/a,l=t/a;this.x-=i*n,this.y-=l*n;const s=this.vx*i+this.vy*l;s>0&&(this.vx-=(1+h)*s*i,this.vy-=(1+h)*s*l)}}}const y=e-0,v=g+0,M=a-0;if(this.y+this.r>M){f=!0,this.y=M-this.r;const t=this.vy,a=this.vx-this.omega*this.r,o=Math.max(.25,this.m/c);this.omega+=a/this.r*n.SPIN_GAIN/o;const l=Math.max(0,1-n.ROLL_FRICTION_PER_S*i/o);this.vx*=l;const r=Math.abs(t)<n.WALL_REST_VEL_THRESHOLD?0:h;this.vy=-this.vy*(r*Math.pow(c/this.m,d));const u=Math.min(1,Math.abs(t)/(90*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*u),this.squashNormalAngle=-Math.PI/2;const m=this.vx/this.r;this.omega+=(m-this.omega)*Math.min(1,n.GROUND_COUPLING_PER_S*i),N(this.r,.7*u,this.x/e,this._soundId),Z("bottom",this.x/e,u)}if(this.y-this.r<v){f=!0,this.y=v+this.r,this.vy=-this.vy*h;const t=Math.min(1,Math.abs(this.vy)/(90*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*t),this.squashNormalAngle=Math.PI/2,N(this.r,.6*t,this.x/e,this._soundId),Z("top",this.x/e,t)}if(this.x+this.r>y){f=!0,this.x=y-this.r;const e=this.vx,t=this.vy-this.omega*this.r,o=Math.max(.25,this.m/c);this.omega+=t/this.r*(.5*n.SPIN_GAIN)/o,this.vx=-this.vx*(r*Math.pow(c/this.m,d));const i=Math.min(1,Math.abs(e)/(70*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*i),this.squashNormalAngle=Math.PI,N(this.r,.6*i,1,this._soundId),Z("right",(this.y-g)/(a-g),i)}if(this.x-this.r<0){f=!0,this.x=0+this.r;const e=this.vx,t=this.vy-this.omega*this.r,o=Math.max(.25,this.m/c);this.omega+=t/this.r*(.5*n.SPIN_GAIN)/o,this.vx=-this.vx*(r*Math.pow(c/this.m,d));const i=Math.min(1,Math.abs(e)/(70*this.r));this.squashAmount=Math.min(s.getSquashMax(),.8*i),this.squashNormalAngle=0,N(this.r,.6*i,0,this._soundId),Z("left",(this.y-g)/(a-g),i)}f&&this.isSleeping&&this.wake()}draw(e){if(e.save(),e.translate(this.x,this.y),e.rotate(this.theta),this.squashAmount>.001){const t=1-.3*this.squashAmount,n=1+.3*this.squashAmount;e.rotate(this.squashNormalAngle),e.scale(t,n),e.rotate(-this.squashNormalAngle)}e.beginPath(),e.arc(0,0,this.r,0,2*Math.PI),e.fillStyle=this.color,e.globalAlpha=this.alpha,e.fill(),e.globalAlpha=1,e.restore()}}const ae=[];function oe(e,t){const n=o(),a=n.waterDrag||.015;e.vx*=1-a,e.vy*=1-a,e.omega*=1-.5*a;for(let n=0;n<ae.length;n++){const a=ae[n],o=e.x-a.x,i=e.y-a.y,l=Math.sqrt(o*o+i*i),s=40,r=a.radius-s,c=a.radius+s;if(l>r&&l<c){const n=Math.abs(l-a.radius),r=a.strength*(1-n/s);if(l>.1){const n=o/l,a=i/l;e.vx+=n*r*t,e.vy+=a*r*t}}}const i=n.waterDriftStrength||25;e.vx+=Math.sin(.5*e.t+.01*e.x)*i*t,e.vy+=Math.cos(.7*e.t+.01*e.y)*i*t}function ie(e,t,n=1){const a=(o().waterRippleStrength||15e3)*Math.min(n,5);ae.push({x:e,y:t,radius:0,strength:a,age:0})}const le=n.PHYSICS_DT;let se=0;const re=42;function ce(e,t){const n=[{x:re,y:re},{x:t.width-re,y:re},{x:re,y:t.height-re},{x:t.width-re,y:t.height-re}];for(let t=0;t<n.length;t++){const a=n[t].x,o=n[t].y,i=e.x-a,l=e.y-o,s=Math.max(1,Math.hypot(i,l));if(s<re+e.r){const t=(re+e.r-s)/(re+e.r)*1800,n=i/s,a=l/s;e.vx+=n*t*le,e.vy+=a*t*le}}}let de,ue,me="light",he="light";function ge(e,t){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t}function pe(e){me=e;let t=!1;t="auto"===e?"dark"===he:"dark"===e,function(e){const t=o();t.isDarkMode=e,document.documentElement.style.colorScheme=e?"dark":"light",e?(t.container?.classList.add("dark-mode"),document.body.classList.add("dark-mode"),document.documentElement.classList.add("dark-mode")):(t.container?.classList.remove("dark-mode"),document.body.classList.remove("dark-mode"),document.documentElement.classList.remove("dark-mode")),function(e){const t=ge("--chrome-bg-light","#0a0a0a"),n=ge("--chrome-bg-dark","#0a0a0a"),a=e?n:t;let o=document.querySelector('meta[name="theme-color"]');o||(o=document.createElement("meta"),o.name="theme-color",document.head.appendChild(o)),o.content=a;let i=document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: light)"]');i||(i=document.createElement("meta"),i.name="theme-color",i.media="(prefers-color-scheme: light)",document.head.appendChild(i)),i.content=t;let l=document.querySelector('meta[name="theme-color"][media="(prefers-color-scheme: dark)"]');l||(l=document.createElement("meta"),l.name="theme-color",l.media="(prefers-color-scheme: dark)",document.head.appendChild(l)),l.content=n}(e),d(t.currentTemplate),function(){const e=document.getElementById("themeAuto"),t=document.getElementById("themeLight"),n=document.getElementById("themeDark");if(!e||!t||!n)return;[e,t,n].forEach(e=>e.classList.remove("active")),"auto"===me?e.classList.add("active"):"light"===me?t.classList.add("active"):n.classList.add("active");const a=document.getElementById("themeStatus");if(a){const e=o();a.textContent="auto"===me?e.isDarkMode?"üåô Auto (Dark)":"‚òÄÔ∏è Auto (Light)":"light"===me?"‚òÄÔ∏è Light Mode":"üåô Dark Mode"}}()}(t);try{localStorage.setItem("theme-preference",e)}catch(e){}console.log(`üé® Theme set to: ${e} (rendering: ${t?"dark":"light"})`)}function fe(){he=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",console.log(`üñ•Ô∏è System prefers: ${he}`),pe("light");const e=document.getElementById("themeAuto"),t=document.getElementById("themeLight"),n=document.getElementById("themeDark");e&&e.addEventListener("click",()=>pe("auto")),t&&t.addEventListener("click",()=>pe("light")),n&&n.addEventListener("click",()=>pe("dark")),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{he=e.matches?"dark":"light",console.log(`üñ•Ô∏è System preference changed to: ${he}`),"auto"===me&&pe("auto")}),console.log("‚úì Modern dark mode initialized")}function be(){return me}function ye(){de=document.getElementById("c"),ue=de?de.getContext("2d"):null,de&&ue?window.addEventListener("resize",ve):console.error("Canvas not found")}function ve(){if(!de)return;const e=o().container||document.getElementById("bravia-balls"),t=e?e.clientWidth:window.innerWidth,a=e?e.clientHeight:window.innerHeight,i=n.DPR;de.width=Math.floor(t*i),de.height=Math.floor(a*i),de.style.width=t+"px",de.style.height=a+"px",function(e){const t=o();if(!t.canvasShadowEnabled)return void(e.style.filter="");const n=t.shadowOffsetX||1,a=t.shadowOffsetY||1,i=t.shadowBlur||0,l=t.shadowColor||"#000000",s=t.shadowOpacity||.29,r=t.shadow2Enabled?` drop-shadow(0 0 ${t.shadow2Blur||4}px rgba(0,0,0,${t.shadow2Opacity||.1}))`:"";e.style.filter=`drop-shadow(${n}px ${a}px ${i}px ${function(e,t){const n=e.replace("#",""),a=parseInt(n,16);return`rgba(${a>>16&255}, ${a>>8&255}, ${255&a}, ${t})`}(l,s)})${r}`}(de)}function Me(){return de}function xe(){return ue}function Se(){console.log("‚ö†Ô∏è localStorage is disabled")}function we(){clearTimeout(window.settingsSaveTimeout),window.settingsSaveTimeout=setTimeout(Se,500)}let Ee=null,Ie={};function Ce(e){return!1!==Ie[e]}!function(){try{const e=localStorage.getItem("panel_control_visibility");e&&(Ie=JSON.parse(e))}catch(e){Ie={}}}();const Te={global:{title:"Global Properties",icon:"üé±",defaultOpen:!0,controls:[{id:"sizeGlobal",label:"Size",stateKey:"sizeScale",type:"range",min:.1,max:6,step:.05,default:1.2,format:e=>e.toFixed(2),parse:parseFloat,onChange:(e,t)=>{const n=(e.R_MIN_BASE+e.R_MAX_BASE)/2;e.R_MIN=n*t*.75,e.R_MAX=n*t*1.25;const a=(e.R_MIN+e.R_MAX)/2;e.balls.forEach(e=>{e.r=a,e.rBase=a})}},{id:"ballSoftnessGlobal",label:"Softness",stateKey:"ballSoftness",type:"range",min:0,max:100,step:1,default:20,format:e=>String(e),parse:e=>parseInt(e,10)}]},walls:{title:"Frame & Walls",icon:"üñºÔ∏è",defaultOpen:!1,controls:[{id:"frameColor",label:"Frame Color",stateKey:"frameColor",type:"color",default:"#0a0a0a",hint:"Browser chrome + walls + border (debug)",onChange:(e,t)=>{const n=document.documentElement;n.style.setProperty("--frame-color-light",t),n.style.setProperty("--frame-color-dark",t),n.style.setProperty("--wall-color",t),n.style.setProperty("--chrome-bg",t),n.style.setProperty("--chrome-bg-light",t),n.style.setProperty("--chrome-bg-dark",t);const a=document.querySelector('meta[name="theme-color"]');a&&(a.content=t)}},{id:"wallThickness",label:"Frame Thickness",stateKey:"wallThickness",type:"range",min:0,max:60,step:1,default:20,format:e=>String(e),parse:e=>parseInt(e,10),hint:"Unified: wall tubes + body border",onChange:(e,t)=>{e.wallThickness=t,e.containerBorder=t;const n=document.documentElement;n.style.setProperty("--wall-thickness",t+"px"),n.style.setProperty("--container-border",t+"px"),ve()}},{id:"wallSoftness",label:"Glow Softness",stateKey:"wallSoftness",group:"Frame Geometry",type:"range",min:0,max:60,step:1,default:20,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--wall-softness"},{id:"wallRadius",label:"Corner Radius",stateKey:"wallRadius",group:"Frame Geometry",type:"range",min:0,max:80,step:2,default:42,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--wall-radius",onChange:(e,t)=>{e.wallRadius=t,e.cornerRadius=t}},{id:"wallBounceHighlight",label:"Bounce Flash",stateKey:"wallBounceHighlightMax",group:"Bounce Flash",type:"range",min:0,max:1,step:.05,default:.3,format:e=>e.toFixed(2),parse:parseFloat},{id:"wallWobbleMaxDeform",label:"Wobble Strength",stateKey:"wallWobbleMaxDeform",group:"Rubber Wobble",type:"range",min:0,max:80,step:1,default:30,format:e=>`${e}px`,parse:e=>parseInt(e,10),hint:"Max inward bulge (visual only)"},{id:"wallWobbleStiffness",label:"Return Speed",stateKey:"wallWobbleStiffness",group:"Rubber Wobble",type:"range",min:50,max:1200,step:10,default:400,format:e=>String(e),parse:e=>parseInt(e,10),hint:"Higher = snappier return"},{id:"wallWobbleDamping",label:"Damping",stateKey:"wallWobbleDamping",group:"Rubber Wobble",type:"range",min:0,max:80,step:1,default:18,format:e=>String(e),parse:e=>parseInt(e,10),hint:"Higher = less oscillation"},{id:"wallWobbleSigma",label:"Impact Spread",stateKey:"wallWobbleSigma",group:"Rubber Wobble",type:"range",min:.5,max:4,step:.1,default:2,format:e=>e.toFixed(1),parse:parseFloat,hint:"How wide the bulge travels along the wall"},{id:"wallWobbleCornerClamp",label:"Corner Stickiness",stateKey:"wallWobbleCornerClamp",group:"Rubber Wobble",type:"range",min:0,max:.3,step:.01,default:.1,format:e=>e.toFixed(2),parse:parseFloat,hint:"0 = corners wobble, higher = corners pinned"},{id:"wallWobbleImpactThreshold",label:"Min Impact",stateKey:"wallWobbleImpactThreshold",group:"Rubber Wobble",type:"range",min:0,max:.2,step:.01,default:.05,format:e=>e.toFixed(2),parse:parseFloat,hint:"Ignore tiny taps"},{id:"wallBounceHighlightDecay",label:"Flash Decay",stateKey:"wallBounceHighlightDecay",group:"Bounce Flash",type:"range",min:0,max:12,step:.5,default:5,format:e=>e.toFixed(1),parse:parseFloat,hint:"Higher = flash fades faster"}]},effects:{title:"Effects",icon:"üé≠",defaultOpen:!1,controls:[{id:"noiseSizeBase",label:"Noise Back Size",stateKey:"noiseSizeBase",group:"Noise Texture",type:"range",min:50,max:200,step:5,default:100,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--noise-size-base"},{id:"noiseSizeTop",label:"Noise Front Size",stateKey:"noiseSizeTop",type:"range",min:40,max:150,step:5,default:80,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--noise-size-top"},{id:"noiseBackOpacity",label:"Noise Back Opacity",stateKey:"noiseBackOpacity",type:"range",min:0,max:.1,step:.001,default:.015,format:e=>e.toFixed(3),parse:parseFloat,cssVar:"--noise-back-opacity"},{id:"noiseFrontOpacity",label:"Noise Front Opacity",stateKey:"noiseFrontOpacity",type:"range",min:0,max:.05,step:.001,default:.01,format:e=>e.toFixed(3),parse:parseFloat,cssVar:"--noise-front-opacity"},{id:"vignetteLightIntensity",label:"Light Intensity",stateKey:"vignetteLightIntensity",group:"Vignette",type:"range",min:0,max:1,step:.01,default:.08,format:e=>e.toFixed(2),parse:parseFloat,cssVar:"--vignette-light-intensity"},{id:"vignetteDarkIntensity",label:"Dark Intensity",stateKey:"vignetteDarkIntensity",type:"range",min:0,max:1,step:.01,default:.05,format:e=>e.toFixed(2),parse:parseFloat,cssVar:"--vignette-dark-intensity"},{id:"vignetteBlurOuter",label:"Outer Blur",stateKey:"vignetteBlurOuter",type:"range",min:0,max:400,step:10,default:180,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-blur-outer"},{id:"vignetteBlurMid",label:"Mid Blur",stateKey:"vignetteBlurMid",type:"range",min:0,max:300,step:10,default:100,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-blur-mid"},{id:"vignetteBlurInner",label:"Inner Blur",stateKey:"vignetteBlurInner",type:"range",min:0,max:200,step:5,default:40,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-blur-inner"},{id:"vignetteSpread",label:"Spread",stateKey:"vignetteSpread",type:"range",min:-50,max:50,step:1,default:0,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-spread"},{id:"vignetteX",label:"Offset X",stateKey:"vignetteX",type:"range",min:-100,max:100,step:1,default:0,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-x"},{id:"vignetteY",label:"Offset Y",stateKey:"vignetteY",type:"range",min:-100,max:100,step:1,default:0,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-y"},{id:"vignetteTransition",label:"Animation",stateKey:"vignetteTransition",type:"range",min:0,max:2e3,step:50,default:800,format:e=>String(e),parse:e=>parseInt(e,10),cssVar:"--vignette-transition"}]},pit:{title:"Ball Pit Settings",icon:"üéØ",mode:"pit",defaultOpen:!0,controls:[{id:"gravityPit",label:"Gravity",stateKey:"gravityMultiplierPit",type:"range",min:0,max:2,step:.05,default:1.1,format:e=>e.toFixed(2),parse:parseFloat,onChange:(e,t)=>{"pit"===e.currentMode&&(e.G=e.GE*t)}},{id:"weightPit",label:"Weight",stateKey:"ballMassKg",type:"range",min:10,max:200,step:1,default:129,format:e=>e.toFixed(0),parse:parseFloat,onChange:(e,t)=>{e.balls.forEach(e=>{e.m=t})}},{id:"restitution",label:"Bounciness",stateKey:"REST",type:"range",min:0,max:1,step:.01,default:.69,format:e=>e.toFixed(2),parse:parseFloat},{id:"friction",label:"Air Friction",stateKey:"FRICTION",type:"range",min:0,max:.01,step:5e-4,default:.006,format:e=>e.toFixed(4),parse:parseFloat},{id:"repelSize",label:"Repel Size",stateKey:"repelRadius",type:"range",min:50,max:1e3,step:5,default:120,format:e=>e.toFixed(0),parse:parseFloat},{id:"repelPower",label:"Repel Power",stateKey:"repelPower",type:"range",min:0,max:1e4,step:100,default:8500,format:e=>Math.round(e).toString(),parse:parseFloat,onChange:(e,t)=>{const n=Math.max(0,Math.min(1e4,t))/1e4;e.repelPower=12e3*Math.pow(2,12*(n-.5))*2}}]},flies:{title:"Flies Settings",icon:"üïäÔ∏è",mode:"flies",defaultOpen:!0,controls:[{id:"fliesBallCount",label:"Ball Count",stateKey:"fliesBallCount",type:"range",min:20,max:150,step:5,default:60,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"attractPower",label:"Attraction",stateKey:"attractionPower",type:"range",min:100,max:8e3,step:50,default:5e3,format:e=>Math.round(e).toString(),parse:parseFloat},{id:"swarmSpeed",label:"Swarm Speed",stateKey:"swarmSpeed",type:"range",min:.2,max:5,step:.1,default:.4,format:e=>e.toFixed(1),parse:parseFloat},{id:"fliesSeparation",label:"Separation",stateKey:"fliesSeparation",type:"range",min:5e3,max:3e4,step:1e3,default:15e3,format:e=>Math.round(e).toString(),parse:parseFloat}]},weightless:{title:"Zero-G Settings",icon:"üåå",mode:"weightless",defaultOpen:!0,controls:[{id:"weightlessCount",label:"Ball Count",stateKey:"weightlessBallCount",type:"range",min:20,max:200,step:10,default:80,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"weightlessSpeed",label:"Initial Speed",stateKey:"weightlessInitialSpeed",type:"range",min:100,max:600,step:25,default:250,format:e=>e.toFixed(0),parse:parseFloat,reinitMode:!0},{id:"weightlessBounce",label:"Bounce",stateKey:"weightlessBounce",type:"range",min:.5,max:1,step:.05,default:.95,format:e=>e.toFixed(2),parse:parseFloat}]},water:{title:"Water Settings",icon:"üåä",mode:"water",defaultOpen:!0,controls:[{id:"waterBallCount",label:"Ball Count",stateKey:"waterBallCount",type:"range",min:50,max:400,step:10,default:300,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"waterRippleStrength",label:"Ripple Strength",stateKey:"waterRippleStrength",type:"range",min:5e3,max:3e4,step:1e3,default:18e3,format:e=>e.toFixed(0),parse:parseFloat},{id:"waterMotion",label:"Motion",stateKey:"waterDriftStrength",type:"range",min:0,max:80,step:1,default:40,format:e=>e.toFixed(0),parse:parseFloat,onChange:(e,t)=>{e.waterInitialVelocity=5*t},reinitMode:!0}]},vortex:{title:"Vortex Settings",icon:"üåÄ",mode:"vortex",defaultOpen:!0,controls:[{id:"vortexBallCount",label:"Ball Count",stateKey:"vortexBallCount",type:"range",min:50,max:300,step:10,default:180,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"vortexSwirl",label:"Swirl Strength",stateKey:"vortexSwirlStrength",type:"range",min:100,max:800,step:20,default:420,format:e=>e.toFixed(0),parse:parseFloat},{id:"vortexPull",label:"Radial Pull",stateKey:"vortexRadialPull",type:"range",min:0,max:400,step:10,default:180,format:e=>e.toFixed(0),parse:parseFloat}]},"ping-pong":{title:"Ping Pong Settings",icon:"üèì",mode:"ping-pong",defaultOpen:!0,controls:[{id:"pingPongBallCount",label:"Ball Count",stateKey:"pingPongBallCount",type:"range",min:10,max:100,step:5,default:35,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"pingPongSpeed",label:"Ball Speed",stateKey:"pingPongSpeed",type:"range",min:200,max:1200,step:50,default:800,format:e=>e.toFixed(0),parse:parseFloat,reinitMode:!0},{id:"pingPongCursor",label:"Cursor Size",stateKey:"pingPongCursorRadius",type:"range",min:20,max:200,step:10,default:50,format:e=>e.toFixed(0),parse:parseFloat}]},magnetic:{title:"Magnetic Settings",icon:"üß≤",mode:"magnetic",defaultOpen:!0,controls:[{id:"magneticBallCount",label:"Ball Count",stateKey:"magneticBallCount",type:"range",min:50,max:300,step:10,default:180,format:e=>String(e),parse:e=>parseInt(e,10),reinitMode:!0},{id:"magneticStrength",label:"Strength",stateKey:"magneticStrength",type:"range",min:1e4,max:1e5,step:5e3,default:65e3,format:e=>e.toFixed(0),parse:parseFloat},{id:"magneticVelocity",label:"Max Velocity",stateKey:"magneticMaxVelocity",type:"range",min:500,max:4e3,step:100,default:2800,format:e=>e.toFixed(0),parse:parseFloat}]},bubbles:{title:"Bubbles Settings",icon:"ü´ß",mode:"bubbles",defaultOpen:!0,controls:[{id:"bubblesRate",label:"Bubble Rate",stateKey:"bubblesSpawnRate",type:"range",min:1,max:20,step:1,default:8,format:e=>String(e),parse:e=>parseInt(e,10)},{id:"bubblesSpeed",label:"Rise Speed",stateKey:"bubblesRiseSpeed",type:"range",min:50,max:400,step:25,default:150,format:e=>e.toFixed(0),parse:parseFloat},{id:"bubblesWobble",label:"Wobble",stateKey:"bubblesWobble",type:"range",min:0,max:100,step:5,default:40,format:e=>e.toFixed(0),parse:parseFloat},{id:"bubblesMax",label:"Max Bubbles",stateKey:"bubblesMaxCount",type:"range",min:50,max:300,step:10,default:150,format:e=>String(e),parse:e=>parseInt(e,10)},{id:"bubblesDeflect",label:"Cursor Deflection",stateKey:"bubblesDeflectRadius",type:"range",min:20,max:150,step:10,default:80,format:e=>e.toFixed(0),parse:parseFloat}]}};function Pe(e){if(!Ce(e.id))return"";const t=e.id+"Slider",n=e.id+"Val",a=e.id+"Picker";if("color"===e.type)return`\n      <label data-control-id="${e.id}" style="flex-direction: row; align-items: center; gap: 8px;">\n        <span style="flex: 1;">${e.label}</span>\n        <input type="color" id="${a}" value="${e.default}" style="width: 32px; height: 20px; border: 1px solid rgba(0,255,136,0.4); cursor: pointer;">\n        <span class="val" id="${n}" style="min-width: 60px; font-size: 7px;">${e.default}</span>\n      </label>${e.hint?`<div style="font-size: 7px; opacity: 0.5; margin: -6px 0 8px;">${e.hint}</div>`:""}`;const o=e.hint?`<div style="font-size: 7px; opacity: 0.5; margin: -6px 0 8px;">${e.hint}</div>`:"";return`\n      <label data-control-id="${e.id}">\n        <span>${e.label}<span class="val" id="${n}">${e.format(e.default)}</span></span>\n        <input type="range" id="${t}" min="${e.min}" max="${e.max}" step="${e.step}" value="${e.default}">\n      </label>${o}`}function Be(e,t){const n=t.controls.filter(e=>Ce(e.id));if(0===n.length)return"";let a=null,o="";for(const e of n)e.group&&e.group!==a?(null!==a&&(o+="</div>"),o+=`<div class="section-title" style="margin-top: 12px;">${e.group}</div><div class="group">`,a=e.group):e.group||null===a||(o+="</div>",a=null),o+=Pe(e);return null!==a&&(o+="</div>"),t.mode?`\n  <div id="${t.mode}Controls" class="mode-controls${"flies"===t.mode?" active":""}">\n    <details ${t.defaultOpen?"open":""}>\n      <summary>${t.icon?t.icon+" ":""}${t.title}</summary>\n      <div class="group">${o}</div>\n    </details>\n  </div>`:`\n  <details ${t.defaultOpen?"open":""}>\n    <summary>${t.icon?t.icon+" ":""}${t.title}</summary>\n    <div class="group">${o}</div>\n  </details>`}const Re=function(){let e='\n  \x3c!-- Screen reader announcements --\x3e\n  <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="announcer"></div>\n  \n  \x3c!-- Theme Segment Control --\x3e\n  <div class="panel-section">\n    <div class="section-title">üé® Theme</div>\n    <div class="theme-segment-control" role="group" aria-label="Theme selector">\n      <button id="themeAuto" class="theme-segment-btn" aria-label="Auto theme">Auto</button>\n      <button id="themeLight" class="theme-segment-btn active" aria-label="Light theme">Light</button>\n      <button id="themeDark" class="theme-segment-btn" aria-label="Dark theme">Dark</button>\n    </div>\n    <div id="themeStatus" class="panel-status">‚òÄÔ∏è Light Mode</div>\n  </div>\n  \n  \x3c!-- Mode Switcher --\x3e\n  <div class="panel-section">\n    <div class="section-title">Mode</div>\n    <div class="mode-switcher" role="group" aria-label="Simulation mode selector">\n      <button class="mode-button" data-mode="pit" aria-label="Ball Pit mode">üéØ Pit</button>\n      <button class="mode-button active" data-mode="flies" aria-label="Flies mode">üïäÔ∏è Flies</button>\n      <button class="mode-button" data-mode="weightless" aria-label="Zero-G mode">üåå Zero-G</button>\n      <button class="mode-button" data-mode="water" aria-label="Water mode">üåä Water</button>\n      <button class="mode-button" data-mode="vortex" aria-label="Vortex mode">üåÄ Vortex</button>\n      <button class="mode-button" data-mode="ping-pong" aria-label="Ping Pong mode">üèì Pong</button>\n      <button class="mode-button" data-mode="magnetic" aria-label="Magnetic mode">üß≤ Magnet</button>\n      <button class="mode-button" data-mode="bubbles" aria-label="Bubbles mode">ü´ß Bubbles</button>\n    </div>\n  </div>';for(const[t,n]of Object.entries(Te))n.mode||(e+=Be(0,n));e+='\n  <details>\n    <summary>Colors</summary>\n    <div class="group">\n      <label>\n        <span>Color Template</span>\n        <select id="colorSelect"></select>\n      </label>\n    </div>\n  </details>';for(const[t,n]of Object.entries(Te))n.mode&&(e+=Be(0,n));return e+='\n  \x3c!-- Save Config --\x3e\n  <div class="panel-section panel-section--action">\n    <button id="saveConfigBtn" class="primary">üíæ Save Config</button>\n  </div>\n  \n  \x3c!-- Keyboard shortcuts --\x3e\n  <div class="panel-footer">\n    <kbd>R</kbd> reset ¬∑ <kbd>/</kbd> panel ¬∑ click cycles modes\n  </div>',e}();function ke(e,t,n){n||(n=r());const a=o(),i=(a.R_MIN+a.R_MAX)/2;let l;if(0===a.sizeVariation)l=i;else{const e=.1*i;c=i+e,l=(s=Math.max(1,i-e))+Math.random()*(c-s)}var s,c;const d=new ne(e,t,l,n),u=e<.5*a.canvas.width?1:-1,m=(p=l/(.5*(a.R_MIN+a.R_MAX)),Math.max(.6,Math.min(1.4,p))),h=140*m,g=180*m;var p;return d.vx=u*(h+Math.random()*g),d.vy=120*-Math.random(),d.driftAx=u*(360+420*Math.random())*m,d.driftTime=.22+.28*Math.random(),a.balls.push(d),d}function _e(e,t){const n=o(),a=-1e9===n.mouseX?.5*n.canvas.width:n.mouseX,i=-1e9===n.mouseY?.5*n.canvas.height:n.mouseY,l=a-e.x,s=i-e.y,r=Math.sqrt(l*l+s*s+1),c=l/r,d=s/r;e.vx+=4e3*c*t,e.vy+=4e3*d*t;const u=120*n.DPR;let m=0,h=0,g=0;for(let t=0;t<n.balls.length;t++){const a=n.balls[t];if(a===e)continue;const o=e.x-a.x,i=e.y-a.y,l=o*o+i*i;if(l<u*u&&l>0){const e=Math.sqrt(l),t=1-e/u;m+=o/e*t,h+=i/e*t,g++}}if(g>0){const n=15e3;e.vx+=m/g*n*t,e.vy+=h/g*n*t}e.vx+=1e3*(Math.random()-.5)*t,e.vy+=1e3*(Math.random()-.5)*t}function Ae(e,t){const n=o(),a=n.repelPower,i=n.repelRadius,l=n.mouseX,s=n.mouseY;if(!n.repellerEnabled||a<=0||i<=0)return;const r=i*n.DPR,c=e.x-l,d=e.y-s,u=c*c+d*d;if(u>r*r)return;const m=Math.max(Math.sqrt(u),1e-4),h=c/m,g=d/m,p=Math.max(0,1-m/r),f=20*a*Math.pow(p,n.repelSoft||3.4),b=Math.max(.25,e.m/n.MASS_BASELINE_KG);e.vx+=h*f*t/b,e.vy+=g*f*t/b}function Le(e,n){const a=o();if(a.currentMode!==t.VORTEX)return;const i=a.mouseX,l=a.mouseY;if(!a.mouseInCanvas)return;const s=a.vortexSwirlStrength||420,r=a.vortexRadialPull||180,c=e.x-i,d=e.y-l,u=c*c+d*d,m=Math.max(8,Math.sqrt(u)),h=1/(1+.0015*m),g=c/m,p=d/m,f=-p,b=g,y=s*h;e.vx+=f*y*n,e.vy+=b*y*n;const v=r*h;e.vx-=g*v*n,e.vy-=p*v*n,e.vx*=.995,e.vy*=.995}function Ge(e,n){const a=o();if(a.currentMode!==t.PING_PONG)return;if(!e.isPingPong)return;if(a.mouseInCanvas){const t=(a.pingPongCursorRadius||100)*a.DPR,n=a.mouseX,o=a.mouseY,i=e.x-n,l=e.y-o,s=Math.sqrt(i*i+l*l),r=t+e.r;if(s<r&&s>.1){const t=r-s,n=i/s,a=l/s;e.x+=n*t*1.1,e.y+=a*t*1.1;const o=e.vx*n+e.vy*a;o<0&&(e.vx-=2*o*n,e.vy-=2*o*a,e.omega+=.02*o)}}const i=a.pingPongSpeed||400;if(Math.abs(e.vx)<.9*i){const t=e.vx>=0?1:-1;e.vx=t*i}e.vy*=.995}function De(e,n){const a=o();if(a.currentMode!==t.MAGNETIC)return;if(!a.mouseInCanvas)return;const i=a.mouseX,l=a.mouseY,s=i-e.x,r=l-e.y,c=Math.max(30,Math.sqrt(s*s+r*r)),d=(a.magneticStrength||65e3)/(c*c)*1e3,u=s/c,m=r/c,h=e.charge||1;e.vx+=u*d*h*n,e.vy+=m*d*h*n;const g=a.magneticMaxVelocity||2800,p=Math.sqrt(e.vx*e.vx+e.vy*e.vy);p>g&&(e.vx=e.vx/p*g,e.vy=e.vy/p*g),e.vx*=.998,e.vy*=.998}function Fe(e,t,n,a=!1){const i=o(),l=.5*i.R_MIN,s=.8*i.R_MAX,r=l+Math.random()*(s-l),c=new ne(e,t,a?r:.1,n);return c.isBubble=!0,c.baseRadius=r,c.targetRadius=r,c.wobblePhase=Math.random()*Math.PI*2,c.wobbleFreq=2+3*Math.random(),c.vx=20*(Math.random()-.5),c.vy=-50-50*Math.random(),c.spawning=!a,c.spawnProgress=a?1:0,c.dissipating=!1,c.dissipateProgress=0,c.alpha=1,i.balls.push(c),c}function qe(e){const t=o(),n=t.canvas;if(!n)return;const a=n.width,i=n.height;e.x=Math.random()*a,e.y=i+20+30*Math.random(),e.vx=20*(Math.random()-.5),e.vy=-50-50*Math.random(),e.wobblePhase=Math.random()*Math.PI*2,e.wobbleFreq=2+3*Math.random(),e.c=r();const l=.5*t.R_MIN,s=.8*t.R_MAX;e.targetRadius=l+Math.random()*(s-l),e.baseRadius=e.targetRadius,e.r=.1,e.spawning=!0,e.spawnProgress=0,e.dissipating=!1,e.dissipateProgress=0,e.alpha=1}function Ne(e,n){const a=o();if(a.currentMode!==t.BUBBLES)return;if(!e.isBubble)return;const i=a.canvas;if(!i)return;if(e.spawning){e.spawnProgress+=3*n;const t=1-Math.pow(1-Math.min(1,e.spawnProgress),3);e.r=e.targetRadius*t,e.rBase=e.r,e.spawnProgress>=1&&(e.spawning=!1,e.r=e.targetRadius,e.rBase=e.targetRadius)}if(e.dissipating){e.dissipateProgress+=3*n;const t=Math.pow(e.dissipateProgress,2);return e.r=e.targetRadius*Math.max(0,1-t),e.rBase=e.r,e.alpha=Math.max(0,1-.5*t),e.vy*=.92,e.vx*=.92,void(e.dissipateProgress>=1&&qe(e))}const l=a.bubblesRiseSpeed||150,s=.01*(a.bubblesWobble||40),r=l*a.DPR;e.vy-=r*n,e.wobblePhase+=e.wobbleFreq*n;const c=Math.sin(e.wobblePhase)*s*100;if(e.vx+=c*n,e.vx*=.92,e.vy*=.96,a.mouseInCanvas){const t=e.x-a.mouseX,o=e.y-a.mouseY,i=Math.sqrt(t*t+o*o),l=(a.bubblesDeflectRadius||80)*a.DPR;if(i<l&&i>1){const a=300*(1-i/l),s=t/i,r=o/i;e.vx+=s*a*n,e.vy+=r*a*n}}const d=2*e.targetRadius;e.y<d&&!e.dissipating&&!e.spawning&&(e.dissipating=!0,e.dissipateProgress=0),(e.x<4*-e.r||e.x>i.width+4*e.r)&&qe(e)}function Oe(e){const n=o();if(function(e){a.currentMode=e}(e),console.log(`Switching to mode: ${e}`),function(e){const t=document.getElementById("announcer");t&&(t.textContent="",setTimeout(()=>{t.textContent=e},10))}(`Switched to ${{pit:"Ball Pit",flies:"Flies to Light",weightless:"Zero Gravity",water:"Water Swimming",vortex:"Vortex Sheets","ping-pong":"Ping Pong",magnetic:"Magnetic",bubbles:"Carbonated Bubbles"}[e]||e} mode`),n.container){const a=n.container.classList.contains("dark-mode");n.container.className="",e===t.PIT&&n.container.classList.add("mode-pit"),(a||n.isDarkMode)&&n.container.classList.add("dark-mode")}ve(),e===t.PIT?(n.gravityMultiplier=n.gravityMultiplierPit,n.G=n.GE*n.gravityMultiplier,n.repellerEnabled=!0,function(){const e=o();i();const t=e.canvas.width,n=e.canvas.height;e.DPR;const a=n/3*.7,l=t;for(let e=0;e<8;e++){const t=ke(0+Math.random()*(l-0),0+Math.random()*(a-0),c(e));t.vx=100*(Math.random()-.5),t.vy=50*Math.random(),t.driftAx=0,t.driftTime=0}for(let e=8;e<300;e++){const e=ke(0+Math.random()*(l-0),0+Math.random()*(a-0));e.vx=100*(Math.random()-.5),e.vy=50*Math.random(),e.driftAx=0,e.driftTime=0}}()):e===t.FLIES?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i();const t=.5*e.canvas.width,n=.5*e.canvas.height,a=150*e.DPR;for(let e=0;e<8;e++){const o=Math.random()*Math.PI*2,i=Math.random()*a,l=ke(t+Math.cos(o)*i,n+Math.sin(o)*i,c(e)),s=.5+.5*Math.random(),r=Math.random()*Math.PI*2,d=300*s;l.vx=Math.cos(r)*d,l.vy=Math.sin(r)*d,l.driftAx=0,l.driftTime=0}for(let e=8;e<60;e++){const e=Math.random()*Math.PI*2,o=Math.random()*a,i=ke(t+Math.cos(e)*o,n+Math.sin(e)*o),l=.5+.5*Math.random(),s=Math.random()*Math.PI*2,r=300*l;i.vx=Math.cos(s)*r,i.vy=Math.sin(s)*r,i.driftAx=0,i.driftTime=0}}()):e===t.WEIGHTLESS?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i();const t=e.weightlessCount,n=e.canvas.width,a=e.canvas.height,l=40*e.DPR;for(let o=0;o<8&&o<t;o++){const t=ke(l+Math.random()*(n-2*l),l+Math.random()*(a-2*l),c(o)),i=Math.random()*Math.PI*2,s=e.weightlessInitialSpeed*(.7+.3*Math.random());t.vx=Math.cos(i)*s,t.vy=Math.sin(i)*s,t.driftAx=0,t.driftTime=0}for(let o=8;o<t;o++){const t=ke(l+Math.random()*(n-2*l),l+Math.random()*(a-2*l)),o=Math.random()*Math.PI*2,i=e.weightlessInitialSpeed*(.7+.3*Math.random());t.vx=Math.cos(o)*i,t.vy=Math.sin(o)*i,t.driftAx=0,t.driftTime=0}}()):e===t.WATER?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i(),ae.length=0;const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=e.waterBallCount||100;for(let t=0;t<8&&t<l;t++){const o=Math.random()*n,i=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=c(t),r=new ne(o,i,l,s),d=e.waterInitialVelocity||120;r.vx=(Math.random()-.5)*d,r.vy=(Math.random()-.5)*d,e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,o=Math.random()*a,i=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new ne(t,o,i,l),c=e.waterInitialVelocity||120;s.vx=(Math.random()-.5)*c,s.vy=(Math.random()-.5)*c,e.balls.push(s)}}()):e===t.VORTEX?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.vortexBallCount||180,e.maxBalls||300);for(let t=0;t<8&&t<l;t++){const o=Math.random()*n,i=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=c(t),r=new ne(o,i,l,s);r.vx=80*(Math.random()-.5),r.vy=80*(Math.random()-.5),e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,o=Math.random()*a,i=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new ne(t,o,i,l);s.vx=80*(Math.random()-.5),s.vy=80*(Math.random()-.5),e.balls.push(s)}}()):e===t.PING_PONG?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.pingPongBallCount||80,e.maxBalls||300),s=e.pingPongSpeed||400;for(let t=0;t<8&&t<l;t++){const o=Math.random()*n,i=.15*a+Math.random()*a*.7,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),r=c(t),d=new ne(o,i,l,r),u=Math.random()>.5?1:-1;d.vx=u*(.8*s+Math.random()*s*.4),d.vy=0,d.isPingPong=!0,e.balls.push(d)}for(let t=8;t<l;t++){const t=Math.random()*n,o=.15*a+Math.random()*a*.7,i=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),c=new ne(t,o,i,l),d=Math.random()>.5?1:-1;c.vx=d*(.8*s+Math.random()*s*.4),c.vy=0,c.isPingPong=!0,e.balls.push(c)}}()):e===t.MAGNETIC?(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();i();const t=e.canvas;if(!t)return;const n=t.width,a=t.height,l=Math.min(e.magneticBallCount||180,e.maxBalls||300);for(let t=0;t<8&&t<l;t++){const o=Math.random()*n,i=Math.random()*a,l=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),s=c(t),r=new ne(o,i,l,s);r.vx=100*(Math.random()-.5),r.vy=100*(Math.random()-.5),r.charge=Math.random()>.5?1:-1,r.baseAlpha=1,e.balls.push(r)}for(let t=8;t<l;t++){const t=Math.random()*n,o=Math.random()*a,i=e.R_MIN+Math.random()*(e.R_MAX-e.R_MIN),l=r(),s=new ne(t,o,i,l);s.vx=100*(Math.random()-.5),s.vy=100*(Math.random()-.5),s.charge=Math.random()>.5?1:-1,s.baseAlpha=1,e.balls.push(s)}}()):e===t.BUBBLES&&(n.gravityMultiplier=0,n.G=0,n.repellerEnabled=!1,function(){const e=o();e.balls.length=0;const t=e.canvas;if(!t)return;const n=t.width,a=t.height,i=e.bubblesMaxCount||150;for(let e=0;e<8&&e<i;e++)Fe(Math.random()*n,.3*a+Math.random()*a*.6,c(e),!0);for(let e=8;e<i;e++)Fe(Math.random()*n,.3*a+Math.random()*a*.6,r(),!0)}()),console.log(`Mode ${e} initialized with ${n.balls.length} balls`)}function We(){const e=o();return e.currentMode===t.FLIES?_e:e.currentMode===t.PIT?Ae:e.currentMode===t.WATER?oe:e.currentMode===t.VORTEX?Le:e.currentMode===t.PING_PONG?Ge:e.currentMode===t.MAGNETIC?De:e.currentMode===t.BUBBLES?Ne:null}var Ve=Object.freeze({__proto__:null,MODES:t,getForceApplicator:We,setMode:Oe});function $e(){!function(){const e=o();for(const[t,n]of Object.entries(Te))for(const t of n.controls){const a=t.id+"Val",o=document.getElementById(a);if("color"===t.type){const n=t.id+"Picker",a=document.getElementById(n);if(!a)continue;a.addEventListener("input",()=>{const n=a.value;t.stateKey&&(e[t.stateKey]=n),t.onChange&&t.onChange(e,n),o&&(o.textContent=n),we()});continue}const i=t.id+"Slider",l=document.getElementById(i);l&&l.addEventListener("input",()=>{const a=t.parse(l.value);if(t.stateKey&&!t.onChange&&(e[t.stateKey]=a),t.onChange&&t.onChange(e,a),o){const n=t.stateKey?e[t.stateKey]:a;o.textContent=t.format(n)}if(t.cssVar&&Ee){const e={};e[t.cssVar.replace("--","").replace(/-([a-z])/g,(e,t)=>t.toUpperCase())]=a,Ee(e),"wallThickness"===t.id&&ve()}t.reinitMode&&e.currentMode===n.mode&&(n.mode.replace("-",""),import(`../modes/${n.mode}.js`).then(e=>{const t=Object.values(e).find(e=>"function"==typeof e&&e.name.toLowerCase().includes("initialize"));t&&t()}).catch(()=>{})),we()})}}(),document.querySelectorAll(".mode-button").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=e.getAttribute("data-mode");console.log("Mode button clicked:",n),Oe(n),He(n)})}),u();const e=document.getElementById("colorSelect");e&&e.addEventListener("change",()=>{d(e.value),we()});const t=document.getElementById("themeAuto"),n=document.getElementById("themeLight"),a=document.getElementById("themeDark");[t,n,a].forEach(e=>{e&&e.addEventListener("click",()=>{[t,n,a].forEach(e=>e?.classList.remove("active")),e.classList.add("active")})})}function He(e){document.querySelectorAll(".mode-button").forEach(t=>{const n=t.getAttribute("data-mode")===e;t.classList.toggle("active",n)}),document.querySelectorAll(".mode-controls").forEach(e=>e.classList.remove("active"));const t=e+"Controls",n=document.getElementById(t);n&&n.classList.add("active");const a=document.getElementById("announcer");if(a){const t={pit:"Ball Pit",flies:"Flies to Light",weightless:"Zero-G",water:"Water Swimming",vortex:"Vortex Sheets","ping-pong":"Ping Pong",magnetic:"Magnetic",bubbles:"Carbonated Bubbles"};a.textContent=`Switched to ${t[e]||e} mode`}}var Ke=Object.freeze({__proto__:null,setupControls:$e,updateModeButtonsUI:He});const ze={core:{title:"Core",controls:[{id:"masterGain",label:"Master Volume",min:10,max:100,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e},{id:"collisionMinImpact",label:"Silence Threshold",min:0,max:30,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e}]},envelope:{title:"Envelope",controls:[{id:"decayTime",label:"Click Length",min:20,max:180,step:1,format:e=>`${Math.round(e)}ms`,toConfig:e=>e/1e3,fromConfig:e=>1e3*e}]},tone:{title:"Tone",controls:[{id:"filterBaseFreq",label:"Brightness",min:300,max:6e3,step:50,format:e=>`${Math.round(e)}Hz`,toConfig:e=>e,fromConfig:e=>e},{id:"harmonicGain",label:"Warmth",min:0,max:50,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e},{id:"filterQ",label:"Resonance",min:10,max:200,step:5,format:e=>`${(e/100).toFixed(2)}`,toConfig:e=>e/100,fromConfig:e=>100*e}]},space:{title:"Space",controls:[{id:"reverbWetMix",label:"Reverb Mix",min:0,max:50,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e},{id:"reverbDecay",label:"Room Size",min:5,max:80,step:1,format:e=>`${(e/100).toFixed(2)}s`,toConfig:e=>e/100,fromConfig:e=>100*e}]},dynamics:{title:"Dynamics",controls:[{id:"minGain",label:"Min Hit Volume",min:0,max:20,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e},{id:"maxGain",label:"Max Hit Volume",min:5,max:50,step:1,format:e=>`${Math.round(e)}%`,toConfig:e=>e/100,fromConfig:e=>100*e}]},rolling:{title:"Surface Texture",controls:[{id:"rollingGain",label:"Texture Volume",min:0,max:8,step:.1,format:e=>`${e.toFixed(1)}%`,toConfig:e=>e/100,fromConfig:e=>100*e},{id:"rollingFreq",label:"Texture Pitch",min:50,max:300,step:10,format:e=>`${Math.round(e)}Hz`,toConfig:e=>e,fromConfig:e=>e}]}};function Xe(e,t){const n=t();for(const t of Object.values(ze))for(const a of t.controls){const t=e.querySelector(`#sound_${a.id}`),o=e.querySelector(`#sound_${a.id}_val`);if(!t||void 0===n[a.id])continue;const i=a.fromConfig(n[a.id]);t.value=i,o&&(o.textContent=a.format(i))}}let Ue=null,Ye=null,je=null,Qe=null;const Je="panel_dock_position",Ze="panel_dock_hidden",et="panel_dock_collapse";function tt(){try{const e=localStorage.getItem(et);return e?JSON.parse(e):{control:!0,sound:!0}}catch(e){return{control:!0,sound:!0}}}let nt=!1,at=!1,ot=0,it=0,lt=0,st=0,rt=null;function ct(e){if(e.target.closest("button")||e.target.closest("input")||e.target.closest("select"))return;const t=e.target.closest(".panel-header");if(!t)return;const n=t.closest(".panel");if(!n)return;const a=e.touches?e.touches[0].clientX:e.clientX,o=e.touches?e.touches[0].clientY:e.clientY;ot=a,it=o;const i=n.getBoundingClientRect();lt=i.left,st=i.top,rt=n,nt=!1,at=!1}function dt(e){if(0===ot&&0===it||!rt)return;const t=e.touches?e.touches[0].clientX:e.clientX,n=e.touches?e.touches[0].clientY:e.clientY,a=t-ot,o=n-it;if(!nt&&(Math.abs(a)>5||Math.abs(o)>5)&&(nt=!0,at=!0,rt.classList.add("dragging"),rt.style.position="fixed",rt.style.top=`${st}px`,rt.style.left=`${lt}px`,rt.style.right="auto",rt.style.zIndex="10001"),nt){let t=lt+a,n=st+o;const i=rt.getBoundingClientRect(),l=0,s=window.innerWidth-i.width,r=0,c=window.innerHeight-i.height;t=Math.max(l,Math.min(s,t)),n=Math.max(r,Math.min(c,n)),rt.style.left=`${t}px`,rt.style.top=`${n}px`,e.preventDefault()}}function ut(e){nt&&rt&&(nt=!1,rt.classList.remove("dragging"),function(e){if(e)try{const t=JSON.parse(localStorage.getItem(Je)||"{}");t[e.id]={left:e.style.left,top:e.style.top,useCustomPosition:!0},localStorage.setItem(Je,JSON.stringify(t))}catch(e){}}(rt)),ot=0,it=0,rt=null,setTimeout(()=>{at=!1},10)}function mt(e){e.classList.toggle("collapsed"),function(){try{const e={control:Ye?.classList.contains("collapsed")??!0,sound:je?.classList.contains("collapsed")??!0};localStorage.setItem(et,JSON.stringify(e))}catch(e){}}();const t=e.querySelector(".collapse-btn"),n=e.classList.contains("collapsed");t&&t.setAttribute("aria-label",n?"Expand panel":"Collapse panel")}function ht(e){const t=je?.querySelector(".panel-header .panel-icon");t&&(t.textContent=e?"üîä":"üîá")}const gt="--abs-brand-logo-scale";let pt=null,ft=!1,bt=0,yt=0,vt=1,Mt=1,xt=1,St=null,wt=null,Et=0,It=null;function Ct(){bt=window.innerWidth||0,yt=window.innerHeight||0,vt=Math.max(1,.5*Math.min(bt,yt)),Mt=Math.max(1,.25*bt),xt=Math.max(1,.25*yt)}function Tt(){if(Et=0,!ft||!pt)return;if(null==St||null==wt)return;const e=St-.5*bt,t=wt-.5*yt,n=Math.hypot(e,t);let a=0;if(n>0){const n=Math.sqrt(e*e/(Mt*Mt)+t*t/(xt*xt));a=n>0?1/n:0}let o=0;var i;o=n<=a?0:n>=vt?1:(i=(n-a)/Math.max(1e-6,vt-a))<0?0:i>1?1:i;const l=.98+(1.02-.98)*o;null!=It&&Math.abs(l-It)<.001||(pt.style.setProperty(gt,l.toFixed(4)),It=l)}let Pt=0,Bt=0,Rt=0,kt=0,_t=0,At=!1;const Lt=[t.PIT,t.FLIES,t.WEIGHTLESS,t.WATER,t.VORTEX,t.PING_PONG,t.MAGNETIC,t.BUBBLES];function Gt(){const e=o().currentMode,t=Lt.indexOf(e),n=Lt[(t+1)%Lt.length]||Lt[0];Promise.resolve().then(function(){return Ve}).then(({setMode:e})=>{e(n)}),Promise.resolve().then(function(){return Ke}).then(({updateModeButtonsUI:e})=>{e(n)})}let Dt=0,Ft=0,qt=0,Nt=0;const Ot="--abs-brand-logo-retreat";let Wt=null,Vt=!1,$t=0,Ht=null,Kt=0,zt=0,Xt=1;function Ut(){if(!Wt)return;const e=Wt.getBoundingClientRect();Kt=e.left+.5*e.width,zt=e.top+.5*e.height,Xt=Math.max(1,.6*Math.min(e.width,e.height))}let Yt=performance.now()/1e3;function jt(e){requestAnimationFrame(function a(i){const l=i/1e3;let s=Math.min(.033,l-Yt);Yt=l,async function(e,a){const i=o(),l=i.balls,s=i.canvas;if(!s||0===l.length)return;se+=e;let r=0;for(;se>=le&&r<n.MAX_PHYSICS_STEPS;){const e=l.length;for(let t=0;t<e;t++)l[t].step(le,a);i.currentMode!==t.FLIES&&U(10);const n=i.currentMode===t.WEIGHTLESS?i.weightlessBounce:i.REST,o=l.length;for(let e=0;e<o;e++)ce(l[e],s),l[e].walls(s.width,s.height,le,n);se-=le,r++}i.currentMode===t.WATER&&function(e){const t=o().waterRippleSpeed||300;for(let n=ae.length-1;n>=0;n--){const a=ae[n];a.radius+=t*e,a.age+=e,a.strength*=.96,(a.age>3||a.strength<10)&&ae.splice(n,1)}}(e),J.step(e),se>le*n.ACCUMULATOR_RESET_THRESHOLD&&(se=0)}(s,e),function(){const e=o(),t=e.ctx,n=e.balls,a=e.canvas;if(t&&a){t.clearRect(0,0,a.width,a.height),function(e,t,n){const a=o();if(!J.hasAnyDeformation())return;const i=function(){try{return getComputedStyle(document.documentElement).getPropertyValue("--wall-color").trim()||"#0a0a0a"}catch{return"#0a0a0a"}}(),l=(a.wallThickness||12)*(a.DPR||1),s="pit"===a.currentMode?n/3:0;if(e.save(),e.fillStyle=i,J.bottom.hasDeformation()){e.beginPath(),e.moveTo(0,n+l);for(let a=0;a<=Y;a++){const o=a/Y,i=o*t,l=J.bottom.getDeformAt(o);e.lineTo(i,n-l)}e.lineTo(t,n+l),e.closePath(),e.fill()}if(J.top.hasDeformation()){e.beginPath(),e.moveTo(0,s-l);for(let n=0;n<=Y;n++){const a=n/Y,o=a*t,i=J.top.getDeformAt(a);e.lineTo(o,s+i)}e.lineTo(t,s-l),e.closePath(),e.fill()}if(J.left.hasDeformation()){e.beginPath(),e.moveTo(-l,s);for(let t=0;t<=Y;t++){const a=t/Y,o=s+a*(n-s),i=J.left.getDeformAt(a);e.lineTo(i,o)}e.lineTo(-l,n),e.closePath(),e.fill()}if(J.right.hasDeformation()){e.beginPath(),e.moveTo(t+l,s);for(let a=0;a<=Y;a++){const o=a/Y,i=s+o*(n-s),l=J.right.getDeformAt(o);e.lineTo(t-l,i)}e.lineTo(t+l,n),e.closePath(),e.fill()}e.restore()}(t,a.width,a.height),e.currentMode;for(let e=0;e<n.length;e++)n[e].draw(t);!function(e){const t=o();if(!t.mouseInCanvas)return;if(!0===t.isTouchDevice)return;if(!1===t.cursorBallVisible)return;const n=Math.max(6*t.DPR,.12*(t.R_MIN+t.R_MAX));e.save(),e.beginPath(),e.arc(t.mouseX,t.mouseY,n,0,2*Math.PI),e.fillStyle=t.currentColors&&t.currentColors[4]||"#000000",e.globalAlpha=.9,e.fill(),e.globalAlpha=1,e.restore()}(t)}}(),function(e){if(!Vt||!Wt)return;if(e-$t<90)return;$t=e;const t=o(),n=t.balls||[],a=t.canvas;if(!a||0===n.length)return void(0!==Ht&&(Wt.style.setProperty(Ot,"0"),Ht=0));const i=a.getBoundingClientRect(),l=t.DPR||1,s=(Kt-i.left)*l,r=(zt-i.top)*l,c=Math.max(1,.5*Math.min(window.innerWidth,window.innerHeight)*l),d=(Xt+18)*l;let u=1/0;for(let e=0;e<n.length;e++){const t=n[e],a=t.x-s,o=t.y-r,i=Math.hypot(a,o),l=Math.max(0,i-(t.r||0));if(l<u&&(u=l),u<=d)break}let m=0;var h;m=u<=d?1:u>=c?0:1-((h=(u-d)/Math.max(1e-6,c-d))<0?0:h>1?1:h);const g=Number(m.toFixed(3));null!=Ht&&Math.abs(g-Ht)<.001||(Wt.style.setProperty(Ot,String(g)),Ht=g)}(i);const r=o().balls||[],c=o();!function(e,t=1/0){if(!w||!E||!f)return;if(P)return;let n=0,a=0;if(h.rollingEnabled)for(const o of e){const e=Math.sqrt(o.vx*o.vx+o.vy*o.vy),i=Math.abs(o.vx),l=Math.abs(o.vy),s=o.y+o.r>=t-3,r=i>2*l,c=e>h.rollingMinVelocity&&e<h.rollingMaxVelocity;s&&r&&c&&(n+=i/h.rollingMaxVelocity,a++)}const o=a>0?Math.min(1,n/Math.max(1,.7*a)):0;if(G+=.15*(o-G),R&&h.rollingEnabled){const e=G*h.rollingGain;if(R.gain.setTargetAtTime(e,f.currentTime,.08),B){const e=1+.15*G;B.frequency.setTargetAtTime(h.rollingFreq*e,f.currentTime,.15)}}A&&A.gain.setTargetAtTime(0,f.currentTime,.05)}(r,c.canvas?c.canvas.height-(c.simulationPadding||0):1/0),function(e){if(qt++,e-Ft>1e3){Nt=qt,qt=0,Ft=e;const t=document.getElementById("render-fps");t&&(t.textContent=String(Nt))}}(performance.now()),requestAnimationFrame(a)})}let Qt=null;async function Jt(){$().isUnlocked?Zt(V()):await F()?Zt(!0):(Qt.textContent="Audio unavailable",setTimeout(()=>{Qt.textContent="Sound off"},2e3))}function Zt(e){Qt&&(Qt.setAttribute("data-enabled",e?"true":"false"),Qt.setAttribute("aria-pressed",e?"true":"false"),Qt.setAttribute("aria-label","Toggle collision sounds"),Qt.textContent=e?"Sound On":"Sound Off")}function en(e){const t=be();e.textContent="dark"===t?"Dark Mode":"Light Mode"}function tn(e,t,n,a,o,i){const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="4px";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="space-between";const r=document.createElement("span");r.textContent=t,r.style.fontWeight="500";const c=document.createElement("span");c.textContent=`${i}px`,c.style.opacity="0.7",c.style.fontVariantNumeric="tabular-nums",s.appendChild(r),s.appendChild(c);const d=document.createElement("input");d.type="range",d.min=a,d.max=o,d.value=i,d.style.width="100%",d.style.cursor="grab",d.oninput=e=>{const t=e.target.value;c.textContent=`${t}px`,document.documentElement.style.setProperty(n,`${t}px`)},l.appendChild(s),l.appendChild(d),e.appendChild(l)}function nn(){const e=o(),t=document.documentElement;t.style.setProperty("--container-border",`${e.containerBorder||0}px`),t.style.setProperty("--simulation-padding",`${e.simulationPadding||0}px`)}function an(e){const t=document.documentElement;void 0!==e.wallThickness&&t.style.setProperty("--wall-thickness",`${e.wallThickness}px`),void 0!==e.wallSoftness&&t.style.setProperty("--wall-softness",`${e.wallSoftness}px`),void 0!==e.wallRadius&&t.style.setProperty("--wall-radius",`${e.wallRadius}px`),void 0!==e.wallBounceIntensity&&t.style.setProperty("--wall-bounce-intensity",String(e.wallBounceIntensity)),void 0!==e.noiseSizeBase&&t.style.setProperty("--noise-size-base",`${e.noiseSizeBase}px`),void 0!==e.noiseSizeTop&&t.style.setProperty("--noise-size-top",`${e.noiseSizeTop}px`),void 0!==e.noiseBackOpacity&&t.style.setProperty("--noise-back-opacity",String(e.noiseBackOpacity)),void 0!==e.noiseFrontOpacity&&t.style.setProperty("--noise-front-opacity",String(e.noiseFrontOpacity)),void 0!==e.noiseBackOpacityDark&&t.style.setProperty("--noise-back-opacity-dark",String(e.noiseBackOpacityDark)),void 0!==e.noiseFrontOpacityDark&&t.style.setProperty("--noise-front-opacity-dark",String(e.noiseFrontOpacityDark)),void 0!==e.vignetteLightIntensity&&t.style.setProperty("--vignette-light-intensity",String(e.vignetteLightIntensity)),void 0!==e.vignetteDarkIntensity&&t.style.setProperty("--vignette-dark-intensity",String(e.vignetteDarkIntensity)),void 0!==e.vignetteBlurOuter&&t.style.setProperty("--vignette-blur-outer",`${e.vignetteBlurOuter}px`),void 0!==e.vignetteBlurMid&&t.style.setProperty("--vignette-blur-mid",`${e.vignetteBlurMid}px`),void 0!==e.vignetteBlurInner&&t.style.setProperty("--vignette-blur-inner",`${e.vignetteBlurInner}px`),void 0!==e.vignetteSpread&&t.style.setProperty("--vignette-spread",`${e.vignetteSpread}px`),void 0!==e.vignetteX&&t.style.setProperty("--vignette-x",`${e.vignetteX}px`),void 0!==e.vignetteY&&t.style.setProperty("--vignette-y",`${e.vignetteY}px`),void 0!==e.vignetteTransition&&t.style.setProperty("--vignette-transition",`${e.vignetteTransition}ms`)}return async function(){document.documentElement.classList.add("js-enabled"),Ee=an;try{console.log("üöÄ Initializing modular bouncy balls...");const e=await async function(){try{const e=["config/default-config.json","js/config.json","../public/js/config.json"];for(const t of e)try{const e=await fetch(t,{cache:"no-cache"});if(e.ok)return await e.json()}catch(e){}throw new Error("No config found")}catch(e){return console.warn("Config load failed, using defaults"),{gravityMultiplier:1.05,ballMass:91,maxBalls:300}}}();!function(e){a.config={...e},e.ballMass&&(a.ballMassKg=e.ballMass),e.gravityMultiplier&&(a.gravityMultiplier=e.gravityMultiplier),e.restitution&&(a.REST=e.restitution),e.friction&&(a.FRICTION=e.friction),e.ballScale&&(a.sizeScale=e.ballScale),void 0!==e.containerBorder&&(a.containerBorder=e.containerBorder),void 0!==e.simulationPadding&&(a.simulationPadding=e.simulationPadding),void 0!==e.frameColor&&(a.frameColor=e.frameColor),void 0!==e.wallThickness&&(a.wallThickness=e.wallThickness),void 0!==e.wallSoftness&&(a.wallSoftness=e.wallSoftness),void 0!==e.wallRadius&&(a.wallRadius=e.wallRadius),void 0!==e.wallBounceHighlightMax&&(a.wallBounceHighlightMax=e.wallBounceHighlightMax),void 0!==e.wallWobbleMaxDeform&&(a.wallWobbleMaxDeform=e.wallWobbleMaxDeform),void 0!==e.wallWobbleStiffness&&(a.wallWobbleStiffness=e.wallWobbleStiffness),void 0!==e.wallWobbleDamping&&(a.wallWobbleDamping=e.wallWobbleDamping),void 0!==e.wallWobbleSigma&&(a.wallWobbleSigma=e.wallWobbleSigma),void 0!==e.wallWobbleImpactThreshold&&(a.wallWobbleImpactThreshold=e.wallWobbleImpactThreshold),void 0!==e.wallWobbleCornerClamp&&(a.wallWobbleCornerClamp=e.wallWobbleCornerClamp),void 0!==e.wallBounceHighlightDecay&&(a.wallBounceHighlightDecay=e.wallBounceHighlightDecay),void 0!==e.vignetteX&&(a.vignetteX=e.vignetteX),void 0!==e.vignetteY&&(a.vignetteY=e.vignetteY),void 0!==e.vignetteBlurOuter&&(a.vignetteBlurOuter=e.vignetteBlurOuter),void 0!==e.vignetteBlurMid&&(a.vignetteBlurMid=e.vignetteBlurMid),void 0!==e.vignetteBlurInner&&(a.vignetteBlurInner=e.vignetteBlurInner),void 0!==e.vignetteSpread&&(a.vignetteSpread=e.vignetteSpread),void 0!==e.vignetteLightIntensity&&(a.vignetteLightIntensity=e.vignetteLightIntensity),void 0!==e.vignetteDarkIntensity&&(a.vignetteDarkIntensity=e.vignetteDarkIntensity),void 0!==e.vignetteTransition&&(a.vignetteTransition=e.vignetteTransition);const t=(a.R_MIN_BASE+a.R_MAX_BASE)/2;a.R_MIN=t*a.sizeScale*.75,a.R_MAX=t*a.sizeScale*1.25}(e),console.log("‚úì Config loaded"),nn(),console.log("‚úì Frame padding applied"),an(e),console.log("‚úì Visual effects configured"),function(){const e=document.querySelector(".noise");if(!e)return;const t=getComputedStyle(e),n=t.backgroundImage&&"none"!==t.backgroundImage?t.backgroundImage:null;if(!document.querySelector(".noise-2")){const t=document.createElement("div");t.className="noise-2",n&&(t.style.backgroundImage=n),t.style.position="fixed",t.style.inset="0",t.style.pointerEvents="none",t.style.backgroundRepeat="repeat",t.style.backgroundPosition="50%",t.style.backgroundAttachment="fixed",t.style.mixBlendMode="luminosity",e.insertAdjacentElement("afterend",t),console.log("‚úì Created .noise-2 element")}const a=document.querySelector(".noise-2");if(a&&!document.querySelector(".noise-3")){const e=document.createElement("div");e.className="noise-3",n&&(e.style.backgroundImage=n),e.style.position="fixed",e.style.inset="0",e.style.pointerEvents="none",e.style.backgroundRepeat="repeat",e.style.backgroundPosition="50%",e.style.backgroundAttachment="fixed",e.style.mixBlendMode="luminosity",a.insertAdjacentElement("afterend",e),console.log("‚úì Created .noise-3 element")}}(),ye();const i=Me(),l=xe(),s=document.getElementById("bravia-balls");if(!i||!l||!s)throw new Error("Missing DOM elements");!function(e,t,n){a.canvas=e,a.ctx=t,a.container=n}(i,l,s),ve(),console.log("‚úì Canvas initialized (container-relative sizing)"),o().mouseInCanvas=!1,"undefined"!=typeof window&&(window.mouseInCanvas=!1),function(){const e=o(),a=e.canvas;if(At=e.clickCycleEnabled||!1,!a)return void console.error("Canvas not available for pointer setup");const i=e.DPR;function l(e,t){const n=.5*a.width,o=.5*a.height;return{x:n+.23*(e-n),y:o+.23*(t-o)}}function s(e,t){const n=a.getBoundingClientRect();return{x:(e-n.left)*i,y:(t-n.top)*i,inBounds:e>=n.left&&e<=n.right&&t>=n.top&&t<=n.bottom}}document.addEventListener("mousemove",n=>{var a,o;if(a=n.clientX,o=n.clientY,ft&&pt&&(St=a,wt=o,Et||(Et=window.requestAnimationFrame(Tt))),n.target.closest("#controlPanel"))return;const i=s(n.clientX,n.clientY),r=l(i.x,i.y),c=performance.now(),d=c-Rt;if(d>0&&Rt>0){const e=r.x-Pt,t=r.y-Bt;kt=Math.sqrt(e*e+t*t)/d}if(e.mouseX=r.x,e.mouseY=r.y,e.mouseInCanvas=i.inBounds,"undefined"!=typeof window&&(window.mouseInCanvas=i.inBounds),e.currentMode===t.WATER&&i.inBounds&&kt>.3&&c-Dt>80){const e=Math.min(2*kt,3);ie(r.x,r.y,e),Dt=c}Pt=r.x,Bt=r.y,Rt=c},{passive:!0}),document.addEventListener("click",e=>{e.target.closest("#controlPanel")||e.target.closest("a")||e.target.closest("button")||s(e.clientX,e.clientY).inBounds&&At&&Gt()}),document.addEventListener("touchmove",n=>{if(n.touches&&n.touches[0]){const a=s(n.touches[0].clientX,n.touches[0].clientY),o=l(a.x,a.y);e.mouseX=o.x,e.mouseY=o.y,e.mouseInCanvas=a.inBounds;const i=performance.now();e.currentMode===t.WATER&&a.inBounds&&i-Dt>80&&(ie(o.x,o.y,2),Dt=i)}},{passive:!0}),document.addEventListener("touchstart",e=>{if(!e.target.closest("#controlPanel")&&!e.target.closest("a")&&!e.target.closest("button")&&e.touches&&e.touches[0]){if(!s(e.touches[0].clientX,e.touches[0].clientY).inBounds)return;const t=performance.now();t-_t<300&&At&&Gt(),_t=t}},{passive:!0}),document.addEventListener("mouseleave",()=>{e.mouseX=n.OFFSCREEN_MOUSE,e.mouseY=n.OFFSCREEN_MOUSE,e.mouseInCanvas=!1,kt=0,"undefined"!=typeof window&&(window.mouseInCanvas=!1)}),document.addEventListener("touchend",()=>{e.mouseX=n.OFFSCREEN_MOUSE,e.mouseY=n.OFFSCREEN_MOUSE,e.mouseInCanvas=!1},{passive:!0}),console.log("‚úì Unified pointer system configured (document-level)")}(),console.log("‚úì Pointer tracking configured"),"undefined"!=typeof window&&"undefined"!=typeof document&&(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches||(pt=document.querySelector("#brand-logo .hero__text")||document.querySelector("#brand-logo")||null,pt&&(Ct(),ft=!0,pt.style.setProperty(gt,String(1)),window.addEventListener("resize",Ct,{passive:!0})))),"undefined"!=typeof window&&"undefined"!=typeof document&&(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches||(Wt=document.querySelector("#brand-logo .hero__text")||document.querySelector("#brand-logo")||null,Wt&&(Ut(),window.addEventListener("resize",Ut,{passive:!0}),Wt.style.setProperty(Ot,"0"),Vt=!0))),console.log("‚ö†Ô∏è localStorage is disabled - using defaults"),fe(),console.log("‚úì Dark mode initialized"),d(o().currentTemplate),console.log("‚úì Color system initialized"),function(){D(),Ue=document.createElement("div"),Ue.className="panel-dock",Ue.id="panelDock";const e=function(){try{return"true"===localStorage.getItem(Ze)}catch(e){return!1}}();e&&Ue.classList.add("hidden"),Ye=function(){const e=tt(),t=document.createElement("div");t.id="controlPanel",t.className=e.control?"panel collapsed":"panel",t.setAttribute("role","region"),t.setAttribute("aria-label","Simulation controls");const n=document.createElement("div");n.className="panel-header",n.innerHTML='\n    <div class="panel-title">\n      <span class="panel-icon">‚öôÔ∏è</span>\n      <span>Controls</span>\n    </div>\n    <button class="collapse-btn" aria-label="Expand/collapse controls">‚ñº</button>\n  ';const a=document.createElement("div");a.className="panel-content",a.innerHTML=Re.replace(/<div class="panel-header"[\s\S]*?<\/div>/,""),t.appendChild(n),t.appendChild(a);const i=n.querySelector(".collapse-btn");return i&&i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),mt(t)}),n.addEventListener("click",e=>{at||e.target.closest("button")||mt(t)}),setTimeout(()=>{fe(),$e(),function(){const e=document.getElementById("saveConfigBtn");e&&e.addEventListener("click",()=>{const e=o(),t={gravityMultiplier:e.gravityMultiplierPit,ballMass:e.ballMassKg,sizeScale:e.sizeScale,sizeVariation:e.sizeVariation,restitution:e.REST,friction:e.FRICTION,repelRadius:e.repelRadius,repelPower:e.repelPower,repelSoftness:e.repelSoft,frameColor:e.frameColor,containerBorder:e.containerBorder,simulationPadding:e.simulationPadding,wallThickness:e.wallThickness,wallSoftness:e.wallSoftness,wallRadius:e.wallRadius,wallBounceHighlightMax:e.wallBounceHighlightMax,wallWobbleMaxDeform:e.wallWobbleMaxDeform,wallWobbleStiffness:e.wallWobbleStiffness,wallWobbleDamping:e.wallWobbleDamping,wallWobbleSigma:e.wallWobbleSigma,wallWobbleImpactThreshold:e.wallWobbleImpactThreshold,wallWobbleCornerClamp:e.wallWobbleCornerClamp,wallBounceHighlightDecay:e.wallBounceHighlightDecay,vignetteX:e.vignetteX,vignetteY:e.vignetteY,vignetteBlurOuter:e.vignetteBlurOuter,vignetteBlurMid:e.vignetteBlurMid,vignetteBlurInner:e.vignetteBlurInner,vignetteSpread:e.vignetteSpread,vignetteLightIntensity:e.vignetteLightIntensity,vignetteDarkIntensity:e.vignetteDarkIntensity,vignetteTransition:e.vignetteTransition,cursorColorIndex:5,enableLOD:!1},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(n),a.download="current-config.json",document.body.appendChild(a),a.click(),document.body.removeChild(a)})}()},0),t}(),je=function(){const e=tt(),t=document.createElement("div");t.id="soundPanel",t.className=e.sound?"panel sound-panel collapsed":"panel sound-panel",t.setAttribute("role","region"),t.setAttribute("aria-label","Sound configuration");const n=document.createElement("div");n.className="panel-header",n.innerHTML='\n    <div class="panel-title">\n      <span class="panel-icon">üîä</span>\n      <span>Sound</span>\n    </div>\n    <button class="collapse-btn" aria-label="Expand/collapse sound">‚ñº</button>\n  ';const a=document.createElement("div");a.className="panel-content",a.innerHTML=`\n  \x3c!-- Sound Enable/Disable --\x3e\n  <div class="sound-dock__enable">\n    <button id="soundEnableBtn" class="sound-dock__enable-btn">\n      üîá Enable Sound\n    </button>\n  </div>\n  \n  \x3c!-- Controls (visible when sound enabled) --\x3e\n  <div id="soundControlsWrapper" class="sound-dock__controls" style="display: none;">\n    \x3c!-- Preset --\x3e\n    <div class="sound-dock__section">\n      <select id="soundPresetSelect" class="sound-dock__select"></select>\n      <p id="presetDescription" class="sound-dock__desc"></p>\n    </div>\n    \n    \x3c!-- All controls from registry --\x3e\n    ${function(){let e="";for(const[t,n]of Object.entries(ze)){e+='<div class="sound-dock__section">',e+=`<div class="sound-dock__section-title">${n.title}</div>`,e+='<div class="sound-dock__group">';for(const t of n.controls)e+=`\n        <label class="sound-dock__row">\n          <span class="sound-dock__label">${t.label}</span>\n          <input type="range" \n            id="sound_${t.id}" \n            class="sound-dock__slider" \n            min="${t.min}" \n            max="${t.max}" \n            step="${t.step}">\n          <span class="sound-dock__val" id="sound_${t.id}_val">${t.format(t.fromConfig(0))}</span>\n        </label>`;e+="</div></div>"}return e}()}\n  </div>\n`,t.appendChild(n),t.appendChild(a);const o=n.querySelector(".collapse-btn");return o&&o.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),mt(t)}),n.addEventListener("click",e=>{at||e.target.closest("button")||mt(t)}),setTimeout(()=>function(e){const t=e.querySelector("#soundEnableBtn"),n=e.querySelector("#soundControlsWrapper"),a=e.querySelector("#soundPresetSelect"),o=e.querySelector("#presetDescription");if(t&&t.addEventListener("click",async()=>{if($().isUnlocked){const e=V();t.textContent=e?"üîä Sound On":"üîá Sound Off",t.style.background=e?"rgba(76, 175, 80, 0.3)":"",n&&(n.style.display=e?"":"none"),ht(e)}else await F()&&(t.textContent="üîä Sound On",t.style.background="rgba(76, 175, 80, 0.3)",n&&(n.style.display=""),ht(!0))}),a){for(const[e,t]of Object.entries(g)){const n=document.createElement("option");n.value=e,n.textContent=t.label,a.appendChild(n)}a.value=z(),o&&g[z()]&&(o.textContent=g[z()].description),a.addEventListener("change",()=>{!function(e){const t=g[e];if(!t)return console.warn(`Unknown sound preset: ${e}`),!1;p=e;const{label:n,description:a,...o}=t;K(o),console.log(`üéµ Applied sound preset: ${t.label}`)}(a.value),o&&g[a.value]&&(o.textContent=g[a.value].description),Xe(e,H)})}(function(e,t,n){for(const t of Object.values(ze))for(const a of t.controls){const t=e.querySelector(`#sound_${a.id}`),o=e.querySelector(`#sound_${a.id}_val`);t&&t.addEventListener("input",()=>{const e=parseFloat(t.value),i=a.toConfig(e);o&&(o.textContent=a.format(e)),n({[a.id]:i})})}})(e,0,K),Xe(e,H)}(t),0),t}(),Ue.appendChild(je),Ue.appendChild(Ye),Qe=function(){const e=document.createElement("button");return e.className="dock-toggle",e.id="dockToggle",e.setAttribute("aria-label","Show panels"),e.innerHTML="‚öôÔ∏è",e.addEventListener("click",()=>{Ue.classList.remove("hidden"),e.style.opacity="0",e.style.pointerEvents="none"}),e}(),document.body.appendChild(Ue),document.body.appendChild(Qe),e&&Qe&&(Qe.style.opacity="1",Qe.style.pointerEvents="auto"),document.addEventListener("keydown",e=>{if(!["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName))switch(e.key){case"s":case"S":Ue&&!Ue.classList.contains("hidden")&&je&&mt(je);break;case"c":case"C":if(e.ctrlKey||e.metaKey)return;Ue&&!Ue.classList.contains("hidden")&&Ye&&mt(Ye)}}),Ue&&(Ue.querySelectorAll(".panel-header").forEach(e=>{const t=e.querySelector(".panel-title");if(t&&!t.querySelector(".drag-indicator")){const e=document.createElement("span");e.className="drag-indicator",e.innerHTML="‚ãÆ‚ãÆ",e.setAttribute("aria-hidden","true"),t.insertBefore(e,t.firstChild)}e.addEventListener("mousedown",ct),e.addEventListener("touchstart",ct,{passive:!1})}),document.addEventListener("mousemove",dt),document.addEventListener("mouseup",ut),document.addEventListener("touchmove",dt,{passive:!1}),document.addEventListener("touchend",ut),function(){try{const e=JSON.parse(localStorage.getItem(Je)||"{}");[Ye,je].forEach(t=>{if(!t)return;const n=e[t.id];n&&n.useCustomPosition&&(t.style.position="fixed",t.style.left=n.left,t.style.top=n.top,t.style.right="auto",t.style.zIndex="10001")})}catch(e){}}()),console.log("‚úì Panel dock created")}(),u(),console.log("‚úì Panel dock created (Sound + Controls)"),window.addEventListener("keydown",e=>{if(["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName))return;const n=e.key.toLowerCase();if("/"===n||"Slash"===e.code)return e.preventDefault(),void function(){if(!Ue)return;const e=Ue.classList.toggle("hidden");!function(e){try{localStorage.setItem(Ze,String(e))}catch(e){}}(e),Qe&&(Qe.style.opacity=e?"1":"0",Qe.style.pointerEvents=e?"auto":"none")}();"1"===n?(e.preventDefault(),Oe(t.PIT),He("pit")):"2"===n?(e.preventDefault(),Oe(t.FLIES),He("flies")):"3"===n?(e.preventDefault(),Oe(t.WEIGHTLESS),He("weightless")):"4"===n?(e.preventDefault(),Oe(t.WATER),He("water")):"5"===n?(e.preventDefault(),Oe(t.VORTEX),He("vortex")):"6"===n?(e.preventDefault(),Oe(t.PING_PONG),He("ping-pong")):"7"===n?(e.preventDefault(),Oe(t.MAGNETIC),He("magnetic")):"8"===n&&(e.preventDefault(),Oe(t.BUBBLES),He("bubbles"))}),console.log("‚úì Keyboard shortcuts registered"),console.log("‚úì Keyboard shortcuts registered"),function(){const e=document.getElementById("cv-gate-trigger"),t=document.getElementById("brand-logo"),n=document.getElementById("cv-gate"),a=Array.from(document.querySelectorAll(".cv-digit")),o=document.body;if(!e||!t||!n||0===a.length)return void console.warn("CV Gate: Missing required elements");let i=!1;const l=()=>{i=!1,a.forEach(e=>e.value=""),n.classList.remove("active"),t.classList.remove("fade-out-up"),setTimeout(()=>{i||n.classList.add("hidden")},400)},s=()=>{const e=a.map(e=>e.value).join("");4===e.length&&("1111"===e?(o.classList.add("flash-green"),setTimeout(()=>{window.location.href="cv-test.html"},400)):(o.classList.add("flash-red"),setTimeout(()=>{o.classList.remove("flash-red"),a.forEach(e=>e.value=""),a[0].focus()},400)))};e.addEventListener("click",e=>{e.preventDefault(),i=!0,t.classList.add("fade-out-up"),n.classList.remove("hidden"),n.offsetWidth,n.classList.add("active"),a[0].focus()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&i&&l()}),a.forEach((e,t)=>{e.addEventListener("keydown",n=>{"Backspace"===n.key&&""===e.value&&(t>0?a[t-1].focus():l())}),e.addEventListener("input",e=>{const n=e.target.value;if(/^\d*$/.test(n)){if(1===n.length)t<a.length-1?a[t+1].focus():s();else if(n.length>1){const o=n.split("");e.target.value=o[0];let i=t+1;for(let e=1;e<o.length&&i<a.length;e++)a[i].value=o[e],i++;i<a.length?a[i].focus():s()}}else e.target.value=n.replace(/\D/g,"")}),e.addEventListener("focus",()=>{e.select()})})}(),console.log("‚úì Password gate initialized"),function(){if(D(),"undefined"!=typeof window&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches)return console.log("‚è∏ Sound toggle hidden (prefers-reduced-motion)"),null;Qt=document.createElement("button"),Qt.className="sound-toggle footer_link is-orange",Qt.id="sound-toggle",Qt.type="button",Qt.setAttribute("aria-label","Toggle collision sounds"),Qt.setAttribute("aria-pressed","false"),Qt.setAttribute("data-enabled","false"),Qt.style.background="none",Qt.style.border="none",Qt.style.padding="0",Qt.style.font="inherit",Qt.style.cursor="pointer",Qt.style.position="fixed",Qt.style.zIndex="200",Qt.style.bottom="3.5em",Qt.style.left="4em",Qt.textContent="Sound Off",Qt.addEventListener("click",Jt),document.body.appendChild(Qt),console.log("‚úì Sound toggle created")}(),console.log("‚úì Sound toggle button created"),function(){if(document.getElementById("theme-toggle-btn"))return;const e=document.createElement("button");e.id="theme-toggle-btn",e.className="theme-toggle",e.setAttribute("aria-label","Toggle dark mode"),e.setAttribute("type","button"),en(e),e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n="dark"===be()?"light":"dark";pe(n),en(e);const a=document.getElementById("announcer");a&&(a.textContent=`Theme switched to ${n} mode`)}),document.body.appendChild(e)}(),console.log("‚úì Theme toggle button created"),function(){const e=document.createElement("div");e.id="layout-panel",Object.assign(e.style,{position:"fixed",top:"20px",left:"20px",width:"220px",padding:"16px",background:"var(--bg-light)",color:"var(--text-color)",borderRadius:"12px",boxShadow:"0 4px 20px rgba(0,0,0,0.15)",zIndex:"10000",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',fontSize:"13px",display:"flex",flexDirection:"column",gap:"12px",backdropFilter:"blur(10px)",border:"1px solid rgba(128,128,128,0.2)"});const t=e=>{const t=getComputedStyle(document.documentElement).getPropertyValue(e).trim();return parseInt(t)||0};tn(e,"Padding","--container-border",0,100,t("--container-border")),tn(e,"Radius","--wall-radius",0,100,t("--wall-radius"));const n=document.createElement("button");n.textContent="Toggle Theme",Object.assign(n.style,{padding:"8px 12px",borderRadius:"6px",border:"1px solid currentColor",background:"transparent",color:"inherit",cursor:"pointer",fontSize:"12px",fontWeight:"500",marginTop:"4px"}),n.onclick=()=>{pe("light"===me?"dark":"light")},e.appendChild(n),document.body.appendChild(e)}(),console.log("‚úì Layout panel created"),Oe(t.FLIES),console.log("‚úì Mode initialized");const r=()=>We();jt((e,t)=>{const n=r();n&&n(e,t)}),console.log("‚úÖ Bouncy Balls running (modular)"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{document.body.classList.add("page-ready"),console.log("‚úì Page fade-in triggered")})})}catch(e){console.error("‚ùå Initialization failed:",e),document.body.innerHTML=`<div style="padding: 20px; color: red; background: white;">\n      <h2>Initialization Error</h2>\n      <pre>${e.message}\n${e.stack}</pre>\n    </div>`}}(),e.applyFramePaddingCSSVars=nn,e.applyVisualCSSVars=an,e}({});
