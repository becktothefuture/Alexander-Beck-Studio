function t(){v=[];for(let t=0;64>t;t++)v[t]=[]}function a(t,a,M,h){const n=Math.min(7,Math.max(0,t.x/a*8|0)),o=Math.min(7,Math.max(0,t.y/M*8|0));h.length=0;for(let s=-1;1>=s;s++){const a=o+s;if(a>=0&&8>a)for(let M=-1;1>=M;M++){const o=n+M;if(0>o||o>=8)continue;const s=v[8*a+o];for(let a=0;s.length>a;a++)s[a]!==t&&h.push(s[a])}}return h}function M(){const t=m(),a=t.hiveJourneyPointCount||4,M=t.hiveJourneyPointMargin||.05;q=[];const h=1-2*M,n=[{xMin:0,xMax:.5,yMin:0,yMax:.5},{xMin:.5,xMax:1,yMin:0,yMax:.5},{xMin:0,xMax:.5,yMin:.5,yMax:1},{xMin:.5,xMax:1,yMin:.5,yMax:1}];for(let o=0;a>o;o++){let t,a;if(4>o){const s=n[o];t=M+Math.max(0,s.xMin*h)+Math.random()*(s.xMax-s.xMin)*h,a=M+Math.max(0,s.yMin*h)+Math.random()*(s.yMax-s.yMin)*h}else t=M+Math.random()*h,a=M+Math.random()*h;q.push({x:t,y:a})}}function h(t){if(0===q.length&&M(),(m().hivePathAdherence??.75)>Math.random()&&q.length>1){const a=(t+1)%q.length;return{point:q[a],index:a}}{let a=Math.floor(Math.random()*q.length);return q.length>1&&a===t&&(a=(a+1)%q.length),{point:q[a],index:a}}}function n(){F=.5,O=2+3*Math.random(),P=0,k=!1,b=0,M()}function o(){C.fill(0)}function s(t,a,M,h){const n=Math.min(31,Math.max(0,t/M*z|0)),o=Math.min(31,Math.max(0,a/h*z|0));let s=0,c=0;const f=C[o*z+n];return n>0&&(s-=C[o*z+(n-1)]-f),31>n&&(s+=C[o*z+(n+1)]-f),o>0&&(c-=C[(o-1)*z+n]-f),31>o&&(c+=C[(o+1)*z+n]-f),{dx:s,dy:c}}function c(t,a,M){return a>t?a:t>M?M:t}function f(t){return t>Math.PI?t-=2*Math.PI:-Math.PI>t&&(t+=2*Math.PI),t}function i(){const a=m();y();const M=a.canvas.width,s=a.canvas.height;D=M,E=s,o(),n(),t();const f=a.R_MIN||8,i=Math.max(1,(a.R_MAX||24)-f),e=w(Math.max(10,Math.min(260,0|a.critterCount)));if(e>0)for(let t=0;e>t;t++){const t=Math.random()*M|0,n=Math.random()*s|0,o=d(g[Math.floor(Math.random()*g.length)]),e=x(t,n,o),r=p(a,j.CRITTERS);e.r=r,e.rBase=r,e.m=Math.max(1,r*r*.12);const l=Math.random()*Math.PI*2,u=20+30*Math.random();e.vx=Math.cos(l)*u,e.vy=Math.sin(l)*u,e.t=!0,e.M=l,e.h=Math.random(),e.o=e.h,e.i=0,e.l=0;const y=a.critterNervousnessMin??.4,m=a.critterNervousnessMax??1;e.u=y+Math.random()*(m-y),e.p=Math.random(),e.j=1.2*(Math.random()-.5),e.A=.1+.4*Math.random();const w=c((r-f)/i,0,1);e.v=1+.5*(1-w),e.B=Math.random()*Math.PI*2,e.F=0,e.O=0,e.P=0,e.S=2*Math.random(),e.T=0;const A=h(Math.floor(Math.random()*(a.hiveJourneyPointCount||4)));e.k=A.point.x,e.q=A.point.y,e.C=A.index,e.D=3+8*Math.random(),e.G=.5+.5*Math.random(),e.H=.02+.03*Math.random(),e.I=Math.max(0,Math.min(1,(a.critterCuriosityBias??.5)+.6*(Math.random()-.5))),e.J=Math.random()*Math.PI*2,e.K=0}}function e(a){const M=m();if(!M.canvas)return;const h=M.canvas.width,s=M.canvas.height,c=M.balls;h===D&&s===E||(D=h,E=s,o(),n(),t()),(t=>{const a=Math.pow(.997,60*t);for(let M=0;1024>M;M++)C[M]*=a})(a),((t,a,M)=>{for(let h=0;64>h;h++)v[h].length=0;for(let h=0;t.length>h;h++){const n=t[h],o=Math.min(7,Math.max(0,n.x/a*8|0));v[8*Math.min(7,Math.max(0,n.y/M*8|0))+o].push(n)}})(c,h,s),B++;let f=0,i=0;for(let t=0;c.length>t;t++){const a=c[t];a.vx*a.vx+a.vy*a.vy>200&&f++,i+=a.l||0}F=.95*F+.05*(c.length>0?f/c.length:0),P=c.length>0?i/c.length:0;const e=M.critterHiveStirInterval??5,r=M.critterHiveWaveSpeed??.4;O-=a,O>0&&F>=.3||(S=.1+.8*Math.random(),T=.1+.8*Math.random(),b=0,k=!0,O=e*(.6+.8*Math.random())),k&&(b+=a*r,b>1.5&&(k=!1))}function r(t,M){const n=m(),o=n.canvas;if(!o)return;const i=n.DPR||1,e=Math.max(0,n.critterSpeed||0),r=Math.max(50,n.critterMaxSpeed||0)*i,l=Math.max(0,n.critterStepHz||0),u=n.critterStepSharpness??2.4,x=Math.max(0,n.critterTurnNoise||0),y=Math.max(0,n.critterTurnSeek||0),d=Math.max(0,(n.critterAvoidRadius||0)*i),p=Math.max(0,n.critterAvoidForce||0),w=Math.max(0,n.critterEdgeAvoid||0),j=Math.max(0,n.critterMousePull||0),A=Math.max(0,n.critterMouseRadiusVw||0),g=o.width,v=o.height,F=t.v||1,O=e*F*.7,q=l*F;let D=t.M||0,E=t.h||0,G=t.o??E,H=t.i||0,I=t.l||0,J=t.B||D,K=t.F||0,L=t.O||0,N=t.P||0,Q=t.S||0,R=t.T||0,U=t.k??.5,V=t.q??.5,W=t.D||5,X=t.C??0,Y=t.G??.7;const Z=t.H||.025,$=t.I||.5;let _=t.J||0,tt=t.K||0;const at=t.u||.5,Mt=t.p||.5,ht=t.j||0,nt=t.A||.2;let ot=0,st=0,ct=0,ft=0,it=0,et=0,rt=0,lt=0;if(t.vx*=Math.pow(.88,60*M),t.vy*=Math.pow(.88,60*M),j>0&&-1e9!==n.mouseX){const a=(window.innerWidth||g)/100,h=Math.max(1,A*a)*i,o=1.5*h,s=t.x-n.mouseX,c=t.y-n.mouseY,f=Math.sqrt(s*s+c*c)+1e-6;if(o>f)if(ft=s/f,it=c/f,h>f){const t=1-f/h;ct=t*t*at,I=Math.min(1,I+3*ct*M),ot+=ft*ct*1.5,st+=it*ct*1.5}else{const t=.3*(1-(f-h)/(o-h))*at;ot+=ft*t*2,st+=it*t*2,I=Math.min(1,I+2*t*M)}}if(d>0){const h=((t,M,h)=>!1===m().featureCrittersNeighborCacheEnabled?a(t,M,h,[]):(t.L===B&&Array.isArray(t.N)||(t.N=a(t,M,h,Array.isArray(t.N)?t.N:[]),t.L=B),t.N))(t,g,v),n=d*d,o=1.5*d,s=o*o;let c=0,f=0;for(let a=0;h.length>a;a++){const M=h[a],i=t.x-M.x,e=t.y-M.y,r=i*i+e*e;if(p>0&&r>0&&n>r){const t=1/Math.sqrt(r),a=1-1/t/d;et+=i*t*a*a,rt+=e*t*a*a,lt++}if(r>0&&s>r){const t=M.l||0;t>.2&&(c+=t*(1-1/(1/Math.sqrt(r))/o),f++)}}f>0&&(I=Math.min(1,I+c/f*at*.5*M))}if(.01>ct&&(I=Math.max(0,I-2*M),.15>I&&I>.01&&0>=R&&(R=.3+.5*Math.random())),R>0&&(R=Math.max(0,R-M)),K>0&&(K=Math.max(0,K-M)),L>0&&(L=Math.max(0,L-M)),N>0&&(N=Math.max(0,N-M)),Q-=M,Q>0||(Q=1+1.5*Math.random(),200>t.vx*t.vx+t.vy*t.vy&&(H>.2&&(H=.2),Y=Math.min(1,Y+.2))),k){const a=t.x/g,M=t.y/v,h=.12,n=Math.abs(Math.sqrt((a-S)*(a-S)+(M-T)*(M-T))-b);h>n&&(H>.1&&(H=.1),Y=Math.min(1,Y+.15*(1-n/h)))}const ut=.5*P,xt=c(I,0,1),yt=R>0;Y=Math.max(.3,Y-(H>0?.003:.5*Z)*(1+.5*xt)*M),Y=Math.min(1,Y+.02*M+(.2>xt?.05*M:0));const dt=.8+.2*Y,pt=n.hiveGoalSwitchMinS??4,mt=n.hiveGoalSwitchMaxS??14,wt=(n.hiveGoalReachedRadius??50)*i,jt=n.hiveGoalAttractionStrength??.5;if(W-=M,0>=W||xt>.5){const t=h(X);U=t.point.x,V=t.point.y,X=t.index;const a=Math.max(0,mt-pt);W=pt+Math.random()*a+5*(1-Y)}if(.15>xt&&0>=H){const a=U*g-t.x,M=V*v-t.y,h=Math.sqrt(a*a+M*M)+1e-6;wt>h&&(W=Math.min(W,1+2*Math.random()));const n=jt*Y*(1-6*xt);ot+=a/h*n,st+=M/h*n}if($>.4&&.2>xt){const a=s(t.x,t.y,g,v),M=.2*$*(1-5*xt);ot-=a.dx*M,st-=a.dy*M}tt=ct>tt?ct:Math.max(0,tt-3*M),_+=M*(1.5+2*xt),_>2*Math.PI&&(_-=2*Math.PI),xt>.4&&0>=L&&4.8*M>Math.random()&&(L=.03+.04*Math.random());const At=L>0;if(H>0)H=Math.max(0,H-M),N>0&&(D=f(D+.15*Math.sin(15*N)*M)),18*M>Math.random()&&(t.vx+=1*(Math.random()-.5),t.vy+=1*(Math.random()-.5)),H>0||(K=.12,N=0);else if(.1>xt&&!yt&&.3>ut&&(.08+.12*Mt)*(1-ut)*M>Math.random()){const t=.15+.1*Mt,a=.3+.5*Mt;H=t+Math.random()*(a-t),N=H}yt&&R>1+.5*Math.random()&&0>=H&&18*M>Math.random()&&(H=.1+.15*Math.random()),xt>.2&&(H=0,N=0),.15>xt&&(J=f(J+(2*Math.random()-1)*nt*M));const gt=Math.max(24*i,.08*Math.min(g,v)),vt=t.x,Bt=t.y;if(xt>.1&&w>0)gt>vt?ot+=(1-vt/gt)*w:vt>g-gt&&(ot-=(1-(g-vt)/gt)*w),gt>Bt?st+=(1-Bt/gt)*w:Bt>v-gt&&(st-=(1-(v-Bt)/gt)*w);else if(.1>xt){const t=.3,a=2*gt;a>vt?ot-=(1-vt/a)*t:vt>g-a&&(ot+=(1-(g-vt)/a)*t),a>Bt?st-=(1-Bt/a)*t:Bt>v-a&&(st+=(1-(v-Bt)/a)*t)}if(xt>.03&&(0!==ft||0!==it)){const t=ht*xt,a=Math.cos(t),M=Math.sin(t),h=j*(.6+xt);ot+=(ft*a-it*M)*h,st+=(ft*M+it*a)*h}if(.2>xt){const a=s(t.x,t.y,g,v),M=.3*(1-5*xt);ot+=a.dx*M,st+=a.dy*M}if(((t,a,M,h,n)=>{const o=((t,a,M,h)=>{const n=Math.min(31,Math.max(0,t/M*z|0));return Math.min(31,Math.max(0,a/h*z|0))*z+n})(t,a,M,h);C[o]=Math.min(1,C[o]+n)})(t.x,t.y,g,v,1.5*M),.1>xt&&0>=H&&(ot+=.4*Math.cos(J),st+=.4*Math.sin(J)),d>0&&p>0&&lt>0){const a=1/lt,h=et*a,n=rt*a;ot+=1.2*h,st+=1.2*n,t.vx+=.5*h*p*M,t.vy+=.5*n*p*M}const Ft=(2*Math.random()-1)*x*M;if(ot*ot+st*st>1e-6){const t=Math.atan2(st,ot);let a=f(t-D);if(Math.abs(a)>.3&&.5>xt){const M=(t=>{const a=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,3*-Math.PI/4,-Math.PI/2,-Math.PI/4];let M=t,h=1/0;for(let n=0;a.length>n;n++){const o=Math.abs(f(t-a[n]));h>o&&(h=o,M=a[n])}return t+.4*f(M-t)})(t);a=f(M-D)}D=f(D+a*y*M+Ft)}else D=f(D+Ft);D=f(D),q>0&&(G=E,E+=q*(1+.5*xt)*M,E-=0|E);const Ot=H>0||At,Pt=Ot?0:((t,a)=>{const M=(h=c(h=.5>t?2*t:2-2*t,0,1))*h*(3-2*h);var h;const n=c(a,.5,6);return Math.pow(M,n)})(E,u),St=(1+.43*xt)*(K>0?1.15:1)*(yt?.5:1)*dt;if(!Ot&&E>.82){const a=(E-.82)/.18*.08;a>t.squashAmount&&(t.squashAmount=a,t.squashNormalAngle=-Math.PI/2)}if(!Ot&&q>0&&G>E){const a=Math.max(.25,t.m/(n.MASS_BASELINE_KG||129)),M=O*(.5+.5*Pt)*St*(.85+.3*Math.random()),h=Math.cos(D),o=Math.sin(D);t.vx+=h*M/a,t.vy+=o*M/a,t.squashAmount=Math.max(t.squashAmount,.18+.1*xt),t.squashNormalAngle=Math.PI/2}if(!Ot){const a=O*(.1+.2*Pt)*St;t.vx+=Math.cos(D)*a*M,t.vy+=Math.sin(D)*a*M}const Tt=r*F,bt=t.vx,kt=t.vy,qt=bt*bt+kt*kt;if(qt>Tt*Tt){const a=Tt/(Math.sqrt(qt)+1e-6);t.vx=bt*a,t.vy=kt*a}const zt=t.rBase||t.r,Ct=Ot?.03:.015,Dt=1+Math.sin(_)*Ct,Et=1+.08*tt,Gt=Ot?0:.02*Math.sin(E*Math.PI*2);t.r=zt*Dt*Et*(.95+.05*Y),!Ot&&qt>100&&(t.squashAmount=Math.max(t.squashAmount,Math.min(.06,1e-4*Math.sqrt(qt))+Gt),t.squashNormalAngle=D+Math.PI/2),t.M=D,t.h=E,t.o=G,t.i=H,t.l=I,t.B=J,t.F=K,t.O=L,t.P=N,t.S=Q,t.T=R,t.k=U,t.q=V,t.D=W,t.C=X,t.G=Y,t.J=_,t.K=tt,t.theta=D}function l(t){const a=m();if(!1===a.hiveWaypointVisible)return;if(0===q.length)return;const M=a.canvas;if(!M)return;const h=M.width,n=M.height,o=a.hiveWaypointOpacity??1,s=((a.R_MIN+a.R_MAX)/2||12)*(a.hiveWaypointSizeMul??1.5);(()=>{const t=m(),a=t.hiveJourneyPointCount||4,M=t.currentTemplate||"industrialTeal";if(G.length!==a||H!==a||I!==M){G=[];for(let t=0;a>t;t++)G.push(d(A[t%A.length]));H=a,I=M}})(),t.save(),t.globalAlpha=o;for(let c=0;q.length>c;c++){const a=q[c],M=a.x*h,o=a.y*n,f=G[c]||"#ffffff";t.beginPath(),t.arc(M,o,s,0,2*Math.PI),t.fillStyle=f,t.fill()}t.restore()}function u(){return q}import{s as x}from"./spawn.js";import{al as y,aS as d,aP as p,g as m,aO as w,an as j}from"./shared.js";import"./Ball.js";const A=[3,5,6,7],g=[0,1,2,3,4,5,6,7];let v=[],B=0,F=.5,O=0,P=0,S=.5,T=.5,b=0,k=!1,q=[];const z=32;let C=new Float32Array(1024),D=0,E=0,G=[],H=0,I=null;export{r as applyCrittersForces,u as getJourneyPoints,i as initializeCritters,l as renderCrittersWaypoints,e as updateCrittersGrid};