function t(){g=[];for(let t=0;64>t;t++)g[t]=[]}function a(t,a,M,h){const n=Math.min(7,Math.max(0,t.x/a*8|0)),o=Math.min(7,Math.max(0,t.y/M*8|0));h.length=0;for(let s=-1;1>=s;s++){const a=o+s;if(a>=0&&8>a)for(let M=-1;1>=M;M++){const o=n+M;if(0>o||o>=8)continue;const s=g[8*a+o];for(let a=0;s.length>a;a++)s[a]!==t&&h.push(s[a])}}return h}function M(){const t=m(),a=t.hiveJourneyPointCount||4,M=t.hiveJourneyPointMargin||.05;z=[];const h=1-2*M,n=[{xMin:0,xMax:.5,yMin:0,yMax:.5},{xMin:.5,xMax:1,yMin:0,yMax:.5},{xMin:0,xMax:.5,yMin:.5,yMax:1},{xMin:.5,xMax:1,yMin:.5,yMax:1}];for(let o=0;a>o;o++){let t,a;if(4>o){const s=n[o];t=M+Math.max(0,s.xMin*h)+Math.random()*(s.xMax-s.xMin)*h,a=M+Math.max(0,s.yMin*h)+Math.random()*(s.yMax-s.yMin)*h}else t=M+Math.random()*h,a=M+Math.random()*h;z.push({x:t,y:a})}}function h(t){if(0===z.length&&M(),(m().hivePathAdherence??.75)>Math.random()&&z.length>1){const a=(t+1)%z.length;return{point:z[a],index:a}}{let a=Math.floor(Math.random()*z.length);return z.length>1&&a===t&&(a=(a+1)%z.length),{point:z[a],index:a}}}function n(){B=.5,F=2+3*Math.random(),P=0,q=!1,k=0,M()}function o(){D.fill(0)}function s(t,a,M,h){const n=Math.min(31,Math.max(0,t/M*C|0)),o=Math.min(31,Math.max(0,a/h*C|0));let s=0,c=0;const f=D[o*C+n];return n>0&&(s-=D[o*C+(n-1)]-f),31>n&&(s+=D[o*C+(n+1)]-f),o>0&&(c-=D[(o-1)*C+n]-f),31>o&&(c+=D[(o+1)*C+n]-f),{dx:s,dy:c}}function c(t,a,M){return a>t?a:t>M?M:t}function f(t){return t>Math.PI?t-=2*Math.PI:-Math.PI>t&&(t+=2*Math.PI),t}function i(){const a=m();y();const M=a.canvas.width,s=a.canvas.height;E=M,G=s,o(),n(),t();const f=a.R_MIN||8,i=Math.max(1,(a.R_MAX||24)-f),e=w(Math.max(10,Math.min(260,0|a.critterCount)));if(e>0)for(let t=0;e>t;t++){const t=Math.random()*M|0,n=Math.random()*s|0,o=d(T[Math.floor(Math.random()*T.length)]),e=x(t,n,o),r=p(a,j.CRITTERS);e.r=r,e.rBase=r,e.m=Math.max(1,r*r*.12);const l=Math.random()*Math.PI*2,u=20+30*Math.random();e.vx=Math.cos(l)*u,e.vy=Math.sin(l)*u,e.t=!0,e.M=l,e.h=Math.random(),e.o=e.h,e.i=0,e.l=0;const y=a.critterNervousnessMin??.4,m=a.critterNervousnessMax??1;e.u=y+Math.random()*(m-y),e.p=Math.random(),e.j=1.2*(Math.random()-.5),e.A=.1+.4*Math.random();const w=c((r-f)/i,0,1);e.T=1+.5*(1-w),e.v=Math.random()*Math.PI*2,e.B=0,e.F=0,e.P=0,e.k=2*Math.random(),e.q=0;const A=h(Math.floor(Math.random()*(a.hiveJourneyPointCount||4)));e.C=A.point.x,e.D=A.point.y,e.G=A.index,e.H=3+8*Math.random(),e.I=.5+.5*Math.random(),e.J=.02+.03*Math.random(),e.K=Math.max(0,Math.min(1,(a.critterCuriosityBias??.5)+.6*(Math.random()-.5))),e.L=Math.random()*Math.PI*2,e.N=0}}function e(a){const M=m();if(!M.canvas)return;const h=M.canvas.width,s=M.canvas.height,c=M.balls;h===E&&s===G||(E=h,G=s,o(),n(),t()),(t=>{const a=Math.pow(.997,60*t);for(let M=0;1024>M;M++)D[M]*=a})(a),((t,a,M)=>{for(let h=0;64>h;h++)g[h].length=0;for(let h=0;t.length>h;h++){const n=t[h],o=Math.min(7,Math.max(0,n.x/a*8|0));g[8*Math.min(7,Math.max(0,n.y/M*8|0))+o].push(n)}})(c,h,s),v++;let f=0,i=0;for(let t=0;c.length>t;t++){const a=c[t];a.vx*a.vx+a.vy*a.vy>200&&f++,i+=a.l||0}B=.95*B+.05*(c.length>0?f/c.length:0),P=c.length>0?i/c.length:0;const e=M.critterHiveStirInterval??5,r=M.critterHiveWaveSpeed??.4;F-=a,F>0&&B>=.3||(Q=.1+.8*Math.random(),b=.1+.8*Math.random(),k=0,q=!0,F=e*(.6+.8*Math.random())),q&&(k+=a*r,k>1.5&&(q=!1))}function r(t,M){const n=m(),o=n.canvas;if(!o)return;const i=n.DPR||1,e=Math.max(0,n.critterSpeed||0),r=Math.max(50,n.critterMaxSpeed||0)*i,l=Math.max(0,n.critterStepHz||0),u=n.critterStepSharpness??2.4,x=Math.max(0,n.critterTurnNoise||0),y=Math.max(0,n.critterTurnSeek||0),d=Math.max(0,(n.critterAvoidRadius||0)*i),p=Math.max(0,n.critterAvoidForce||0),w=Math.max(0,n.critterEdgeAvoid||0),j=Math.max(0,n.critterMousePull||0),A=Math.max(0,n.critterMouseRadiusVw||0),T=o.width,g=o.height,B=t.T||1,F=e*B*.7,z=l*B;let E=t.M||0,G=t.h||0,H=t.o??G,I=t.i||0,J=t.l||0,K=t.v||E,L=t.B||0,N=t.F||0,O=t.P||0,R=t.k||0,S=t.q||0,U=t.C??.5,V=t.D??.5,W=t.H||5,X=t.G??0,Y=t.I??.7;const Z=t.J||.025,$=t.K||.5;let _=t.L||0,tt=t.N||0;const at=t.u||.5,Mt=t.p||.5,ht=t.j||0,nt=t.A||.2;let ot=0,st=0,ct=0,ft=0,it=0,et=0,rt=0,lt=0;if(t.vx*=Math.pow(.88,60*M),t.vy*=Math.pow(.88,60*M),j>0&&-1e9!==n.mouseX){const a=(window.innerWidth||T)/100,h=Math.max(1,A*a)*i,o=1.5*h,s=t.x-n.mouseX,c=t.y-n.mouseY,f=Math.sqrt(s*s+c*c)+1e-6;if(o>f)if(ft=s/f,it=c/f,h>f){const t=1-f/h;ct=t*t*at,J=Math.min(1,J+3*ct*M),ot+=ft*ct*1.5,st+=it*ct*1.5}else{const t=.3*(1-(f-h)/(o-h))*at;ot+=ft*t*2,st+=it*t*2,J=Math.min(1,J+2*t*M)}}if(d>0){const h=((t,M,h)=>!1===m().featureCrittersNeighborCacheEnabled?a(t,M,h,[]):(t.O===v&&Array.isArray(t.R)||(t.R=a(t,M,h,Array.isArray(t.R)?t.R:[]),t.O=v),t.R))(t,T,g),n=d*d,o=1.5*d,s=o*o;let c=0,f=0;for(let a=0;h.length>a;a++){const M=h[a],i=t.x-M.x,e=t.y-M.y,r=i*i+e*e;if(p>0&&r>0&&n>r){const t=1/Math.sqrt(r),a=1-1/t/d;et+=i*t*a*a,rt+=e*t*a*a,lt++}if(r>0&&s>r){const t=M.l||0;t>.2&&(c+=t*(1-1/(1/Math.sqrt(r))/o),f++)}}f>0&&(J=Math.min(1,J+c/f*at*.5*M))}if(.01>ct&&(J=Math.max(0,J-2*M),.15>J&&J>.01&&0>=S&&(S=.3+.5*Math.random())),S>0&&(S=Math.max(0,S-M)),L>0&&(L=Math.max(0,L-M)),N>0&&(N=Math.max(0,N-M)),O>0&&(O=Math.max(0,O-M)),R-=M,R>0||(R=1+1.5*Math.random(),200>t.vx*t.vx+t.vy*t.vy&&(I>.2&&(I=.2),Y=Math.min(1,Y+.2))),q){const a=t.x/T,M=t.y/g,h=.12,n=Math.abs(Math.sqrt((a-Q)*(a-Q)+(M-b)*(M-b))-k);h>n&&(I>.1&&(I=.1),Y=Math.min(1,Y+.15*(1-n/h)))}const ut=.5*P,xt=c(J,0,1),yt=S>0;Y=Math.max(.3,Y-(I>0?.003:.5*Z)*(1+.5*xt)*M),Y=Math.min(1,Y+.02*M+(.2>xt?.05*M:0));const dt=.8+.2*Y,pt=n.hiveGoalSwitchMinS??4,mt=n.hiveGoalSwitchMaxS??14,wt=(n.hiveGoalReachedRadius??50)*i,jt=n.hiveGoalAttractionStrength??.5;if(W-=M,0>=W||xt>.5){const t=h(X);U=t.point.x,V=t.point.y,X=t.index;const a=Math.max(0,mt-pt);W=pt+Math.random()*a+5*(1-Y)}if(.15>xt&&0>=I){const a=U*T-t.x,M=V*g-t.y,h=Math.sqrt(a*a+M*M)+1e-6;wt>h&&(W=Math.min(W,1+2*Math.random()));const n=jt*Y*(1-6*xt);ot+=a/h*n,st+=M/h*n}if($>.4&&.2>xt){const a=s(t.x,t.y,T,g),M=.2*$*(1-5*xt);ot-=a.dx*M,st-=a.dy*M}tt=ct>tt?ct:Math.max(0,tt-3*M),_+=M*(1.5+2*xt),_>2*Math.PI&&(_-=2*Math.PI),xt>.4&&0>=N&&4.8*M>Math.random()&&(N=.03+.04*Math.random());const At=N>0;if(I>0)I=Math.max(0,I-M),O>0&&(E=f(E+.15*Math.sin(15*O)*M)),18*M>Math.random()&&(t.vx+=1*(Math.random()-.5),t.vy+=1*(Math.random()-.5)),I>0||(L=.12,O=0);else if(.1>xt&&!yt&&.3>ut&&(.08+.12*Mt)*(1-ut)*M>Math.random()){const t=.15+.1*Mt,a=.3+.5*Mt;I=t+Math.random()*(a-t),O=I}yt&&S>1+.5*Math.random()&&0>=I&&18*M>Math.random()&&(I=.1+.15*Math.random()),xt>.2&&(I=0,O=0),.15>xt&&(K=f(K+(2*Math.random()-1)*nt*M));const Tt=Math.max(24*i,.08*Math.min(T,g)),gt=t.x,vt=t.y;if(xt>.1&&w>0)Tt>gt?ot+=(1-gt/Tt)*w:gt>T-Tt&&(ot-=(1-(T-gt)/Tt)*w),Tt>vt?st+=(1-vt/Tt)*w:vt>g-Tt&&(st-=(1-(g-vt)/Tt)*w);else if(.1>xt){const t=.3,a=2*Tt;a>gt?ot-=(1-gt/a)*t:gt>T-a&&(ot+=(1-(T-gt)/a)*t),a>vt?st-=(1-vt/a)*t:vt>g-a&&(st+=(1-(g-vt)/a)*t)}if(xt>.03&&(0!==ft||0!==it)){const t=ht*xt,a=Math.cos(t),M=Math.sin(t),h=j*(.6+xt);ot+=(ft*a-it*M)*h,st+=(ft*M+it*a)*h}if(.2>xt){const a=s(t.x,t.y,T,g),M=.3*(1-5*xt);ot+=a.dx*M,st+=a.dy*M}if(((t,a,M,h,n)=>{const o=((t,a,M,h)=>{const n=Math.min(31,Math.max(0,t/M*C|0));return Math.min(31,Math.max(0,a/h*C|0))*C+n})(t,a,M,h);D[o]=Math.min(1,D[o]+n)})(t.x,t.y,T,g,1.5*M),.1>xt&&0>=I&&(ot+=.4*Math.cos(K),st+=.4*Math.sin(K)),d>0&&p>0&&lt>0){const a=1/lt,h=et*a,n=rt*a;ot+=1.2*h,st+=1.2*n,t.vx+=.5*h*p*M,t.vy+=.5*n*p*M}const Bt=(2*Math.random()-1)*x*M;if(ot*ot+st*st>1e-6){const t=Math.atan2(st,ot);let a=f(t-E);if(Math.abs(a)>.3&&.5>xt){const M=(t=>{const a=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,3*-Math.PI/4,-Math.PI/2,-Math.PI/4];let M=t,h=1/0;for(let n=0;a.length>n;n++){const o=Math.abs(f(t-a[n]));h>o&&(h=o,M=a[n])}return t+.4*f(M-t)})(t);a=f(M-E)}E=f(E+a*y*M+Bt)}else E=f(E+Bt);E=f(E),z>0&&(H=G,G+=z*(1+.5*xt)*M,G-=0|G);const Ft=I>0||At,Pt=Ft?0:((t,a)=>{const M=(h=c(h=.5>t?2*t:2-2*t,0,1))*h*(3-2*h);var h;const n=c(a,.5,6);return Math.pow(M,n)})(G,u),Qt=(1+.43*xt)*(L>0?1.15:1)*(yt?.5:1)*dt;if(!Ft&&G>.82){const a=(G-.82)/.18*.08;a>t.squashAmount&&(t.squashAmount=a,t.squashNormalAngle=-Math.PI/2)}if(!Ft&&z>0&&H>G){const a=Math.max(.25,t.m/(n.MASS_BASELINE_KG||129)),M=F*(.5+.5*Pt)*Qt*(.85+.3*Math.random()),h=Math.cos(E),o=Math.sin(E);t.vx+=h*M/a,t.vy+=o*M/a,t.squashAmount=Math.max(t.squashAmount,.18+.1*xt),t.squashNormalAngle=Math.PI/2}if(!Ft){const a=F*(.1+.2*Pt)*Qt;t.vx+=Math.cos(E)*a*M,t.vy+=Math.sin(E)*a*M}const bt=r*B,kt=t.vx,qt=t.vy,zt=kt*kt+qt*qt;if(zt>bt*bt){const a=bt/(Math.sqrt(zt)+1e-6);t.vx=kt*a,t.vy=qt*a}const Ct=t.rBase||t.r,Dt=Ft?.03:.015,Et=1+Math.sin(_)*Dt,Gt=1+.08*tt,Ht=Ft?0:.02*Math.sin(G*Math.PI*2);t.r=Ct*Et*Gt*(.95+.05*Y),!Ft&&zt>100&&(t.squashAmount=Math.max(t.squashAmount,Math.min(.06,1e-4*Math.sqrt(zt))+Ht),t.squashNormalAngle=E+Math.PI/2),t.M=E,t.h=G,t.o=H,t.i=I,t.l=J,t.v=K,t.B=L,t.F=N,t.P=O,t.k=R,t.q=S,t.C=U,t.D=V,t.H=W,t.G=X,t.I=Y,t.L=_,t.N=tt,t.theta=E}function l(t){const a=m();if(!1===a.hiveWaypointVisible)return;if(0===z.length)return;const M=a.canvas;if(!M)return;const h=M.width,n=M.height,o=a.hiveWaypointOpacity??1,s=((a.R_MIN+a.R_MAX)/2||12)*(a.hiveWaypointSizeMul??1.5);(()=>{const t=m(),a=t.hiveJourneyPointCount||4,M=t.currentTemplate||"industrialTeal";if(H.length!==a||I!==a||J!==M){H=[];for(let t=0;a>t;t++)H.push(d(A[t%A.length]));I=a,J=M}})(),t.save(),t.globalAlpha=o;for(let c=0;z.length>c;c++){const a=z[c],M=a.x*h,o=a.y*n,f=H[c]||"#ffffff";t.beginPath(),t.arc(M,o,s,0,2*Math.PI),t.fillStyle=f,t.fill()}t.restore()}function u(){return z}import{s as x}from"./spawn.js";import{am as y,aT as d,aQ as p,g as m,aP as w,ao as j}from"./shared.js";import"./Ball.js";const A=[3,5,6,7],T=[0,1,2,3,4,5,6,7];let g=[],v=0,B=.5,F=0,P=0,Q=.5,b=.5,k=0,q=!1,z=[];const C=32;let D=new Float32Array(1024),E=0,G=0,H=[],I=0,J=null;export{r as applyCrittersForces,u as getJourneyPoints,i as initializeCritters,l as renderCrittersWaypoints,e as updateCrittersGrid};