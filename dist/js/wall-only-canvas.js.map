{"version":3,"file":"wall-only-canvas.js","sources":["../../source/modules/portfolio/wall-only-canvas.js"],"sourcesContent":["// ╔══════════════════════════════════════════════════════════════════════════════╗\n// ║                        PORTFOLIO WALL-ONLY CANVAS                            ║\n// ║                                                                              ║\n// ║  The index page wall is rendered by the simulation canvas via drawWalls().   ║\n// ║  The portfolio page has no balls simulation, but still needs the same wall.  ║\n// ║                                                                              ║\n// ║  This module draws ONLY the rubber wall ring (no balls, no physics loop).    ║\n// ║  It is event-driven (resize/theme change) to avoid per-frame costs.          ║\n// ╚══════════════════════════════════════════════════════════════════════════════╝\n\nimport { getGlobals, setCanvas, setEffectiveDPR } from '../core/state.js';\nimport { drawWalls } from '../physics/wall-state.js';\n\nfunction create2dContext(canvas) {\n  // Match renderer defaults where possible; fall back silently.\n  let ctx = null;\n  try {\n    ctx = canvas.getContext('2d', {\n      alpha: true,\n      desynchronized: true,\n      willReadFrequently: false,\n    });\n  } catch (e) {}\n  if (!ctx) {\n    try { ctx = canvas.getContext('2d'); } catch (e) {}\n  }\n  if (ctx) ctx.imageSmoothingEnabled = false;\n  return ctx;\n}\n\nexport function initPortfolioWallCanvas({\n  containerId = 'bravia-balls',\n  canvasSelector = '.portfolio-wall-canvas',\n} = {}) {\n  const container = document.getElementById(containerId);\n  if (!container) return null;\n\n  /** @type {HTMLCanvasElement | null} */\n  const canvas = container.querySelector(canvasSelector);\n  if (!canvas) return null;\n\n  const ctx = create2dContext(canvas);\n  if (!ctx) return null;\n\n  // Provide canvas references to shared systems that read globals.canvas/ctx.\n  // (We won't boot the full engine, but drawWalls() reads globals + DPR.)\n  setCanvas(canvas, ctx, container);\n\n  const g = getGlobals();\n  // IMPORTANT: `g.DPR` is a getter-only property (backed by state’s internal DPR).\n  // Assigning to it throws in ES module strict mode, which would prevent the wall from drawing.\n  // Use the official setter instead.\n  //\n  // Clamp to avoid huge buffers on high-DPR devices for a static wall.\n  const rawDpr = Number(window.devicePixelRatio || 1);\n  const clamped = Number.isFinite(rawDpr) ? Math.max(1, Math.min(2, rawDpr)) : 1;\n  try { setEffectiveDPR(clamped); } catch (e) {}\n\n  let rafId = 0;\n  let pending = false;\n\n  const resize = () => {\n    // Canvas CSS is calc(100% + 2px), so add 2px to container dimensions for buffer sizing\n    const CSS_EDGE_OVERFLOW = 2;\n    const wCss = container.clientWidth + CSS_EDGE_OVERFLOW;\n    const hCss = container.clientHeight + CSS_EDGE_OVERFLOW;\n    if (!(wCss > 0 && hCss > 0)) return;\n\n    const dpr = g.DPR || 1;\n    const nextW = Math.max(1, Math.ceil(wCss * dpr));\n    const nextH = Math.max(1, Math.ceil(hCss * dpr));\n    if (canvas.width !== nextW) canvas.width = nextW;\n    if (canvas.height !== nextH) canvas.height = nextH;\n    scheduleDraw();\n  };\n\n  const draw = () => {\n    rafId = 0;\n    pending = false;\n\n    const w = canvas.width;\n    const h = canvas.height;\n    if (!(w > 0 && h > 0)) return;\n\n    ctx.clearRect(0, 0, w, h);\n    drawWalls(ctx, w, h);\n  };\n\n  const scheduleDraw = () => {\n    if (pending) return;\n    pending = true;\n    rafId = window.requestAnimationFrame(draw);\n  };\n\n  // First paint + keep in sync.\n  resize();\n\n  // Resize-driven layout changes.\n  window.addEventListener('resize', resize, { passive: true });\n\n  // Theme changes change --wall-color and thus wall fill.\n  const mo = new MutationObserver(() => scheduleDraw());\n  try {\n    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });\n  } catch (e) {}\n\n  return {\n    canvas,\n    ctx,\n    resize,\n    redraw: scheduleDraw,\n    destroy() {\n      try { window.removeEventListener('resize', resize); } catch (e) {}\n      try { mo.disconnect(); } catch (e) {}\n      try { if (rafId) window.cancelAnimationFrame(rafId); } catch (e) {}\n    },\n  };\n}\n\n"],"names":[],"mappings":"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"}