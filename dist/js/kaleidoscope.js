function t(t,n,a){return Math.max(n,Math.min(a,t))}function n(n){const a=n.canvas;return a?t(Math.min(a.width,a.height)/1e3,.35,3):1}function a(t,n,a,o){for(let r=0;t.length>r;r++){const s=t[r],M=n-s.x,h=a-s.y,c=o+s.r;if(c*c>M*M+h*h)return!0}return!1}function o(t,n,a,o=10){const r=2*o;return t.v+=o*o*(n-t.x)*a,t.v*=Math.max(0,1-r*a),t.x+=t.v*a,t.x}function r(t,n,a,o){const r=f(),s=Math.max(2,r.wallInset||3)*(r.DPR||1),M=s+t.r,h=n-s-t.r,c=s+t.r,e=a-s-t.r,i=.92,u=Math.max(0,1-.15*o);M>t.x?(t.x=M,t.vx=Math.abs(t.vx)*i*u):t.x>h&&(t.x=h,t.vx=-Math.abs(t.vx)*i*u),c>t.y?(t.y=c,t.vy=Math.abs(t.vy)*i*u):t.y>e&&(t.y=e,t.vy=-Math.abs(t.vy)*i*u)}function s(t){return{count:t.kaleidoscope3BallCount??t.kaleidoscopeBallCount??150,wedges:t.kaleidoscope3Wedges??t.kaleidoscopeWedges??10,speed:t.kaleidoscope3Speed??t.kaleidoscopeSpeed??1.2,complexity:1.35,spawnAreaMul:t.kaleidoscope3SpawnAreaMul??t.kaleidoscopeSpawnAreaMul??1.05,sizeVariance:t.kaleidoscope3SizeVariance??t.kaleidoscopeSizeVariance??.5}}function M(){const o=f();((o,r)=>{function M(t){const n=Math.max(0,Math.min(1,t/Math.max(j,1))),a=.55>=n||.75>n&&.65>Math.random()?Y:z,o=a[Math.floor(Math.random()*a.length)]??0;return{color:F[o]||F[0]||"#ffffff",distributionIndex:(t=>{const n=Math.max(0,Math.min(7,0|t));for(let a=0;X.length>a;a++){const t=X[a];if((0|t?.colorIndex)===n)return a}return 0})(o)}}function h(){const n=d(c,r),o=1.2*j,s=p-o,h=p+o,e=v-o,i=v+o;for(let r=0;90>r;r++){const o=Math.random()*m,r=g+Math.random()*(j-g),f=t(p+Math.cos(o)*r,s,h),u=t(v+Math.sin(o)*r,e,i),l=n*(1+(c.ballSpacing||0));if(!a(B,f,u,l)){B.push({x:f,y:u,r:l});const{color:t,distributionIndex:a}=M(r),s=new x(f,u,n,t);s.distributionIndex=a,s.t=Math.random()*m;const h=f-p,e=u-v;s.o=Math.sqrt(h*h+e*e);const i=(12+12*Math.random())*w;return s.vx=-Math.sin(o)*i,s.vy=Math.cos(o)*i,s.driftAx=0,s.driftTime=0,void c.balls.push(s)}}const f=Math.random()*m,u=g+Math.random()*(j-g),l=p+Math.cos(f)*u,y=v+Math.sin(f)*u,{color:A,distributionIndex:I}=M(u),b=new x(l,y,n,A);b.distributionIndex=I,b.t=Math.random()*m;const F=l-p,X=y-v;b.o=Math.sqrt(F*F+X*X);const Y=(12+12*Math.random())*w;b.vx=-Math.sin(f)*Y,b.vy=Math.cos(f)*Y,b.driftAx=0,b.driftTime=0,c.balls.push(b)}const c=f();u();const e=c.canvas;if(!e)return;const i=e.width,l=e.height,p=.5*i,v=.5*l,w=n(c),y=c.maxBalls||300,A=t(Math.max(0,0|o),0,y);if(0>=A)return;const I=t(s(c).spawnAreaMul??1,.2,2),b=Math.min(i,l),g=.05*b,j=2.8*b*I,B=[],F=Array.isArray(c.currentColors)?c.currentColors:[],X=Array.isArray(c.colorDistribution)?c.colorDistribution:[],Y=[5,6,7,3,0],z=[0,1,2,4];for(let t=0;A>t;t++)h()})(p(o.kaleidoscope3BallCount??o.kaleidoscopeBallCount??150),l.KALEIDOSCOPE)}function h(t){return t===l.KALEIDOSCOPE}function c(t){return s(t).complexity}function e(a,o){const r=f();if(!h(r.currentMode))return;const M=r.canvas;if(!M)return;const e=.5*M.width,i=.5*M.height,u=n(r),l=t(s(r).speed??1,.2,2),d=performance.now(),p=120>d-(r.lastPointerMoveMs||0);void 0===r.M&&(r.M=0);const x=p?1:0;r.M+=(x-r.M)*(1-Math.exp(-o/Math.max(1e-4,x>r.M?.45:.65)));const m=r.M,w=c(r),y=r.prefersReducedMotion?0:Math.max(0,r.kaleidoscopeIdleDrift??.012)*w*(1-Math.min(1,.7*m));if(y>0){const t=(a.t??0)+.02*a.age+35e-5*d,n=Math.cos(t)*y*9,r=Math.sin(1.1*t)*y*9;a.vx+=n*o,a.vy+=r*o}const A=a.x-e,I=a.y-i,b=Math.max(v,Math.sqrt(A*A+I*I)),g=A/b,j=I/b,B=g,F=30*u*l*m,X=-2.5*(b-(void 0!==a.o?a.o:b))*l*m;a.vx+=(-j*F+g*X)*o,a.vy+=(B*F+j*X)*o,a.vx*=.992,a.vy*=.992}function i(a){const r=f();if(!h(r.currentMode))return;const M=r.canvas;if(!M)return;const e=(()=>{const n=performance.now(),a=w||n;return w=n,t((n-a)/1e3,0,.05)})(),i=r.balls,u=M.width,l=M.height,d=n(r),p=r.isMobile||r.isMobileViewport?r.kaleidoscope3WedgesMobile??6:s(r).wedges??12,x=t(Math.round(p),3,24),y=!!(r.kaleidoscopeMirror??1),A=(t=>.5*t.width)(M),I=(t=>.5*t.height)(M),b=m/x,g=Math.max(1e-5,1e-4*b),j=r.mouseInCanvas?r.mouseX:A,B=r.mouseInCanvas?r.mouseY:I,F=j-A,X=B-I,Y=Math.atan2(X,F),z=t(Math.hypot(F,X)/Math.max(1,.5*Math.min(u,l)),0,1);r.h||(r.h={phase:{x:0,v:0},panX:{x:0,v:0},panY:{x:0,v:0},lastMouseX:j,lastMouseY:B,lastInCanvas:!!r.mouseInCanvas});const C=r.h,O=!!r.mouseInCanvas,R=Math.hypot(j-C.lastMouseX,B-C.lastMouseY)>.5||O!==C.lastInCanvas,V=t(s(r).speed??1,.2,2),k=c(r),q=.65*V*k,D=F*q*(r.mouseInCanvas?1:0),E=X*q*(r.mouseInCanvas?1:0),G=.7*Y*k*(r.mouseInCanvas?1:0),H=(r.kaleidoscopeIdleSpeed??.08)*k*(r.prefersReducedMotion?0:1);if(R)C.lastMouseX=j,C.lastMouseY=B,C.lastInCanvas=O,o(C.phase,G,e,4.5),o(C.panX,D,e,5),o(C.panY,E,e,5);else{if(H>0){C.phase.x+=H*e;const t=2*Math.PI;C.phase.x>t&&(C.phase.x-=t),-t>C.phase.x&&(C.phase.x+=t)}C.phase.v=0,C.panX.v=0,C.panY.v=0}const J=C.phase.x,K=C.panX.x,L=C.panY.x,N=.22+.18*t((V-.2)/1.8,0,1),P=1-N+2*N*(1-z),Q=new Float32Array(x),S=new Float32Array(x);for(let t=0;x>t;t++){const n=t*b;Q[t]=Math.cos(n),S[t]=Math.sin(n)}for(let n=0;i.length>n;n++){const o=i[n],r=o.x-A+K,s=o.y-I+L,M=3.5*d,h=Math.hypot(r,s)*M*P;if(v>h)continue;const c=y?2*b:b;let e=Math.atan2(s,r)+J;e=(e%c+c)%c,y&&e>b&&(e=c-e),e=t(e,g,b-g);const f=Math.cos(e),u=Math.sin(e);for(let t=0;x>t;t++){const n=Q[t],r=S[t],s=A+(n*f-r*u)*h,M=I+(r*f+n*u)*h;1>o.alpha&&(a.globalAlpha=o.alpha),a.fillStyle=o.color,a.beginPath(),a.arc(s,M,o.r,0,m),a.fill(),1>o.alpha&&(a.globalAlpha=1)}}}import{g as f,al as u,an as l,aR as d,aO as p}from"./shared.js";import{B as x}from"./Ball.js";const m=2*Math.PI,v=1e-6;let w=0;export{r as applyKaleidoscopeBounds,e as applyKaleidoscopeForces,M as initializeKaleidoscope,i as renderKaleidoscope};