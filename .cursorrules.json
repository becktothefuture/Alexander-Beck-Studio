{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Alexander Beck Studio Project Rules",
  "version": "1.0.0",
  "description": "Machine-readable project rules for LLMs and automation tools",
  "metadata": {
    "project": "Alexander Beck Studio Website",
    "lastUpdated": "2025-01-01",
    "format": "cursor-rules-v1"
  },
  "criticalConstraints": [
    {
      "id": "docs-authoritative",
      "rule": "Documentation is authoritative - Code must match documented design",
      "priority": "critical"
    },
    {
      "id": "fps-minimum",
      "rule": "60 FPS minimum - Revert changes that drop performance",
      "priority": "critical",
      "verification": "Press '/' key to show FPS counter"
    },
    {
      "id": "four-modes",
      "rule": "4 modes (not 3) - Ball Pit, Flies, Zero-G, Pulse Grid (keyboard: 1,2,3,4)",
      "priority": "critical",
      "modes": ["pit", "flies", "weightless", "pulse-grid"]
    },
    {
      "id": "edit-source-only",
      "rule": "Edit source/ only - Never edit public/ directly",
      "priority": "critical",
      "editablePaths": ["source/**"],
      "readOnlyPaths": ["public/**"]
    },
    {
      "id": "scoped-styles",
      "rule": "Scoped styles - Everything in #bravia-balls container",
      "priority": "critical"
    },
    {
      "id": "privacy-first",
      "rule": "Privacy-first - No external calls, localStorage for settings only",
      "priority": "critical"
    },
    {
      "id": "o1-hot-paths",
      "rule": "O(1) hot paths - Constant time per entity in loops",
      "priority": "critical"
    },
    {
      "id": "mobile-support",
      "rule": "Mobile support - Test on device emulation, 60% ball scaling",
      "priority": "critical"
    },
    {
      "id": "accessibility",
      "rule": "Accessibility - ARIA labels, keyboard nav, prefers-reduced-motion",
      "priority": "critical"
    }
  ],
  "cssRules": {
    "sizingTokens": {
      "rule": "No raw pixel literals in CSS rules",
      "prefer": ["var(--gap-*)", "var(--text-*)", "var(--size-*)", "vw", "vh", "vmin", "vmax", "clamp()"],
      "exception": {
        "condition": "If an exact pixel value is required to preserve layout",
        "action": "Define it once as a token in :root (in source/css/main.css) and reference it via var()",
        "example": "--gap-24: 24px"
      },
      "tokenLocation": "source/css/main.css :root"
    }
  },
  "fileLocations": {
    "core": {
      "entry": "source/main.js",
      "config": "source/config/default-config.json",
      "styles": "source/css/main.css",
      "html": "source/index.html"
    },
    "modules": {
      "core": "source/modules/core/",
      "physics": "source/modules/physics/",
      "rendering": "source/modules/rendering/",
      "ui": "source/modules/ui/",
      "modes": "source/modules/modes/",
      "input": "source/modules/input/"
    },
    "documentation": {
      "modes": "docs/reference/MODES.md",
      "architecture": "docs/development/ARCHITECTURE.md",
      "configuration": "docs/reference/CONFIGURATION.md",
      "aiGuide": "AI-AGENT-GUIDE.md"
    },
    "build": {
      "output": "public/",
      "bundle": "public/js/bouncy-balls-embed.js",
      "command": "npm run build"
    }
  },
  "searchStrategies": {
    "grep": {
      "useFor": ["exact symbol/function names", "CSS selectors/classes", "config keys", "import paths"],
      "examples": [
        "grep -r \"functionName\" source/",
        "grep -r \"\\.class-name\" source/css/",
        "grep -r \"\\\"key\\\"\" source/config/",
        "grep -r \"from.*module\" source/"
      ]
    },
    "codebase_search": {
      "useFor": ["How does X work?", "Where is Y handled?", "What happens when Z?"],
      "queries": [
        "Understanding behavior",
        "Finding implementation",
        "Tracing execution flow"
      ]
    },
    "read_file": {
      "useFor": ["Reading documentation first", "Understanding file structure", "Checking existing patterns"]
    },
    "searchOrder": {
      "newFeatures": [
        "docs/reference/MODES.md",
        "docs/development/ARCHITECTURE.md",
        "grep for similar implementations in source/modules/",
        "read_file on relevant module files"
      ],
      "bugFixes": [
        "Reproduce issue, note symptoms",
        "grep for related code (error messages, function names)",
        "codebase_search for 'How does X work?'",
        "read_file on relevant files"
      ],
      "cssChanges": [
        "Check source/css/main.css for existing tokens",
        "Use grep to find similar selectors",
        "Follow token system (no raw px)",
        "Test visual appearance matches intent"
      ]
    }
  },
  "workflows": {
    "startup": {
      "command": "npm run startup",
      "rationale": "Preferred entry point for dev/preview/watch to keep health checks and ports consistent.",
      "healthChecks": [
        "Dependencies installed",
        "Source files present",
        "Build output exists"
      ],
      "modes": [
        {
          "name": "Quick Dev",
          "commands": ["npm run start:source"],
          "port": 8001,
          "useWhen": "Rapid iteration, UI tweaks, logic changes"
        },
        {
          "name": "Build Preview",
          "commands": ["npm start"],
          "port": 8000,
          "useWhen": "Production-like preview",
          "autoBuildIfMissing": true
        },
        {
          "name": "Dual Mode",
          "commands": ["npm run start:source", "npm start"],
          "ports": [8001, 8000],
          "useWhen": "Side-by-side comparison"
        },
        {
          "name": "Watch Mode",
          "commands": ["npm run start:source", "npm start", "npm run watch"],
          "ports": [8001, 8000],
          "useWhen": "Auto-rebuild with dev + preview"
        },
        {
          "name": "Build Only",
          "commands": ["npm run build"],
          "useWhen": "Generate production bundle and exit"
        }
      ],
      "fallback": "Use direct commands only for automation or non-interactive runs."
    },
    "beforeChanges": [
      {
        "step": 1,
        "action": "Read relevant docs",
        "files": ["MODES.md", "ARCHITECTURE.md", "CONFIGURATION.md"]
      },
      {
        "step": 2,
        "action": "Search for similar patterns",
        "command": "grep -r \"similarPattern\" source/"
      },
      {
        "step": 3,
        "action": "Understand current implementation",
        "tool": "read_file on relevant files"
      }
    ],
    "afterChanges": [
      {
        "step": 1,
        "action": "Visual test",
        "description": "Open source/index.html in browser, test affected features"
      },
      {
        "step": 2,
        "action": "Performance check",
        "description": "Press '/' to show FPS counter, verify 60 FPS"
      },
      {
        "step": 3,
        "action": "Mode test",
        "description": "Test all 4 modes (keys 1,2,3,4) if physics/rendering changed"
      },
      {
        "step": 4,
        "action": "Build test",
        "command": "npm run build",
        "verify": "no errors"
      },
      {
        "step": 5,
        "action": "Production test",
        "command": "npm start",
        "test": "public/index.html on :8000"
      },
      {
        "step": 6,
        "action": "Lint check",
        "tool": "read_lints on modified files"
      }
    ],
    "performanceVerification": {
      "fpsCounter": "Press '/' key in browser",
      "consoleCheck": "Check console for warnings/errors",
      "stressTest": "Test with 200+ balls (Ball Pit mode)",
      "profiling": "Profile in DevTools Performance tab if FPS drops"
    }
  },
  "patterns": {
    "do": [
      {
        "pattern": "Use existing design tokens",
        "examples": ["var(--gap-lg)", "var(--text-md)", "var(--size-icon)"]
      },
      {
        "pattern": "Follow module structure",
        "example": "source/modules/{category}/{file}.js"
      },
      {
        "pattern": "Use fixed timestep",
        "value": "PHYSICS_DT = 1/120",
        "description": "120Hz physics"
      },
      {
        "pattern": "Use spatial hashing for collisions",
        "complexity": "O(n) not O(n²)"
      },
      {
        "pattern": "Early returns, minimal nesting"
      },
      {
        "pattern": "Descriptive names",
        "good": "updateBallPhysics()",
        "bad": "update()"
      }
    ],
    "dont": [
      {
        "pattern": "Raw pixel values in CSS",
        "alternative": "use tokens or viewport units"
      },
      {
        "pattern": "Edit public/ directly",
        "alternative": "always edit source/"
      },
      {
        "pattern": "Allocate in hot paths",
        "context": "physics/render loops"
      },
      {
        "pattern": "O(n²) collision detection",
        "alternative": "use spatial hash"
      },
      {
        "pattern": "Change physics constants without updating MODES.md"
      },
      {
        "pattern": "Add localStorage for user text",
        "reason": "privacy-first"
      },
      {
        "pattern": "Break 60 FPS requirement"
      }
    ]
  },
  "performanceConstraints": {
    "hotPaths": {
      "physicsLoop": {
        "function": "step()",
        "requirement": "O(1) per ball, no allocations"
      },
      "renderLoop": {
        "function": "draw()",
        "requirement": "Batch operations, minimize canvas state changes"
      },
      "collisionDetection": {
        "requirement": "Use spatial hash, not brute force O(n²)"
      }
    },
    "fpsDropProcedure": [
      "Check ball count (should handle 200+)",
      "Profile with DevTools Performance tab",
      "Look for O(n²) loops or allocations in hot paths",
      "Verify spatial hashing is active",
      "Revert if can't fix quickly"
    ]
  },
  "gitWorkflow": {
    "sync": {
      "afterCommit": "git push origin main",
      "beforeWork": "git pull origin main"
    },
    "commitFormats": {
      "feat": "new features",
      "fix": "bug fixes",
      "refactor": "code changes that neither fix nor add",
      "docs": "documentation only",
      "style": "formatting, no code change",
      "perf": "performance improvements"
    }
  },
  "testingChecklist": [
    "All 4 modes work (1,2,3,4)",
    "60 FPS stable",
    "Mouse/touch works",
    "Panel functional (/)",
    "Mobile responsive",
    "No console errors"
  ],
  "documentationTriggers": [
    "Adding/removing modes",
    "Changing keyboard shortcuts",
    "Modifying build process",
    "Changing file structure",
    "Adding config options",
    "Changing physics behavior"
  ]
}
