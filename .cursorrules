---
version: "1.0.0"
lastUpdated: "2025-01-01"
format: "cursor-rules-v1"
schema: ".cursorrules.json"
---

# Alexander Beck Studio Website - Project Rules

## Documentation as Source of Truth

**CRITICAL PRINCIPLE:** Documentation represents the **intended design**. Before any changes:
1. Read relevant documentation FIRST
2. Align with documented design philosophy (README.md)
3. Match specifications (docs/reference/MODES.md)
4. Follow architecture patterns (docs/development/ARCHITECTURE.md)
5. If code conflicts with docs, fix code to match (or update docs with justification)

## Critical Constraints

1. **Documentation is authoritative** - Code must match documented design
2. **60 FPS minimum** - Revert changes that drop performance
3. **4 modes (not 3)** - Ball Pit, Flies, Zero-G, Pulse Grid (keyboard: 1,2,3,4)
4. **Edit source/ only** - Never edit public/ directly
5. **Scoped styles** - Everything in #bravia-balls container
6. **Privacy-first** - No external calls, localStorage for settings only
7. **O(1) hot paths** - Constant time per entity in loops
8. **Mobile support** - Test on device emulation, 60% ball scaling
9. **Accessibility** - ARIA labels, keyboard nav, prefers-reduced-motion

## Industrial Color System Psychology

Industrial Teal is the anchor “vibe” for this project’s color language. Any new palettes/variants must preserve the same underlying psychology:

- Sophisticated and technical (muted saturation, not bright)
- Professional and trustworthy
- Modern industrial aesthetic
- Balanced between cool and natural
- Corporate, chill, understated
- Subtle anime-inspired clarity (clean silhouettes, luminous restraint)
- Grounded in modern Bauhaus (functional, geometric, minimal)

If additional palettes are introduced, they should feel like different “chapters” of the same industrial story (multifaceted, interesting, sometimes more saturated or more poppy), while still aligning to the core psychological profile above.

## CSS Sizing & Spacing Tokens (Project Rule)

1. **No raw pixel literals in CSS rules**: prefer design tokens (e.g. `var(--gap-*)`, `var(--text-*)`, `var(--size-*)`) or viewport units (`vw/vh/vmin/vmax`, `clamp()`).
2. **If an exact pixel value is required** to preserve layout, define it once as a token in `:root` (in `source/css/main.css`) and reference it via `var()`.
3. **Keep the site looking identical** when tokenizing: use fixed tokens (e.g. `--gap-24: 24px`) when a responsive clamp would change computed values.

## Files

**EDIT:** source/balls-source.html, source/current-config.json  
**NEVER EDIT:** public/ (generated)  
**BUILD:** npm run build → public/js/bouncy-balls-embed.js

## Startup Workflow (Preferred)

**Primary command:** `npm run startup` (interactive menu + health checks)

**Process:**
1. Run `npm run startup` to verify dependencies, source files, and build output.
2. Choose the mode that matches the task:
   - **Quick Dev** → `npm run start:source` (port 8001, instant reload)
   - **Build Preview** → `npm start` (port 8000, production bundle)
   - **Dual Mode** → both 8001 + 8000 for side-by-side comparison
   - **Watch Mode** → dev + build + `npm run watch` for auto-rebuilds
   - **Build Only** → `npm run build` and exit
3. Use direct commands only for automation or non-interactive runs; otherwise prefer `npm run startup` for consistency.

## Documentation Updates Required When:
- Adding/removing modes
- Changing keyboard shortcuts
- Modifying build process
- Changing file structure
- Adding config options
- Changing physics behavior

## Testing Checklist
- [ ] All 4 modes work (1,2,3,4)
- [ ] 60 FPS stable
- [ ] Mouse/touch works
- [ ] Panel functional (/)
- [ ] Mobile responsive
- [ ] No console errors

## Git Workflow

**Keep local and remote in sync:**
1. After committing changes, always push to origin/main
2. Before starting work, pull latest changes from origin
3. Use descriptive commit messages with conventional commits format:
   - `feat:` new features
   - `fix:` bug fixes
   - `refactor:` code changes that neither fix nor add
   - `docs:` documentation only
   - `style:` formatting, no code change
   - `perf:` performance improvements

**After committing:**
```bash
git push origin main
```

**Before starting new work:**
```bash
git pull origin main
```

## File Location Quick Reference

**Core Files:**
- `source/main.js` - Entry point, mode switching
- `source/modules/core/` - Constants, state management
- `source/modules/physics/` - Ball class, collision detection
- `source/modules/rendering/` - Canvas, theme, dark mode
- `source/modules/ui/` - Panel, keyboard, controls
- `source/modules/modes/` - Mode implementations (pit, flies, weightless, pulse-grid)
- `source/css/main.css` - All styles, design tokens in `:root`
- `source/config/default-config.json` - Runtime defaults

**Documentation:**
- `docs/reference/MODES.md` - Physics specs (authoritative)
- `docs/development/ARCHITECTURE.md` - Code structure patterns
- `docs/reference/CONFIGURATION.md` - Config parameter definitions
- `AI-AGENT-GUIDE.md` - Quick reference for AI agents

## Efficient Search Strategies

**Use `grep` for:**
- Exact symbol/function names: `grep -r "functionName" source/`
- CSS selectors/classes: `grep -r "\.class-name" source/css/`
- Config keys: `grep -r "\"key\"" source/config/`
- Import paths: `grep -r "from.*module" source/`

**Use `codebase_search` for:**
- "How does X work?" - Understanding behavior
- "Where is Y handled?" - Finding implementation
- "What happens when Z?" - Tracing execution flow

**Use `read_file` for:**
- Reading documentation first (before changes)
- Understanding file structure
- Checking existing patterns before adding similar code

**Search order for new features:**
1. `docs/reference/MODES.md` - Check if mode/behavior is documented
2. `docs/development/ARCHITECTURE.md` - Find similar patterns
3. `grep` for similar implementations in `source/modules/`
4. `read_file` on relevant module files

## Change Verification Workflow

**Before making changes:**
1. Read relevant docs (MODES.md, ARCHITECTURE.md, CONFIGURATION.md)
2. Search for similar patterns: `grep -r "similarPattern" source/`
3. Understand current implementation: `read_file` on relevant files

**After making changes:**
1. **Visual test**: Open `source/index.html` in browser, test affected features
2. **Performance check**: Press `/` to show FPS counter, verify 60 FPS
3. **Mode test**: Test all 4 modes (keys 1,2,3,4) if physics/rendering changed
4. **Build test**: Run `npm run build`, verify no errors
5. **Production test**: `npm start`, test `public/index.html` on :8000
6. **Lint check**: Run `read_lints` on modified files

**Performance verification:**
- FPS counter: Press `/` key in browser
- Check console for warnings/errors
- Test with 200+ balls (Ball Pit mode)
- Profile in DevTools Performance tab if FPS drops

## Common Patterns & Anti-Patterns

**✅ DO:**
- Use existing design tokens: `var(--gap-lg)`, `var(--text-md)`, `var(--size-icon)`
- Follow module structure: `source/modules/{category}/{file}.js`
- Use fixed timestep: `PHYSICS_DT = 1/120` (120Hz physics)
- Use spatial hashing for collisions (O(n) not O(n²))
- Early returns, minimal nesting
- Descriptive names: `updateBallPhysics()` not `update()`

**❌ DON'T:**
- Raw pixel values in CSS (use tokens or viewport units)
- Edit `public/` directly (always edit `source/`)
- Allocate in hot paths (physics/render loops)
- O(n²) collision detection (use spatial hash)
- Change physics constants without updating MODES.md
- Add localStorage for user text (privacy-first)
- Break 60 FPS requirement

## Performance Constraints

**Hot path rules:**
- Physics loop (`step()`): O(1) per ball, no allocations
- Render loop (`draw()`): Batch operations, minimize canvas state changes
- Collision detection: Use spatial hash, not brute force O(n²)

**If FPS drops:**
1. Check ball count (should handle 200+)
2. Profile with DevTools Performance tab
3. Look for O(n²) loops or allocations in hot paths
4. Verify spatial hashing is active
5. Revert if can't fix quickly

## Context Gathering Order

**For new features:**
1. `docs/reference/MODES.md` - Understand physics/behavior specs
2. `docs/development/ARCHITECTURE.md` - Find similar patterns
3. `grep` for similar code in `source/modules/`
4. `read_file` on 2-3 similar module files
5. Implement following existing patterns

**For bug fixes:**
1. Reproduce issue, note symptoms
2. `grep` for related code (error messages, function names)
3. `codebase_search` for "How does X work?"
4. `read_file` on relevant files
5. Fix following existing patterns

**For CSS changes:**
1. Check `source/css/main.css` for existing tokens
2. Use `grep` to find similar selectors
3. Follow token system (no raw px)
4. Test visual appearance matches intent

## Config Panel Design System

**Standard panel styling pattern for all configuration panels:**

### Visual Structure
1. **Orange Top Border** (4px): `border-top: 4px solid var(--panel-brand);` - Serves as visual anchor and drag handle
2. **No Header**: Header is hidden (`display: none`) to save vertical space
3. **Category Grouping**: Logical sections grouped with:
   - **Category Labels**: Small uppercase labels (9px, letter-spacing 0.1em, muted color)
   - **Separator Lines**: Light top border (1px solid var(--panel-border), opacity 0.6)
   - **Padding**: `margin-top: var(--panel-pad-8)`, `padding-top: var(--panel-pad-6)` between groups
4. **Compact Spacing**: 
   - Section padding: `var(--panel-section-pad: 7px)`
   - Section gap: `var(--panel-section-gap: 4px)`
   - Control gap: `var(--panel-control-gap: 2px)`

### Category Group Implementation
- Define `SECTION_CATEGORIES` mapping section keys to category names
- Use `.panel-category-group` wrapper div around related sections
- Category label uses `.panel-category-label` class
- First category has no top border/padding

### Panel Dimensions
- **Width**: `23rem (368px)` default
- **Height**: `80vh` default
- **Max-height**: Respects viewport minus safe area insets
- **Min-width**: `280px`

### Theme Toggle
- Compact horizontal layout: `padding: 2px`, `gap: 2px`
- Small buttons: `padding: 3px 6px`, `font-size: 10px`
- Fits on single line: `white-space: nowrap`

### CSS Classes Reference
- `.panel-category-group` - Wrapper for grouped sections with separator
- `.panel-category-label` - Uppercase category title (9px, muted)
- `.panel-section-accordion` - Collapsible section container
- `.panel-section-header` - Section header (hidden in this design)
- `.panel-section-content` - Section content area
- `.theme-segment-control` - Theme toggle container
- `.theme-segment-btn` - Individual theme button

### JavaScript Integration
- Sections generated via `generateMasterSectionsHTML()` 
- Category grouping handled in generation logic
- Only restore saved panel size if significantly different (>5px) from CSS defaults
- Dragging works from top 12px area (orange border zone)

**When creating new config panels, follow this exact pattern for consistency.**

See AI-AGENT-GUIDE.md and docs/ for complete rules.
